var Dpr=Dpr||{};!function(){function loadLibrary(){eval(loadScript("INCLUDES_DPR_LIBRARY")),Dpr.init(!0)}function loadScript(e){return e=e.toUpperCase(),aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.EMSEBusiness").getOutput().getScriptByPK(aa.getServiceProviderCode(),e,"ADMIN").getScriptText()+""}function getProjectType(e){var t=aa.cap.getCap(e).getOutput().getCapType().toString()+"",e=aa.bizDomain.getBizDomainByValue("DPR_RECORD_TYPES_ENABLED",t);if(e.getSuccess()){e=e.getOutput();return"A"==e.getAuditStatus()+""?{id:t,raw:e.getDescription()}:null}return null}function isProject(e){return null!==getProjectType(e)}function fireAction(e){function t(e){var t=aa.env.getValue("CurrentUserID")+"";if(!t)return Dpr.error("No user for transaction."),null;var a,r,s,n,u,i,s=(n=aa.env.getValue("PermitId1"),u=aa.env.getValue("PermitId2"),i=aa.env.getValue("PermitId3"),n&&u&&i&&(u+="",i+="",(n+="").length&&u.length&&i.length&&((s=aa.cap.getCapID(n,u,i)).getSuccess()?g=s.getOutput():Dpr.error("capId not found: "+s.getErrorMessage()))),g||(a=aa.env.getValue("CapId"))&&(a+="").length&&(r=a.split("-"),(s=aa.cap.getCapID(r[0],r[1],r[2])).getSuccess()?g=s.getOutput():Dpr.error("capId not found: "+s.getErrorMessage())),g||(a=aa.env.getValue("CapID"))&&(a+="").length&&(r=a.split("-"),(s=aa.cap.getCapID(r[0],r[1],r[2])).getSuccess()?g=s.getOutput():Dpr.error("capId not found: "+s.getErrorMessage())),g||((s=aa.env.getValue("CapIdModel"))&&""!=s?g=s:Dpr.error("capId not found")),g);if(s){var g=getProjectType(s);if(g){g={user:t,capId:s,rawType:g};return e&&(e.taskName&&(g.taskName=e.taskName),e.taskStatus&&(g.taskStatus=e.taskStatus)),g}return null}return{user:t}}try{var a=aa.env.getValue("EventName")+"";if("V360InspectionResultSubmitAfter"==a)for(var r=aa.env.getValue("PermitId1Array"),s=aa.env.getValue("PermitId2Array"),n=aa.env.getValue("PermitId3Array"),u=aa.env.getValue("InspectionTypeArray"),i=aa.env.getValue("InspectionResultArray"),g=aa.env.getValue("InspectionIdArray"),p=0;p<r.length;p++){var o,c=aa.cap.getCapID(r[p],s[p],n[p]);c.getSuccess()&&(o=c.getOutput(),aa.env.setValue("PermitId1",o.getID1()),aa.env.setValue("PermitId2",o.getID2()),aa.env.setValue("PermitId3",o.getID3()),aa.env.setValue("InspectionId",g[p]),aa.env.setValue("InspectionType",u[p]),aa.env.setValue("InspectionResult",i[p]),(l=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(l)))}else if("ApplicationDeleteBefore"==a)for(var d=aa.env.getValue("CapIDList").toArray(),p=0;p<d.length;p++){var l,I=(d[p]+"").split("-");aa.env.setValue("PermitId1",I[0]),aa.env.setValue("PermitId2",I[1]),aa.env.setValue("PermitId3",I[2]),(l=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(l))}else(l=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(l))}catch(e){Dpr.error("Fire action failed: "+e.message+(e.stack?"\nStack: "+e.stack:""))}}Dpr.error=function(e){aa.debug("DPR",e)},Dpr.loadScript=loadScript,Dpr.isProject=isProject,Dpr.load=loadLibrary,Dpr.fireAction=fireAction}(),Dpr.Api={},Dpr.Api.notify=function(){function g(e){aa.env.setValue("InterfaceReturnCode","1"),aa.env.setValue("InterfaceReturnMessage",e)}function e(e){var t,a,r,s,n,u=aa.env.getValue("recordId")+"";u&&0!==u.length?(s=aa.env.getValue("userId")+"")&&0!==s.length?(t=u.split("-"),(r=aa.cap.getCapID(t[1],t[2],t[3])).getSuccess()?(n=(a=aa.env.getValue("items"))?JSON.parse(a):n)&&0!==n.length?(u=r.getOutput(),a=(t=aa.cap.getCap(u).getOutput()).getCapModel().getModuleName()+"",r=t.getCapType().toString()+"",s={capId:u,cap:t,module:a,capType:r,user:s,documents:n},(n=aa.env.getValue("template"))&&(s.template=n+""),e?Dpr.Actions.onPrintSetStart(s):Dpr.Actions.onPrintSetComplete(s)):g("Bad request, missing documents info"):g("Bad request, Error retrieving capId")):g("Bad request, missing userId"):g("Bad request, missing recordId")}function t(){var e,t,a,r,s,n,u,i=aa.env.getValue("recordId")+"";i&&0!==i.length?(e=aa.env.getValue("userId")+"")&&0!==e.length?(t=aa.env.getValue("task"))?(t=JSON.parse(t),n=i.split("-"),(u=aa.cap.getCapID(n[1],n[2],n[3])).getSuccess()?(a=u.getOutput(),s=(r=aa.cap.getCap(a).getOutput()).getCapModel().getModuleName()+"",i=r.getCapType().toString()+"",n=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",i),u=Dpr.Actions.getConfig(),n={user:e,capId:a,cap:r,module:s,capType:i,workflowTask:t,projectType:n,process:n.process&&u.processes[n.process]?u.processes[n.process]:u.processes.default},Dpr.Actions.taskUpdateValidate(n),n.cancel?(u=n.newStatus.message,aa.env.setValue("Data",JSON.stringify({message:u}))):Dpr.Actions.taskUpdate(n)):g("Bad request, Error retrieving capId")):g("Bad request, missing task"):g("Bad request, missing userId"):g("Bad request, missing recordId")}try{var a=aa.env.getValue("notificationId")+"";if(a&&0!==a.length)switch(Dpr.Actions||Dpr.load(),aa.env.setValue("InterfaceReturnCode","0"),aa.env.setValue("InterfaceReturnMessage","Success"),a){case"DPR_FILE_PROCESSING_COMPLETE":(z=aa.env.getValue("recordId")+"")&&0!==z.length?(j=aa.env.getValue("userId")+"")&&0!==j.length&&(w=aa.env.getValue("submittalId")+"")&&0!==w.length?(J=z.split("-"),(Y=aa.cap.getCapID(J[1],J[2],J[3])).getSuccess()?(x=Y.getOutput(),J=(z=aa.cap.getCap(x).getOutput()).getCapModel().getModuleName()+"",Y=z.getCapType().toString()+"",Dpr.Actions.onFileProcessingComplete({capId:x,cap:z,module:J,capType:Y,user:j,submittalId:w})):g("Bad request, Error retrieving capId")):g("Bad request, missing userId"):g("Bad request, missing recordId");break;case"DPR_EXCEPTION":(F=aa.env.getValue("recordId")+"")&&0!==F.length?(k=aa.env.getValue("errorCode")+"",b=aa.env.getValue("errorMessage")+"",k&&b&&0!==k.length&&0!==b.length?(L=F.split("-"),(U=aa.cap.getCapID(L[1],L[2],L[3])).getSuccess()?((N=aa.env.getValue("submittal")+"")&&0!==N.length||(N=null),_=U.getOutput(),L=(F=aa.cap.getCap(_).getOutput()).getCapModel().getModuleName()+"",U=F.getCapType().toString()+"",Dpr.Actions.onException({capId:_,cap:F,module:L,capType:U,errorCode:k,errorMessage:b,submittalId:N})):g("Bad request, Error retrieving capId")):g("Bad request, missing error info")):g("Bad request, missing recordId");break;case"DPR_ALERT":(O=aa.env.getValue("recordId")+"")&&0!==O.length?(B=aa.env.getValue("userId")+"")&&0!==B.length?(T=aa.env.getValue("errorCode")+"",E=aa.env.getValue("errorMessage")+"",T&&E&&0!==T.length&&0!==E.length?(R=O.split("-"),(M=aa.cap.getCapID(R[1],R[2],R[3])).getSuccess()?(q=M.getOutput(),R=(O=aa.cap.getCap(q).getOutput()).getCapModel().getModuleName()+"",M=O.getCapType().toString()+"",Dpr.Actions.onAlert({capId:q,cap:O,module:R,capType:M,user:B,errorCode:T,errorMessage:E})):g("Bad request, Error retrieving capId")):g("Bad request, missing error info")):g("Bad request, missing userId"):g("Bad request, missing recordId");break;case"DPR_REQUEST":(h=aa.env.getValue("recordId")+"")&&0!==h.length?(C=aa.env.getValue("requestCode"),S=aa.env.getValue("requestMessage"),C&&S&&0!==C.length&&0!==S.length?(f=aa.env.getValue("userId")+"")&&0!==f.length?(y=h.split("-"),(P=aa.cap.getCapID(y[1],y[2],y[3])).getSuccess()?(A=P.getOutput(),y=(h=aa.cap.getCap(A).getOutput()).getCapModel().getModuleName()+"",P=h.getCapType().toString()+"",Dpr.Actions.onRequest({capId:A,cap:h,module:y,capType:P,requestCode:C,requestMessage:S,user:f})):g("Bad request, Error retrieving capId")):g("Bad request, missing userId"):g("Bad request, missing request info")):g("Bad request, missing recordId");break;case"DPR_PRINT_SET_START":e(!0);break;case"DPR_PRINT_SET_COMPLETE":e();break;case"DPR_FILES":(V=aa.env.getValue("recordId")+"")&&0!==V.length?(d=aa.env.getValue("userId")+"")&&0!==d.length?((l={}).id=aa.env.getValue("docId")+"",l.type=aa.env.getValue("docType")+"",l.id&&0!==l.id.length?(m=V.split("-"),(D=aa.cap.getCapID(m[1],m[2],m[3])).getSuccess()?(I=D.getOutput(),V=(v=aa.cap.getCap(I).getOutput()).getCapModel().getModuleName()+"",m=v.getCapType().toString()+"",(D=Dpr.getDocumentsFromFiles(Dpr.getAdminUser(),I,l.id))&&0<D.length?(l.id=D[0].location.split("aa:/")[1],V={userId:d,capId:I,cap:v,module:V,capType:m,document:l},(m=aa.env.getValue("submittal")+"")||0<m.length||((D=Dpr.getProjectFile(Dpr.getAdminUser(),I,aa.env.getValue("docId")+""))?-1!==d.indexOf("PUBLICUSER")&&Dpr.Actions.onAttachmentUploaded(V):Dpr.Actions.onPrintSetArchive(V))):g("Bad request, Document id for file "+l.id+" not found")):g("Bad request, Error retrieving capId")):g("Bad request, missing attachment info")):g("Bad request, missing userId"):g("Bad request, missing recordId");break;case"DPR_SUBMITTAL":(c=aa.env.getValue("recordId")+"")&&0!==c.length?(r=aa.env.getValue("userId")+"")&&0!==r.length?(s=aa.env.getValue("submittalId")+"")&&0!==s.length?(p=aa.env.getValue("type")+"")&&0!==p.length?(o=aa.env.getValue("ready")+"")&&0!==o.length?(u=c.split("-"),(i=aa.cap.getCapID(u[1],u[2],u[3])).getSuccess()?(n=i.getOutput(),u=(c=aa.cap.getCap(n).getOutput()).getCapModel().getModuleName()+"",i=c.getCapType().toString()+"",p={user:r,capId:n,cap:c,module:u,capType:i,submittalId:s,type:p,ready:o},(o=aa.env.getValue("recipient")+"").length&&(p.recipient=o),Dpr.Actions.onSubmittalNotification(p)):g("Bad request, Error retrieving capId")):g("Bad request, missing ready"):g("Bad request, missing type"):g("Bad request, missing submittalId"):g("Bad request, missing userId"):g("Bad request, missing recordId");break;case"DPR_TASKUPDATE":t();break;default:g("Bad request, notificationId does not exist")}else g("Bad request, missing notificationId")}catch(e){Dpr.error("API failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:"")),g(e.message)}var r,s,n,u,i,p,o,c,d,l,I,v,m,D,V,C,S,f,A,y,P,h,B,T,E,q,R,M,O,k,b,N,_,L,U,F,j,w,x,J,Y,z},Dpr.Api.notify();