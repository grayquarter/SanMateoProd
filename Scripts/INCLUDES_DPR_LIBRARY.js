DPR_VERSION="2.3",function(){var t,r=0;function o(e){for(var t={},r=e.split(";"),o=0;o<r.length;o++){var s=r[o].split("=");t[s[0]]=s[1]}return t}function s(e,t){t=aa.bizDomain.getBizDomainByValue(e,t);if(t.getSuccess()){t=t.getOutput();return"A"==t.getAuditStatus()+""?t.getDescription()+"":null}return null}function a(e,t){t=s(e,t);return t&&t.length?o(t):null}function n(e){if("string"==typeof e){var t=new Date(String(e));if(!t.toString().equals("Invalid Date"))return t}if("object"==typeof e){if(!e.getClass)return e;if(e.getClass().toString().equals("class com.accela.aa.emse.dom.ScriptDateTime"))return new Date(e.getMonth()+"/"+e.getDayOfMonth()+"/"+e.getYear());if(e.getClass().toString().equals("class com.accela.aa.emse.util.ScriptDateTime"))return new Date(e.getMonth()+"/"+e.getDayOfMonth()+"/"+e.getYear());if(e.getClass().toString().equals("class java.util.Date"))return new Date(e.getTime());if(e.getClass().toString().equals("class java.lang.String"))return new Date(String(e));if(e.getClass().toString().equals("class java.sql.Timestamp"))return new Date(e.getMonth()+"/"+e.getDate()+"/"+e.getYear())}return"number"==typeof e?new Date(e):(Dpr.log("Cannot parse date : "+e),null)}function i(e,t){var r=[],o=e.split("/");4!==o.length&&Dpr.log("The following cap type parameter is incorrectly formatted: "+e);t=aa.cap.getChildByMasterID(t);if(!t.getSuccess())return Dpr.log("getChildren returned an error: "+t.getErrorMessage()),null;for(var s=t.getOutput(),a=0;a<s.length;a++){for(var n=s[a].getCapID(),i=aa.cap.getCap(n).getOutput().getCapType().toString().split("/"),p=!0,c=0;c<i.length;c++)o[c].equals(i[c])||o[c].equals("*")||(p=!1);p&&r.push(n)}return Dpr.log("getChildren returned "+r.length+" capIds"),r}function p(e,t,r){e=aa.workflow.getTaskItems(e,t,"",null,null,null);if(e.getSuccess()){var o,s=e.getOutput();for(o in s){var a=s[o];if(a.getTaskDescription().toUpperCase().equals(t.toUpperCase()))return a}}else Dpr.log("Failed to get workflow object: "+e.getErrorMessage());return null}Dpr.addAdHocTask=function(e,t,r,o,s){(o=aa.person.getUser(o)).getSuccess()?((s=aa.workflow.getTasks(s).getOutput()[0].getTaskItem()).setProcessCode(e),s.setTaskDescription(t),s.setDispositionNote(r),s.setProcessID(0),s.setAssignmentDate(aa.util.now()),s.setDueDate(aa.util.now()),s.setAssignedUser(o.getOutput()),aa.proxyInvoker.newInstance("com.accela.aa.workflow.workflow.WorkflowBusiness").getOutput().createAdHocTaskItem(s)||Dpr.error("Unable to create AdHocTask")):Dpr.error("Could not find user to assign to in addAdHocTask")},Dpr.addCustomList=function(e,t,r,o,s){var a=aa.appSpecificTableScript.getAppSpecificTableModel(e,r);if(!a.getSuccess())return Dpr.error("**WARNING: error retrieving app specific table "+r+" "+a.getErrorMessage()),!1;var n,i=a.getOutput().getAppSpecificTableModel(),p=i.getTableField(),c=i.getReadonlyField();for(n in o){for(var u=i.getColumns().iterator();u.hasNext();){var d=u.next();o[n][d.getColumnName()]||(Dpr.log("addToASITable: null or undefined value supplied for column "+d.getColumnName()+", setting to empty string"),o[n][d.getColumnName()]=""),void 0!==o[n][d.getColumnName()].fieldValue?(p.add(o[n][d.getColumnName()].fieldValue),c.add(o[n][d.getColumnName()].readOnly)):(p.add(o[n][d.getColumnName()]),c.add(s))}i.setTableField(p),i.setReadonlyField(c)}return(t=aa.appSpecificTableScript.editAppSpecificTableInfos(i,e,t)).getSuccess()?void 0:(Dpr.log("**WARNING: error adding record to Custom List:  "+r+" "+t.getErrorMessage()),!1)},Dpr.addParent=function(e,t){return aa.cap.createAppHierarchy(t,e).getSuccess()},Dpr.assignTaskItem=function(e,t){e?(t=aa.person.getUser(t)).getSuccess()?(e.setAssignedUser(t.getOutput()),e=e.getTaskItem(),aa.workflow.assignTask(e)):Dpr.error("Could not find user to assign to in addAdHocTask"):Dpr.log("Unable to update task, no task provided")},Dpr.assignDepartmentTaskItem=function(e,t){var r;e?((r=aa.people.getSysUserModel()).setDeptOfUser(t),e.setAssignedUser(r),e=e.getTaskItem(),(e=aa.workflow.assignTask(e)).getSuccess()||Dpr.error("Error updating wfTask : "+e.getErrorMessage())):Dpr.log("Unable to update task, no task provided")},Dpr.capTypeMatch=function(e,t){var r=e.split("/"),o=t.split("/");if(4!==r.length||4!==o.length)return Dpr.error("Invalid match strings: "+e+"--"+t),!1;for(var s=0;s<o.length;s++)if(o[s].toUpperCase()!==r[s].toUpperCase()&&"*"!==o[s])return!1;return!0},Dpr.clearLastError=function(){t=void 0},Dpr.convertDate=n,Dpr.copyAddresses=function(e,t){var r,o,s=!1,a=aa.address.getAddressByCapId(t);if(!a.getSuccess())return Dpr.log("Failed to get addresses: "+a.getErrorMessage()),0;for(o in r=a.getOutput())if(r[o].getPrimaryFlag().equals("Y")){s=!0,Dpr.log("Target CAP has primary address");break}var n=0;if((a=aa.address.getAddressWithAttributeByCapId(e)).getSuccess())for(var i in r=a.getOutput())newAddress=r[i],newAddress.setCapID(t),s&&newAddress.setPrimaryFlag("N"),aa.address.createAddressWithAPOAttribute(t,newAddress),Dpr.log("Copied address from "+e.getCustomID()+" to "+t.getCustomID()),n++;else Dpr.log("Failed to get addresses: "+a.getErrorMessage());return n},Dpr.copyContacts=function(e,t){var r=aa.people.getCapContactByCapID(e),o=0;if(r.getSuccess()){var s,a=r.getOutput();for(s in a){var n=a[s].getCapContactModel(),i=aa.address.getContactAddressListByCapContact(n);i.getSuccess()&&(i=function(e){var t=null;if(e&&0<e.length)for(var r in t=aa.util.newArrayList(),e)t.add(e[r].getContactAddressModel());return t}(i.getOutput()),n.getPeople().setContactAddressList(i)),n.setCapID(t),aa.people.createCapContactWithAttribute(n),o++,Dpr.log("Copied contact from "+e.getCustomID()+" to "+t.getCustomID())}}else Dpr.log("Failed to get contacts: "+r.getErrorMessage());return o},Dpr.copyLicensedProf=function(e,t){var r=aa.licenseProfessional.getLicensedProfessionalsByCapID(e).getOutput();if(r)for(var o in r)r[o].setCapID(t),aa.licenseProfessional.createLicensedProfessional(r[o]),Dpr.log("Copied "+r[o].getLicenseNbr());else Dpr.log("No licensed professional on source")},Dpr.copyOwner=function(e,t){if((e=aa.owner.getOwnerByCapId(e)).getSuccess()){var r,o=e.getOutput();for(r in o)o[r].setCapID(t),aa.owner.createCapOwnerWithAPOAttribute(o[r]),Dpr.log("Copied Owner: "+o[r].getOwnerFullName())}else Dpr.log("Error Copying Owner : "+e.getErrorType()+" : "+e.getErrorMessage())},Dpr.copyParcels=function(e,t){var r=aa.parcel.getParcelandAttribute(e,null),o=0;if(!r.getSuccess())return Dpr.log("Failed to get parcels: "+r.getErrorMessage()),!1;var s,a=r.getOutput().toArray();for(s in a){var n=aa.parcel.getCapParcelModel().getOutput();n.setParcelModel(a[s]),n.setCapIDModel(t),n.setL1ParcelNo(a[s].getParcelNumber()),n.setParcelNo(a[s].getParcelNumber()),aa.parcel.createCapParcelWithAPOAttribute(n),Dpr.log("Copied parcel "+a[s].getParcelNumber()+" from "+e.getCustomID()+" to "+t.getCustomID()),o++}return o},Dpr.dateAdd=function(e,t){var r=3===arguments.length?!0:!1,o=e?n(e):new Date,s=0;if(r)for(;s<Math.abs(t);)o=0<t?new Date(aa.calendar.getNextWorkDay(aa.date.parseDate(o.getMonth()+1+"/"+o.getDate()+"/"+o.getFullYear())).getOutput().getTime()):new Date(aa.calendar.getPreviousWorkDay(aa.date.parseDate(o.getMonth()+1+"/"+o.getDate()+"/"+o.getFullYear())).getOutput().getTime()),s++;else o.setDate(o.getDate()+parseInt(t,10));return o.getMonth()+1+"/"+o.getDate()+"/"+o.getFullYear()},Dpr.deactivateTask=function(e,t){var r;(r=p(e,t))?(r=r,aa.workflow.adjustTask(e,r.getStepNumber(),"N",r.getCompleteFlag(),null,null)):Dpr.log(t+" was not found, unable to deactivate")},Dpr.editAppName=function(e,t){if((t=aa.cap.getCap(t)).getSuccess()){t=t.getOutput().getCapModel();t.setSpecialText(e);t=aa.cap.editCapByPK(t);if(!t.getSuccess())throw new Error("error setting cap name : "+t.getErrorMessage())}},Dpr.editTaskDueDate=function(e,t){e?(e.setDueDate(aa.date.parseDate(t)),e=e.getTaskItem(),aa.workflow.adjustTaskWithNoAudit(e)):Dpr.log("Unable to update task, no task provided")},Dpr.error=function(e){aa.log("DPR - "+e)},Dpr.getChildren=i,Dpr.getContacts=function(e){var t=[];if((e=aa.people.getCapContactByCapID(e)).getSuccess())for(var r=e.getOutput(),o=0;o<r.length;o++){var s=r[o].getPeople(),s={email:s.email?s.email+"":"",type:s.contactType+"",fullName:s.fullName?s.fullName+"":(s.getFirstName()?s.getFirstName():"")+" "+(s.getLastName()?s.getLastName():""),isPrimary:s.flag+""=="Y",contact:s};t.push(s)}return t},Dpr.getCustomField=function(e,t){if(t&&0<t.length){e=aa.appSpecificInfo.getByCapID(e);if(e.getSuccess()){for(var r=e.getOutput(),o=0;o<r.length;o++)if(r[o].getCheckboxDesc()+""===t)return r[o].getChecklistComment()?r[o].getChecklistComment()+"":r[o].getChecklistComment()}else Dpr.log("Error getting custom fields: "+e.getErrorMessage())}},Dpr.getCustomFields=function(e,t){var r=[];if((e=aa.appSpecificInfo.getByCapID(e)).getSuccess())for(var o,s,a=e.getOutput(),n=0;n<a.length;n++)(t&&Dpr.matches(a[n].getCheckboxDesc()+"",t)||!t)&&(o=a[n].getCheckboxDesc()+"",s=a[n].getChecklistComment()?a[n].getChecklistComment()+"":a[n].getChecklistComment(),r.push({name:o,value:s}));else Dpr.log("Error getting custom fields: "+e.getErrorMessage());return r},Dpr.setCustomField=function(e,t,r){var o;t&&0<t.length&&r&&0<r.toString().length&&((o=aa.appSpecificInfo.editSingleAppSpecific(e,t,r,null)).getSuccess()||Dpr.log("Failed to update "+t+" to a value of "+r+" for record "+e.getCustomID()+": "+o.getErrorMessage()))},Dpr.getTaskCustomFieldItem=function(e,t){if(e&&t&&0<t.length){var r=e.getStepNumber(),o=e.getProcessID(),o=aa.taskSpecificInfo.getTaskSpecifiInfoByDesc(e.getCapID(),o,r,t);if(o.getSuccess()){r=o.getOutput();if(r)return r.getChecklistComment()?r.getChecklistComment()+"":r.getChecklistComment();Dpr.log("No task custom field called "+t+" found for task "+e.getTaskDescription())}else Dpr.log("Unable to get task custom fields for "+e.getTaskDescription()+": "+o.getErrorMessage())}},Dpr.setTaskCustomFieldItem=function(e,t,r){var o,s,a;e&&t&&0<t.length&&r&&0<r.toString().length&&(a=e.getStepNumber(),s=e.getProcessID(),(o=aa.taskSpecificInfo.getTaskSpecifiInfoByDesc(e.getCapID(),s,a,t)).getSuccess()?(s=o.getOutput())?(a=[],taskCustomFieldModel=s.getTaskSpecificInfoModel(),taskCustomFieldModel.setChecklistComment(r),a.push(taskCustomFieldModel),taskCustomFieldUpdateResult=aa.taskSpecificInfo.editTaskSpecInfos(a),taskCustomFieldUpdateResult.getSuccess()||Dpr.error("Failed to update task custom field: "+taskCustomFieldUpdateResult.getErrorMessage())):Dpr.error("No task custom field called "+t+" found for task "+e.getTaskDescription()):Dpr.error("Unable to get task custom fields for "+e.getTaskDescription()+": "+o.getErrorMessage()))},Dpr.getLastError=function(){return t},Dpr.getNextRevisionNumber=function(e,t,r){for(var o=i(t,r),s=0,a=0;a<o.length;a++){var n=aa.cap.getCap(o[a]);!n.getSuccess()||(n=n.getOutput()).getCapClass().equals("COMPLETE")&&!n.getCapID().toString().equals(e.toString())&&-1<o[a].getCustomID().toString().indexOf(".")&&s++}return t=0,(t=s+1)<10?t="00"+t:9<t&&t<100&&(t="0"+t),r.getCustomID()+"."+t},Dpr.getParentRecord=function(e){var t=aa.cap.getProjectParents(e,1);if(t.getSuccess()){e=t.getOutput();return e.length?e[0].getCapID():null}return Dpr.log("Error getting project parents:  "+t.getErrorMessage()),null},Dpr.getProjectType=function(e){return a("DPR_RECORD_TYPES_ENABLED",e)},Dpr.getRecordWorkDescription=function(e){if((e=aa.cap.getCapWorkDesByPK(e)).getSuccess())return e.getOutput().getDescription()+""},Dpr.getTask=p,Dpr.getTasks=function(e,t,r,o){if((r=aa.workflow.getTaskItems(e,null,"",null,null,r?"Y":null)).getSuccess()){for(var s=[],a=r.getOutput(),n=0;n<a.length;n++)for(var i=a[n],p=0;p<t.length;p++)if(i.getTaskDescription().toUpperCase().equals(t[p].toUpperCase())){s.push(i);break}return s}return Dpr.log("Failed to get workflow object: "+r.getErrorMessage()),null},Dpr.getTaskStatusList=function(e,t,r){var o=[];if((r=aa.workflow.getTaskStatusList(e,t,r)).getSuccess()){var s,a=r.getOutput();for(s in a)o.push(a[s]+"");return o}throw new Error("Task status list could not be retrieved: "+r.getErrorMessage())},Dpr.getTaskUpdatedByUser=function(e,t){if((e=aa.workflow.getTaskItems(e,t,"",null,null,null)).getSuccess())for(var r in wfObj=e.getOutput(),wfObj){r=wfObj[r];if(r.getTaskDescription().toUpperCase().equals(t.toUpperCase()))return r.taskItem.sysUser}return!1},Dpr.getUserEmail=function(e){if(-1!==e.indexOf("PUBLICUSER")){if((r=aa.publicUser.getPublicUserByPUser(e)).getSuccess()){var t=r.getOutput();return t?t.email:null}return null}if((r=aa.person.getUser(e)).getSuccess()){var r=r.getOutput();return r?r.getEmail():null}return null},Dpr.getWorkDescription=function(e){return(e=aa.cap.getCapWorkDesByPK(e)).getSuccess()?(e=e.getOutput().getDescription())?e+"":"":(Dpr.log("Failed to get work description: "+e.getErrorMessage()),"")},Dpr.getRecordPrimaryAddress=function(e){var t=aa.address.getAddressByCapId(e).getOutput(),r={};if(0<t.length)for(var o in t)if(t[o].getPrimaryFlag()&&t[o].getPrimaryFlag().equals("Y")){r.address="";var s=t[o].getHouseNumberStart();null!==s&&0<s.toString().length()&&(r.address+=s);var a=t[o].getHouseFractionStart();null!==a&&0<a.length()&&(r.address+=" "+a);s=t[o].getHouseNumberEnd();null!==s&&0<s.toString().length()&&(r.address+=" - "+s);a=t[o].getHouseFractionEnd();null!==a&&0<a.length()&&(r.address+=" "+a);s=t[o].getStreetDirection();null!==s&&0<s.length()&&(r.address+=" "+s);a=t[o].getStreetName();null!==a&&0<a.length()&&(r.address+=" "+a);s=t[o].getStreetSuffix();null!==s&&0<s.length()&&(r.address+=" "+s);a=t[o].getStreetSuffixdirection();null!==a&&0<a.length()&&(r.address+=" "+a);s=t[o].getUnitType();null!==s&&0<s.length()&&(r.address+=" "+s+"#");a=t[o].getUnitStart(),s=t[o].getUnitEnd();null!==a&&0<a.length()?(r.address+=" "+a,null!==s&&0<s.length()&&(r.address+=" - "+s)):null!==s&&0<s.length()&&(r.address+=" "+s),null!==t[o].getZip()&&(r.zip=t[o].getZip()+""),null!==t[o].getCity()&&(r.city=t[o].getCity()+""),null!==t[o].getState()&&(r.state=t[o].getState()+"");break}return r},Dpr.getRecordPrimaryParcel=function(e,t){t=t||"Yes";var r="";if((e=aa.parcel.getParcelandAttribute(e,null))&&e.getSuccess())for(var o=e.getOutput().toArray(),s=0;s<o.length&&(r=o[s].getParcelNumber()+"","Yes"!==t||o[s].getPrimaryParcelFlag()+""!="Yes");s++);return r},Dpr.isTaskActive=function(e,t){return(t=p(e,t))&&t.getActiveFlag().equals("Y")},Dpr.log=function(e){0<r&&aa.log("DPR -"+e)},Dpr.getLogLevel=function(e){return r},Dpr.setLogLevel=function(e){r=e},Dpr.lookup=s,Dpr.lookupSetting=a,Dpr.matches=function(e,t){for(var r=0;r<t.length;r++)if(t[r]===e)return!0;return!1},Dpr.parseSetting=o,Dpr.removeCustomList=function(e,t,r){if(!(t=aa.appSpecificTableScript.removeAppSpecificTableInfos(r,e,t)).getSuccess())return Dpr.log("**WARNING: error removing ASI table "+r+" "+t.getErrorMessage()),!1},Dpr.runReport=function(e,t,r){try{if(!r.reportName)return Dpr.log("Report name must be provided."),!1;var o=r.reportName,s=aa.reportManager.getReportInfoModelByName(o);if(!s.getSuccess())return Dpr.log("Report not found: "+o),!1;var a=s.getOutput();if(r.module){a.setModule(r.module),a.setCapId(t),reportParamters=r.reportParamters||aa.util.newHashMap(),a.setReportParameters(r.reportParameters);var n=r.reportUser||e,i=aa.reportManager.hasPermission(o,n);if(!i.getSuccess()||!i.getOutput().booleanValue())return Dpr.log("The user "+n+" does not have permission for report called: "+o),!1;if(!(p=aa.reportManager.getReportResult(a)).getSuccess())return Dpr.log("Could not get report from report manager: "+p.getErrorMessage()),!1;var p=p.getOutput(),c=aa.reportManager.storeReportToDisk(p),u=c.getOutput();return c.getSuccess()?u:(Dpr.log("The appliation does not have permission to store this temporary report "+o+", error message please refer to:"+p.getErrorMessage()),!1)}}catch(e){return Dpr.log("Error running report. Error description: "+e.description),!1}},Dpr.scheduleInspection=function(e,t){var r=t.type,o=null,s=t.time||null,a=t.comment||"Scheduled via Script",n=t.daysAhead||0,n=Dpr.dateAdd(null,n);t.inspectorId&&0<t.inspectorId.length&&(o=(t=aa.person.getUser(t.inspectorId)).getSuccess()?t.getOutput():null),(a=aa.inspection.scheduleInspection(e,o,aa.date.parseDate(n),s,r,a)).getSuccess()?Dpr.log("Successfully scheduled inspection : "+r+" for "+n):Dpr.error("ERROR: adding scheduling inspection ("+r+"): "+a.getErrorMessage())},Dpr.sendEmail=function(e,t,r,o,s,a,n){var i,p;Dpr.log("Send to: "+r+". Template: "+s),(n=e?(i=e.ID1,p=e.ID2,e=e.ID3,e=aa.cap.createCapIDScriptModel(i,p,e),aa.document.sendEmailAndSaveAsDocument(t,r,o,s,a,e,n)):aa.document.sendEmailByTemplateName(t,r,o,s,a,n)).getSuccess()?Dpr.log("Sent email successfully!"):Dpr.log("Failed to send mail. - "+n.getErrorType())},Dpr.setLastError=function(e){t=e},Dpr.titleCase=function(e){for(var t=e.toLowerCase().split(" "),r=0;r<t.length;r++)t[r]=t[r].charAt(0).toUpperCase()+t[r].substring(1);return t.join(" ")},Dpr.triggerWtuaEvent=function(e,t,r,o,s){var a=new com.accela.aa.emse.emse.EMSEBusiness,n=aa.util.newHashtable(),i=e.toString().split("-");n.put("PermitId1",i[0]),n.put("PermitId2",i[1]),n.put("PermitId3",i[2]),n.put("CurrentUserID",t),n.put("WorkflowTask",r),n.put("WorkflowStatus",o),s||(r=Dpr.getTask(e,r))&&(s=r.getProcessID()+""),n.put("ProcessID",s),n.put("PROCESSCODE",s),a.handleEvent("WorkflowTaskUpdateAfter",aa.getServiceProviderCode(),n,t,null)},Dpr.updateRecordStatus=function(e,t,r,o){aa.cap.updateAppStatus(e,"APPLICATION",r,aa.date.getCurrentDate(),o,aa.person.getUser(t).getOutput())},Dpr.updateRecordWorkDescription=function(e,t){!(e=aa.cap.getCapWorkDesByPK(e)).getSuccess()||(e=e.getOutput())&&(workDesObj=e.getCapWorkDesModel(),workDesObj.setDescription(t),aa.cap.editCapWorkDes(workDesObj))},Dpr.updateTaskItem=function(e,t,r,o,s,a,n,i){i?aa.workflow.handleDisposition(e,r.getStepNumber(),o,aa.date.getCurrentDate(),a,s,aa.person.getUser(t).getOutput(),i):(r.setDisposition(o),r.setDispositionComment(s),r.setDispositionNote(a),r.setDispositionDate(aa.util.now()),r.setSysUser(aa.person.getUser(t).getOutput()),(r=r.getTaskItem()).setStatusDate(aa.util.now()),aa.workflow.handleDisposition(r,e))},Dpr.updateTask=function(e,t,r,o,s,a,n){var i=p(e,r);i?n?Dpr.updateTaskItem(e,t,i,o,s,a,"",n):Dpr.updateTaskItem(e,t,i,o,s,a):Dpr.log(r+" was not found, unable to update")},Dpr.setTaskRequired=function(e){var t,r,o=e.getCurrentTaskID()+"";"0"===o.charAt(5)&&(t=5,r="1",r=(o=o).substring(0,t)+r+o.substring(t+r.length),e.setCurrentTaskID(r),e=e.getTaskItem(),aa.workflow.adjustTaskWithNoAudit(e))},Dpr.zeroPad=function(e,t){for(var r=String(e);r.length<(t||2);)r="0"+r;return r},Dpr.getMatchingStatusForTask=function(e,t,r,o){for(var s=Dpr.getTaskStatusList(e,r,t),a=0;a<o.length;a++)if(Dpr.matches(o[a],s))return o[a];return null},Dpr.getUniqueNonEmptyItems=function(e,t,r){return e&&r.indexOf(e)===t},Dpr.findFirstMatch=function(e,t){for(var r=0;r<t.length;r++)if(e===t[r].name)return t[r]},Dpr.getDisciplineTasks=function(e){var t=[];if(e.task)t.push(e.task);else{if(!e.tasks)throw new Error("Either task or tasks mapping is required for discipline.");t=t.concat(e.tasks.split(","))}return t},Dpr.getLatestSubmittedPackage=function(e){var t=e.capId,r=Dpr.getAdminUser();if(0<(t=Dpr.getProjectSubmittals(r,t)).length){t=t.filter(function(e){return"SUBMITTED"===e.status.toUpperCase()});return 1===t.length?(t=t[0].id,e.submittalId=t):void 0}}}(),function(){var o={},n=["admin","supervisor","staff","read"];function i(e){var t=o[e];if(!t){var r=function(e){{if(0===e.indexOf("PUBLICUSER"))return"public";for(var t,r=function(){var e={},t=aa.bizDomain.getBizDomain("DPR_ROLES");if(t.getSuccess())for(var r=t.getOutput(),o=0;o<r.size();o++){var s,a=r.get(o);a.getAuditStatus().equals("A")&&(s=a.getBizdomainValue()+"",a=a.getDescription()+"",e[s.toLocaleLowerCase()]=a.toLocaleLowerCase())}return e}(),o=function(e){var t=[],r=new com.accela.aa.aamain.people.SysUserDAOOracle,e=aa.person.getUser(e).getOutput();if(e)for(var o=r.getAllGroupByUser(e),s=0;s<o.size();s++)t.push(o.get(s).getDispText()+"");return t}(e),s=0;s<o.length;s++){var a=r[o[s].toLocaleLowerCase()];if(a&&Dpr.matches(a,n)){if("admin"===a)return a;(!t||"read"===t&&("staff"===a||"supervisor"===a)||"staff"===t&&"supervisor"===t)&&(t=a)}}return t}}(e);if(!r)throw Error("User: "+e+" is not authorized to the plan room.");o[e]=t={role:r}}return t}function s(e){var t,r,o,s,a,n=i(e);n.firstName||n.lastName||(0===e.indexOf("PUBLICUSER")?(t=new java.lang.Long(e.substring(10)),r=aa.proxyInvoker.newInstance("com.accela.pa.people.ContractorPeopleBusiness").getOutput(),(o=new java.util.ArrayList).add(t),null!==(o=r.getContractorPeopleListByUserSeqNBR(aa.getServiceProviderCode(),o))&&0<o.size()&&(s=o.get(0).getContactSeqNumber(),s=(a=aa.people.getPeople(s).getOutput()).getFirstName(),a=a.getLastName())):(e=aa.person.getUser(e.toUpperCase())).getSuccess()&&(s=(e=e.getOutput()).getFirstName(),a=e.getLastName()),s&&(n.firstName=s+""),a&&(n.lastName=a+""))}function a(e){var t=javax.xml.bind.DatatypeConverter.printBase64Binary(e),e=t.indexOf("=");return t=(t=(t=-1<e?t.substring(0,e):t).replace("+","-")).replace("/","_")}function p(e,t,r){var o=new java.lang.String('{"typ":"JWT", "alg":"HS256"}').getBytes("UTF-8"),s=t,t=Date.now(),r=new java.util.Date(t+60*r*1e3).getTime()/1e3;s.exp=r+"";r=new java.lang.String(JSON.stringify(s)).getBytes("UTF-8"),s=a(o),o=a(r),r=new java.lang.StringBuffer;r.append(s),r.append("."),r.append(o);o=r.toString(),r=o.getBytes("UTF-8");return o+"."+a((o=e,e=r,r=javax.crypto.Mac.getInstance("HmacSHA256"),o=new javax.crypto.spec.SecretKeySpec(o,"HmacSHA256"),r.init(o),r.doFinal(e)))}function c(e,t,r,o){try{com.accela.util.AVProperties&&com.accela.util.AVProperties.getProperty("https.protocols")+""!="TLSv1.2"&&com.accela.util.AVProperties.setProperty("https.protocols","TLSv1.2");var s,a=t||"GET";if((s=new java.net.URL(e).openConnection()).setRequestMethod(a),s.setRequestProperty("Accept-Charset","UTF-8"),s.setRequestProperty("Content-Type","application/json"),r&&s.setRequestProperty("Authorization","Bearer "+r),s.setUseCaches(!1),s.setDoOutput(!0),(a.equals("POST")||a.equals("PUT"))&&o){var n,i=new java.lang.String(JSON.stringify(o)).getBytes("UTF-8");try{(n=s.getOutputStream()).write(i,0,i.length),n.flush()}finally{n&&n.close()}}var p=s.getResponseCode();Dpr.log(a+" "+e+", Status code: "+p);var c,u={code:p};if(200<=p&&p<300)try{if(c=s.getInputStream()){var d=new java.lang.StringBuffer;try{for(var l,g=aa.io&&aa.io.BufferedReader&&aa.io.InputStreamReader?aa.io.BufferedReader(aa.io.InputStreamReader(c,"UTF-8")):new java.io.BufferedReader(new java.io.InputStreamReader(c));null!==(l=g.readLine());)d.append(l);var D=0<d.length()?JSON.parse(d.toString()):null;u.body=D}finally{if(g)try{g.close()}catch(e){Dpr.log("Error closing http connection buffer.")}}}}finally{if(c)try{c.close()}catch(e){Dpr.log("Error closing http connection stream.")}}return u}finally{s&&s.disconnect()}}function u(e){var t=0===e.indexOf("PUBLICUSER")?"aca":"accela",r=i(e),e={iss:t,sub:e,role:r.role};return r.firstName&&r.firstName.length&&(e.fn=r.firstName),r.lastName&&r.lastName.length&&(e.ln=r.lastName),e}Dpr.decodeKey=function(e){return javax.xml.bind.DatatypeConverter.parseBase64Binary(e)},Dpr.sendHead=function(e,t){var r;return c(e,"HEAD",r=t?p(Dpr.getApiKey(),u(t),20):r)},Dpr.sendGet=function(e,t){var r;return c(e,"GET",r=t?p(Dpr.getApiKey(),u(t),20):r)},Dpr.sendPost=function(e,t,r){var o;return t&&(s(t),o=p(Dpr.getApiKey(),u(t),20)),c(e,"POST",o,r)},Dpr.sendPut=function(e,t,r){var o;return t&&(s(t),o=p(Dpr.getApiKey(),u(t),20)),c(e,"PUT",o,r)},Dpr.sendDelete=function(e,t){var r;return c(e,"DELETE",r=t?p(Dpr.getApiKey(),u(t),20):r)}}(),function(){var settings={logLevel:0,planRoomUrl:"/av-dpr/planroom.jsp",dbContext:"AA"};function setSettings(e){for(var t in e)e.hasOwnProperty(t)&&(settings[t]=e[t])}function loadSettings(){var e=aa.bizDomain.getBizDomain("DPR_CONFIGS");if(e.getSuccess())for(var t=e.getOutput(),r=0;r<t.size();r++){var o=t.get(r);if(o.getAuditStatus().equals("A")){var s=o.getBizdomainValue()+"",a=(a=o.getDescription()+"").trim();switch(s.toUpperCase()){case"ENDPOINT":settings.endpoint=a;break;case"APIKEY":settings.apikey=a;break;case"DPR_USER_ID":settings.adminUser=a;break;case"SUPER_AGENCY_CODE":settings.superAgencyCode=a;break;case"ENVIRONMENT":settings.environment=a;break;case"PLAN_ROOM_URL":a.length&&(settings.planRoomUrl=a);break;case"DB_CONTEXT":a.length&&(settings.dbContext=a);break;case"LOG_LEVEL":"debug"===a.toLowerCase()&&Dpr.setLogLevel(1)}}}}function init(e){loadSettings(),e&&loadExtensions(),validateSettings()}function validateSettings(){if(!settings.endpoint)throw new Error("Digital Plan Room ENDPOINT needs to be configured.");if(!settings.apikey)throw new Error("Digital Plan Room APIKEY needs to be configured.");if(settings.apikey=Dpr.decodeKey(settings.apikey),!settings.adminUser)throw new Error("Digital Plan Room DPR_USER_ID needs to be configured.");if(!settings.environment)throw new Error("Digital Plan Room ENVIRONMENT needs to be configured.")}function loadExtensions(){var extensions=Dpr.loadScript("INCLUDES_DPR_CUSTOM");extensions.length&&eval(extensions)}function getVersion(){var e=Dpr.sendGet(Dpr.getEndpoint()+"/version");if(200===e.code)return e.body;throw new Error("Failed to get DPR version. Response code: "+e.code)}function getProject(e,t){t=t.getId()+"";Dpr.log("Get DPR project: "+t);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t,e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Getting project: "+t+". Response code: "+e.code)}function getProjects(e,t){var r;t&&0<t.length&&(r="statuses:"+t.join(",")+";"),r=r&&"filter="+r.substring(0,r.length-1);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects?"+r,e);if(200===e.code)return e.body;throw new Error("Failed to get projects. Response code: "+e.code)}function projectActive(e,t){t=Dpr.getProject(e,t);return t&&"closed"!==t.status}function projectExists(e,t){return null!==Dpr.getProject(e,t)}function updateProject(e,t,r){if(r){Dpr.log("Update project sent for record: "+t.getCustomID()),r.id=t.getId()+"";e=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+r.id,e,r);if(200!==e.code)throw new Error("Failed to update project: "+r.id+". Response code: "+e.code)}}function updateProjectDocument(e,t,r){if(r){Dpr.log("Update document sent for record: "+t.getCustomID());var o=t.getId()+"",r=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+o+"/documents/"+r.id,e,r);if(200!==r.code)throw new Error("Failed to update document: "+t.getCustomID()+". Response code: "+r.code)}}function createProject(e,t,r){if(r){Dpr.log("Create project sent for record: "+r.number),r.id=t.getId()+"";e=Dpr.sendPost(Dpr.getEndpoint()+"/projects",e,r);if(201!==e.code&&304!==e.code)throw new Error("Failed to create  project: "+r.id+". Response code: "+e.code);return e}throw new Error("Project parameter is required.")}function moveProject(e,t,r){if(!r)throw new Error("toProject parameter is required.");t=t.getId()+"",e=Dpr.sendPost(Dpr.getEndpoint()+"/projects?op=move&from="+t,e,r);if(Dpr.log("Move project sent for record: "+t+" to "+r.id),202!==e.code)throw new Error("Failed to move project: "+t+" to "+r.id+". Response code: "+e.code)}function createProjectProperties(e,t,r){if(!r)throw new Error("Properties parameter is required.");t=t.getId()+"",r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/properties",e,r);if(201!==r.code)throw new Error("Failed to create  project properties: "+t+". Response code: "+r.code)}function updateProjectProperties(e,t,r){if(!r)throw new Error("Properties parameter is required.");t=t.getId()+"",r=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+t+"/properties",e,r);if(200!==r.code)throw new Error("Failed to update project properties: "+t+". Response code: "+r.code)}function getProjectProperties(e,t){var r=t.getId()+"";Dpr.log("Get project properties sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/properties",e);if(200===e.code)return e.body;throw new Error("Failed to get project properties for project: "+r+". Response code: "+e.code)}function getProjectGroups(e,t){var r=t.getId()+"";Dpr.log("Get project groups sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/groups",e);if(200===e.code)return e.body;throw new Error("Failed to get project groups for project: "+r+". Response code: "+e.code)}function getProjectGroup(e,t,r){var o=t.getId()+"";Dpr.log("Get project group sent for project: "+t.getCustomID()+" and group: "+r);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/groups/"+r,e);if(200===e.code)return e.body;throw new Error("Failed to get project group for project: "+o+" and group: "+r+". Response code: "+e.code)}function getProjectGroupItems(e,t,r){var o=t.getId()+"";Dpr.log("Get project group items sent for project: "+t.getCustomID()+" and group: "+r);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/groups/"+r+"/items",e);if(200===e.code)return e.body;throw new Error("Failed to get project group items for project: "+o+" and group: "+r+". Response code: "+e.code)}function createProjectGroup(e,t,r){t=t.getId()+"";Dpr.log("Create project group sent for record: "+t);r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/groups",e,r);if(201===r.code)return r.body;throw new Error("Failed to create  project group: "+t+". Response code: "+r.code)}function createProjectGroupItems(e,t,r,o){t=t.getId()+"";Dpr.log("Create project group items sent for record: "+t);o=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/groups/"+r+"/items",e,o);if(201!==o.code&&304!==o.code)throw new Error("Failed to create project group items: "+t+" and group: "+r+". Response code: "+o.code);304===o.code&&Dpr.log("Items already exist in project group "+r+" on project "+t)}function deleteProjectFromGroup(e,t,r){t=t.getId()+"",e=Dpr.sendDelete(Dpr.getEndpoint()+"/projects/"+t+"/groups/"+r+"/items/"+t,e);if(200!==e.code)throw new Error("Failed to delete project group item: "+t+" from group: "+r+". Response code: "+e.code)}function deleteProjectFromAllGroups(e,t){var r=getProjectGroups(e,t);if(0<r.length)for(var o in r)deleteProjectFromGroup(e,t,r[o].id)}function addProject2ParentGroup(e,t,r){var o,s,a,n=r.prefix,i=r.parent,p=r.type,c=getProjectGroups(e,i),u=!0;if(0<c.length){for(s in c)if(c[s].type===p){o=c[s].id,u=!1;break}o&&((a=[]).push(aa.getServiceProviderCode()+"-"+t.toString()),createProjectGroupItems(e,t,o,a))}u&&((a={}).name=n+": "+i.getCustomID(),a.type=p,a.items=[],a.items.push({project:aa.getServiceProviderCode()+"-"+i.toString()}),a.items.push({project:aa.getServiceProviderCode()+"-"+t.toString()}),createProjectGroup(e,i,a))}function getPrintSets(e,t){var r=t.getId()+"";Dpr.log("Get print sets sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/printsets",e);if(200===e.code)return e.body;throw new Error("Failed to get print sets for project: "+r+". Response code: "+e.code)}function getPrintSet(e,t,r){var o=t.getId()+"";Dpr.log("Get print sets sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/printsets/"+r,e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed to get print sets for project: "+o+". Response code: "+e.code)}function createTemplatePrintSets(e,t,r){var o=t.getId()+"";Dpr.log("DPR: Create print set sent for: "+t.getCustomID());r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+o+"/printsets",settings.adminUser,r);if(202!==r.code)throw new Error("Failed to create printset: "+o+". Response code: "+r.code)}function createSheetsPrintSet(e,t,r){var o=t.getId()+"";Dpr.log("DPR: Create print set sent for: "+t.getCustomID());r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+o+"/sheets/printsets",settings.adminUser,r);if(202!==r.code)throw new Error("Failed to create printset: "+o+". Response code: "+r.code)}function createDocumentsPrintSet(e,t,r){if(r.documents&&r.documents.length){var o=t.getId()+"";Dpr.log("DPR: Create print set sent for: "+t.getCustomID());r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+o+"/documents/printsets",settings.adminUser,r);if(202!==r.code)throw new Error("Failed to document create printset: "+o+". Response code: "+r.code)}else Dpr.log("Create document print set failed for: "+t.getCustomID()+", no documents included in the request.")}function deletePrintSet(e,t,r,o){t=t.getId()+"",e=Dpr.sendDelete(Dpr.getEndpoint()+"/projects/"+t+"/printsets/"+r+(o&&!1===o.discard?"?discard=no":"?discard=yes"),e);if(200!==e.code)throw new Error("Failed to delete print set for project: "+t+" and print set id: "+r+". Response code: "+e.code)}function getApprovedPlans(e,t){var r=t.getId()+"";Dpr.log("Get approved plans sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/approved/plans",e);if(200===e.code)return e.body;throw new Error("Failed to get print sets for project: "+r+". Response code: "+e.code)}function getApprovedDocuments(e,t){var r=t.getId()+"";Dpr.log("Get approved docs sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/approved/documents",e);if(200===e.code)return e.body;throw new Error("Failed to get print sets for project: "+r+". Response code: "+e.code)}function getReportPrintsets(e,t){var r=t.getId()+"";Dpr.log("Get report printsets sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/reports",e);if(200===e.code)return e.body;throw new Error("Failed to get report printsets for project: "+r+". Response code: "+e.code)}function getPrintSetsPendingArchive(e){e=Dpr.sendGet(Dpr.getEndpoint()+"/printsets?archive=pending",e);if(200===e.code)return e.body;throw new Error("Failed retrieve files. Response code: "+e.code)}function archivePrintSet(e,t){if(t){var r=t.project+"";Dpr.log("Archive printset sent for fileId '"+t.id+"' on project "+r);e=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+r+"/printsets/"+t.id+"/archive",e,{});if(202===e.code)return e.body;if(409===e.code)return;throw new Error("Failed to archive printset: "+r+" . Response code: "+e.code)}throw new Error("Failed to archive file, no file provided")}function getProjectDocuments(e,t){var r=t.getId()+"";Dpr.log("Getting document list for project: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/documents",e);if(200===e.code)return e.body;throw new Error("Failed to get document list for project: "+t.getCustomID()+". Response code: "+e.code)}function getAvailableDocumentsForImport(e,t){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/files/imports?role=document",e);if(200===e.code)return e.body;throw new Error("Failed to get validated documents: "+t+". Response code: "+e.code)}function addSupportingDocumentsForImport(e,t,r){t=t.getId()+"";Dpr.log("Import documents sent for record: "+t);r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/files/imports",e,r);if(201===r.code)return r.body;throw new Error("Failed to import documents: "+t+". Response code: "+r.code)}function getStagedDocumentsForImport(e,t){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/documents/imports",e);if(200===e.code)return e.body;throw new Error("Failed to get validated documents: "+t+". Response code: "+e.code)}function importValidatedSupportingDocuments(e,t,r){t=t.getId()+"",r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/documents",e,r);if(202===!r.code)throw new Error("Failed to import documents: "+t+". Response code: "+r.code)}function getAvailableProjectStamps(e,t){var r=t.getId()+"";Dpr.log("DPR: Get available project stamps sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/stamps/templates",e);if(200===e.code)return e.body;throw new Error("Failed to get available project stamps for project: "+t.getCustomID()+". Response code: "+e.code)}function getProjectSheetStamps(e,t,r){var o=t.getId()+"";Dpr.log("Get available project stamps sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/sheets/"+r+"/stamps",e);if(200===e.code)return e.body;throw new Error("Failed to get available project stamps. Response code: "+e.code)}function deleteProjectStamps(e,t){var r=getAvailableProjectStamps(e,t);if(0<r.length)for(var o in r)deleteProjectStamp(e,t,r[o])}function deleteProjectStamp(e,t,r){var o=t.getId()+"",s={};s.name=encodeURI(r),Dpr.log("DPR: Deleting project stamp sent for: "+t.getCustomID()+" and stamp: "+r);e=Dpr.sendDelete(Dpr.getEndpoint()+"/projects/"+o+"/sheets/stamps?name="+s.name,e);if(200!==e.code)throw new Error("Failed to delete stamp for project: "+o+" and stamp: "+r+". Response code: "+e.code)}function getWatermarkSettings(e){e=Dpr.sendGet(Dpr.getEndpoint()+"/settings/watermarks",e);if(200===e.code)return e.body;throw new Error("Failed to get watermarks. Response code: "+e.code)}function updateWatermarkSettings(e,t){if(t){t=Dpr.sendPost(Dpr.getEndpoint()+"/settings/watermarks",e,t);if(201!==t.code)throw new Error("Failed to update watermarks settings. Response code: "+t.code)}}function createProjectPlusSubmittal(e,t,r,o){if(Dpr.log("Create project plus submittal package sent for: "+r.number),304!==createProject(e,t,r).code)return createSubmittalPackage(e,t,o||{},!1);moveProject(e,t,r);t=getLatestProjectSubmittal(e,t);return t?t.id:null}function createSubmittalPackage(e,t,r,o){o=o?"?publish=yes":"",t=t.getId()+"";Dpr.log("Create submittal package sent for: "+t);r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/submittals"+o,e,r);if(201===r.code)return r.body.id;throw new Error("Failed to create submittal for project: "+t+". Response code: "+r.code)}function getProjectSubmittal(e,t,r){var o=t.getId()+"";Dpr.log("Get submittal sent for project: "+t.getCustomID()+" and submittal: "+r);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/submittals/"+r,e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed to get submittal for project: "+o+". Response code: "+e.code)}function getProjectSubmittals(e,t){var r=t.getId()+"";Dpr.log("Get submittals sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/submittals",e);if(200===e.code)return e.body;throw new Error("Failed to get submittals for project: "+r+". Response code: "+e.code)}function getLatestProjectSubmittal(e,t){var r=t.getId()+"";Dpr.log("DPR: Get latest package sent for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/submittals/last",e);if(200===e.code)return e.body;throw new Error("Failed to get submittals for project: "+r+". Response code: "+e.code)}function updateProjectSubmittal(e,t,r){var o=t.getId()+"";Dpr.log("Update submittal package sent for: "+t.getCustomID());e=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+o+"/submittals/"+r.id,e,r);if(200!==e.code&&304!==e.code&&409!==e.code)throw new Error("Failed to update submittal for project: "+o+" and submittal: "+r.id+". Response code: "+e.code);409===e.code&&Dpr.error("Failed to update submittal for project: "+o+" and submittal: "+r.id+". Response code: "+e.code+". Submittal is in an invalid state for this status update.")}function getPackageSheets(e,t,r){var o=t.getId()+"";Dpr.log("Getting sheets for package: "+r+" on project: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/submittals/"+r+"/views",e);if(200===e.code)return e.body;throw new Error("Failed to get sheets for package: "+r+" on project: "+t.getCustomID()+". Response code: "+e.code)}function getPackageSheetCount(e,t,r){var o;if(r||(o=getLatestProjectSubmittal(e,t))&&(r=o.id),r){e=getPackageSheets(e,t,r);if(e)return e.length;Dpr.log("Error getting sheets for package: "+r+" on project: "+t.getCustomID())}else Dpr.log("DPR - No packages exist for project: "+t.getCustomID());return 0}function updatePackageSheets(e,t,r,o){t=t.getId()+"";if(o&&o.length){Dpr.log("Update package sheet sent for : "+t);o=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+t+"/submittals/"+r+"/views",e,o);if(200!==o.code&&304!==o.code)throw new Error("Failed to update package sheets: "+t+". Response code: "+o.code)}}function getProjectSheetViews(e,t,r){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/submittals/"+r+"/views",e);if(200===e.code)return e.body;throw new Error("Failed to get sheet views for project/submittal: "+t+"/"+r+". Response code: "+e.code)}function reOrderProjectSheets(e,t){var r=[];if(0<(r=getProjectSheets(e,t)).length)for(var o in r){var s=r[o],a=[];if(0<(a=getSheetVersions(e,t,s.id)).length)for(var n in a){a[n];updateSheet(e,t,s)}}}function getSheetVersions(e,t,r){var o=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/sheets/"+r+"/versions",e);if(200===e.code)return e.body;throw new Error("Failed to get sheet versions for sheet/project: "+r+"/"+t.getCustomID()+". Response code: "+e.code)}function getSheetSummary(e,t){var r=t.getId()+"";Dpr.log("Getting sheets Summary for project: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/sheets/summary",e);if(200===e.code)return e.body;throw new Error("Failed to get sheets summary for project: "+t.getCustomID()+". Response code: "+e.code)}function updateSheet(e,t,r){t=t.getId()+"",e=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+t+"/sheets/"+r.id,e,r);if(200!==e.code)throw new Error("Failed to update sheet/project: "+r.id+"/"+t+". Response code: "+e.code)}function hasProjectSheets(e,t){var r=t.getId()+"",e=Dpr.sendHead(Dpr.getEndpoint()+"/projects/"+r+"/sheets",e);if(200===e.code)return!0;if(404===e.code)return!1;throw new Error("Failed to get sheets for project: "+t.getCustomID()+". Response code: "+e.code)}function hasProjectGroupSheets(e,t,r){var o=t.getId()+"",e=Dpr.sendHead(Dpr.getEndpoint()+"/projects/"+o+"/groups/"+r+"/sheets",e);if(200===e.code)return!0;if(404===e.code)return!1;throw new Error("Failed to get sheets for project: "+t.getCustomID()+". Response code: "+e.code)}function getProjectSheets(e,t){var r=t.getId()+"";Dpr.log("Getting sheets for project: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/sheets",e);if(200===e.code)return e.body;throw new Error("Failed to get sheets for project: "+t.getCustomID()+". Response code: "+e.code)}function approveSheetsByDisciplineTask(e,t,r){var o,s,a=Dpr.getDisciplineByWorkflowTask(r);a?(o=[],(s={}).discipline=a.id,s.status="approved",o.push(s),Dpr.updateProjectSheetsApprovals(e,t,o)):Dpr.log("No discipline found for task: "+r)}function updateProjectSheetsApprovals(e,t,r){t=t.getId()+"";if(r&&r.length){Dpr.log("Sheet approvals sent for: "+t);r=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+t+"/sheets/approvals",e,r);if(200!==r.code&&304!==r.code)throw new Error("Failed to approve sheets for project: "+t+". Response code: "+r.code)}}function getSheetSetOrders(e,t){var r=t.getId()+"";Dpr.log("Get sheet set orders for: "+t.getCustomID());e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+r+"/sheetsetorders",e);if(200===e.code)return e.body;throw new Error("Failed to get sheet set orders project: "+r+". Response code: "+e.code)}function updateSheetSetOrder(e,t,r){var o=t.getId()+"";Dpr.log("Update sheet set order sent for: "+t.getCustomID());r=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+o+"/sheetsetorders/"+r.id,e,r);if(200!==r.code&&304!==r.code)throw new Error("Failed to update sheet set order for project: "+o+". Response code: "+r.code)}function getDisciplineByWorkflowTask(e){var t=aa.bizDomain.getBizDomain("DPR_DISCIPLINES");if(t.getSuccess())for(var r=t.getOutput(),o=0;o<r.size();o++){var s=r.get(o);if(s.getAuditStatus().equals("A"))for(var a=s.getBizdomainValue()+"",s=s.getDescription()+"",n=Dpr.parseSetting(s),i=Dpr.getDisciplineTasks(n),p=0;p<i.length;p++)if(i[p].toUpperCase().trim()===e.toUpperCase().trim())return n.id=a,n}return null}function isDisciplineTask(e){return null!==getDisciplineByWorkflowTask(e)}function getAllDisciplines(){var e=[],t=aa.bizDomain.getBizDomain("DPR_DISCIPLINES");if(t.getSuccess())for(var r=t.getOutput(),o=0;o<r.size();o++){var s,a=r.get(o);a.getAuditStatus().equals("A")&&(s=a.getBizdomainValue()+"",a=a.getDescription()+"",(a=Dpr.parseSetting(a)).id=s,e.push(a))}return e}function getAllProjectDisciplines(e){var t=getAllDisciplines(),r=[],e=aa.workflow.getTasks(e);if(e.getSuccess()){var o,s=e.getOutput();for(o in s){var a,n=s[o].getTaskDescription()+"";for(a in t)for(var i=Dpr.getDisciplineTasks(t[a]),p=0;p>i.length;p++)n.toLowerCase().trim()===i[p].toLowerCase().trim()&&r.push(t[a])}}return r}function getReviewTasks(e,t){for(var r=[],o=Dpr.getDisciplineSettings(),s=0;s<o.length;s++)r=r.concat(Dpr.getDisciplineTasks(o[s]));return Dpr.getTasks(e,r,t?"Y":null)}function acceptReviewPackages(e,t,r){Dpr.log("Updating submitted packages to accepted for project: "+t.getCustomID());var o=getProjectSubmittals(e,t);if(0<o.length)for(var s=0;s<o.length;s++){var a,n=o[s];(r&&n.recipient&&r.toUpperCase()===n.recipient.toUpperCase()||!r&&!n.recipient)&&n.status&&"SUBMITTED"===n.status.toUpperCase()&&((a={}).id=n.id,a.status="accepted",Dpr.updateProjectSubmittal(e,t,a))}}function isOpenSubmittals(e,t,r,o,s){s=s||["SUBMITTED","ACCEPTED"],Dpr.log("Checking for open review packages on project: "+t.getCustomID());var a=getProjectSubmittals(e,t);if(o)for(c=0;c<a.length;c++){u=a[c];if((!r||r===u.type)&&(o&&u.recipient&&o.toUpperCase()===u.recipient.toUpperCase()||!o&&!u.recipient)){if(!Dpr.matches(u.status.toUpperCase(),s))return!0;var n=getSubmittalFiles(e,t,u.id);if(n&&0<n.length)for(var i=0;i<n.length;i++){var p=n[i];if(!Dpr.matches(p.status,["processed","accepted"]))return!0}}}else{for(var c=0;c<a.length;c++){var u=a[c];if((!r||r===u.type)&&(o&&u.recipient&&o.toUpperCase()===u.recipient.toUpperCase()||!o&&!u.recipient)&&!Dpr.matches(u.status.toUpperCase(),s))return!0}if(!isAllProjectSubmittalFilesProcessed(e,t,a))return!0}return!1}function isSubmittalEmpty(e,t,r){var o=t.getId()+"";Dpr.log("Getting submittal files status for project: "+t.getCustomID());e=Dpr.sendHead(Dpr.getEndpoint()+"/projects/"+o+"/submittals/"+r+"/files",e);if(404===e.code)return!0;if(200===e.code)return!1;throw new Error("Failed to get state of submittal for project: "+t.getCustomID()+" submittal: "+r+". Response code: "+e.code)}function cleanUpEmptyReviewPackages(e,t){var r=getProjectSubmittals(e,t);if(0<r.length)for(var o=0;o<r.length;o++){var s=r[o];Dpr.matches(s.status.toUpperCase(),["SUBMITTED","ACCEPTED","ACCEPTING","SUBMITTING","WITHDRAWING"])||isSubmittalEmpty(e,t,s.id)&&deleteReviewPackage(e,t,s.id)}return!0}function deleteReviewPackage(e,t,r){t=t.getId()+"",e=Dpr.sendDelete(Dpr.getEndpoint()+"/projects/"+t+"/submittals/"+r,e);if(200!==e.code)throw new Error("Failed to delete review package for project: "+t+" and submittal: "+r+". Response code: "+e.code)}function getSubmittalFiles(e,t,r){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/submittals/"+r+"/files",e);if(200===e.code)return e.body;throw new Error("Failed to get files for project: "+t+" and submittal: "+r+". Response code: "+e.code)}function issueFilterToQueryString(e,t){var r="";return e&&0<e.length&&(r+="statuses:"+e.join(",")+";"),!t||(t=getDisciplineByWorkflowTask(t))&&(r+="disciplines:"+encodeURIComponent(t.id)+";"),r=r.length?"filter="+r.substring(0,r.length-1):r}function getIssues(e,t,r,o){t=t.getId()+"",o=issueFilterToQueryString(r,o),e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/issues?options=ext"+(o.length?"&"+o:""),e);if(200===e.code)return e.body;throw new Error("Failed getting issues for project: "+t+". Response code: "+e.code)}function hasIssues(e,t,r,o){t=t.getId()+"",o=issueFilterToQueryString(r,o),e=Dpr.sendHead(Dpr.getEndpoint()+"/projects/"+t+"/issues"+(o.length?"?"+o:""),e);if(200===e.code)return!0;if(404===e.code)return!1;throw new Error("Failed has issues for project: "+t+". Response code: "+e.code)}function hasOpenIssues(e,t,r){return Dpr.log("Getting open issues for: "+t.getId()),hasIssues(e,t,["draft","open","inreview","answered","notaccepted"],r)}function hasIssuesIn(e,t,r,o){return Dpr.log("Getting issues for statuses: "+t.getId()),hasIssues(e,t,r,o)}function getOpenIssueDisciplines(e,t){var r=[];Dpr.log("Getting open issues for: "+t.getId());for(var o=getIssues(e,t,["draft","open","inreview","answered","notaccepted"]),s=Dpr.getDisciplineSettings(),a=0;a<o.length;a++){var n=function(e,t){for(var r=0;r<t.length;r++)if(e.toUpperCase().trim()===t[r].id.toUpperCase().trim())return t[r]}(o[a].discipline,s).text;-1===r.indexOf(n)&&r.push(n)}return r}function getOpenIssuesCount(e,t,r){Dpr.log("Getting open issues for: "+t.getId());t=Dpr.getIssues(e,t,["open","answered"],r);return r?t.length+" "+r.toLowerCase()+" issue(s)":t.length+""}function publishIssues(e,t,r){var o=t.getId()+"",s={status:"publish"};if(r){t=getDisciplineByWorkflowTask(r);if(!t)return void Dpr.log("Failed to retrieve discipline for workflow task: "+r+" for project "+o+".");s.discipline=t.id,Dpr.log("DPR - Publish issues for "+t+" discipline on project "+o+" sent.")}else Dpr.log("DPR - Publish all issues on project "+o+" sent.");s=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+o+"/issues",e,s);if(200!==s.code&&304!==s.code)throw new Error("Failed to publish issues on project "+o+". Response code: "+s.code);304===s.code&&Dpr.log("No issues were available for publishing on "+o)}function createProjectIssue(e,t,r){t=t.getId()+"";Dpr.log("Create project issue sent for record: "+t);r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/issues",e,r);if(201===r.code)return r.body;throw new Error("Failed to create project issue: "+t+". Response code: "+r.code)}function updateProjectIssue(e,t,r){t=t.getId()+"";Dpr.log("Create project issue sent for record: "+t);e=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+t+"/issues/"+r.id,e,r);if(200!==e.code)throw new Error("Failed to udpate project issue: "+r.id+". Response code: "+e.code)}function conditionsFilterToQueryString(e){var t=e.statuses,r=e.taskName,o=e.types,e="";return t&&0<t.length&&(e+="statuses:"+t.join(",")+";"),!r||(r=getDisciplineByWorkflowTask(r))&&(e+="disciplines:"+encodeURIComponent(r.id)+";"),o&&0<o.length&&(e+="types:"+o.join(",")+";"),e=e.length?"filter="+e.substring(0,e.length-1):e}function getConditions(e,t,r){var o,t=t.getId()+"";r&&(o=conditionsFilterToQueryString(r));e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/conditions"+(o?"?"+o:""),e);if(200===e.code)return e.body;throw new Error("Failed getting conditions for project: "+t+". Response code: "+e.code)}function hasConditions(e,t,r){var o,t=t.getId()+"";r&&(o=conditionsFilterToQueryString(r));e=Dpr.sendHead(Dpr.getEndpoint()+"/projects/"+t+"/conditions"+(o?"?"+o:""),e);if(200===e.code)return!0;if(404===e.code)return!1;throw new Error("Failed has conditions for project: "+t+". Response code: "+e.code)}function hasOpenConditions(e,t,r){Dpr.log("Getting open conditions for: "+t.getId());var o={statuses:["draft","open"]};return o.taskName=r,o.types=["condition"],hasConditions(e,t,o)}function getOpenConditionsCount(e,t,r){Dpr.log("Getting conditions for: "+t.getId());var o={statuses:["open"]};o.taskName=r,o.types=["condition"];o=getConditions(e,t,o);return r?o.length+" "+r.toLowerCase()+" condition(s)":o.length+""}function getOpenNotesCount(e,t,r){Dpr.log("Getting notes for: "+t.getId());var o={statuses:["open"]};o.taskName=r,o.types=["note"];o=getConditions(e,t,o);return r?o.length+" "+r.toLowerCase()+" note(s)":o.length+""}function publishConditions(e,t,r){var o=t.getId()+"",s={status:"publish"};if(r){t=getDisciplineByWorkflowTask(r);if(!t)return void Dpr.log("Failed to retrieve discipline for workflow task: "+r+" for project "+o+".");s.discipline=t.id,Dpr.log("Publish conditions for "+t.id+" discipline on project "+o+" sent.")}else Dpr.log("Publish all conditions on project "+o+" sent.");s=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+o+"/conditions",e,s);if(200!==s.code)throw new Error("Failed to publish conditions on project "+o+". Response code: "+s.code)}function getFileInfo(e,t){e=Dpr.sendGet(Dpr.getEndpoint()+"/files/"+t,e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed retrieve file: "+t+". Response code: "+e.code)}function getProjectFile(e,t,r){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/files/"+r,e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed retrieve file: "+r+". Response code: "+e.code)}function getProjectFiles(e,t){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/files",e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed retrieve file: "+id+". Response code: "+e.code)}function isAllProjectSubmittalFilesProcessed(e,t,r){var o=r.map(function(e){return e.id}),s=getProjectFiles(e,t);if(s)for(var a=0;a<s.length;a++){var n=s[a];if(n.submittal&&(Dpr.matches(n.submittal,o)&&!Dpr.matches(n.status,["processed","accepted"])))return!1}return!0}function getFiles(e,t){e=Dpr.sendGet(Dpr.getEndpoint()+"/files?ids="+t,e);if(200===e.code)return e.body;throw new Error("Failed retrieve files: "+t+". Response code: "+e.code)}function getFilesFromDocuments(e,t,r){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/ab/records/"+t+"/files?docs="+r,e);if(200===e.code)return e.body;throw new Error("Failed retrieve files: "+r+". Response code: "+e.code)}function getDocumentsFromFiles(e,t,r){t=t.getId()+"",e=Dpr.sendGet(Dpr.getEndpoint()+"/ab/records/"+t+"/files?ids="+r,e);if(200===e.code)return e.body;throw new Error("Failed retrieve files: "+r+". Response code: "+e.code)}function deleteFile(e,t){e=Dpr.sendDelete(Dpr.getEndpoint()+"/files/"+t,e);if(200!==e.code)throw new Error("Failed to delete file: "+t+". Response code: "+e.code)}function getFilesPendingArchive(e){e=Dpr.sendGet(Dpr.getEndpoint()+"/files?archive=pending",e);if(200===e.code)return e.body;throw new Error("Failed retrieve pending files. Response code: "+e.code)}function archiveFile(e,t){if(t){var r=t.project+"";aa.print("Archive file sent for fileId '"+t.id+"' on project "+r),aa.print(Dpr.getEndpoint()+"/projects/"+r+"/files/"+t.id+"/archive");e=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+r+"/files/"+t.id+"/archive",e,{});if(202===e.code)return e.body;if(409===e.code)return;throw new Error("Failed to archive file: "+r+" . Response code: "+e.code)}throw new Error("Failed to archive file, no file provided")}function sendError(e){e&&(Dpr.log("Sending error details to DPR Cloud: "+settings.adminUser),200!==(e=Dpr.sendPost(Dpr.getEndpoint()+"/diag/dump",settings.adminUser,e)).code&&Dpr.log("Failed to send error details to DPR Cloud. Response code: "+e.code))}function getAcaDeepLinkUrl(e,t,r,o,s){if(r&&r.length){if("RESUMESUBMITTAL"!==o&&"SHEETVERSIONING"!==o||s){var a=r;a+="/Customization/"+(Dpr.getSuperAgencyCode()?Dpr.getSuperAgencyCode():aa.getServiceProviderCode()),a+="/Dpr/Component/PlanRoom.aspx?page=";r="";if("ISSUESLIST"===o)r="issues";else if("CONDITIONSLIST"===o)r="conditions";else if("NOTESLIST"===o)r="notes";else if("UPLOADS"===o)r="submittals";else if("RESUMESUBMITTAL"===o)r="wizard";else if("SHEETVERSIONING"===o)r="wizard";else if("APPROVEDPLANS"===o)r="approved";else if("SUMMARY"===o)r="summary";else if("ATTACHMENTS"===o)r="attachments";else{if("MIDCYCLE"!==o)return void Dpr.log("getAcaDeepLinkUrl - invalid pageId");r="notification"}return a+=r+"&Module="+t+"&TabName="+t,a+="&recordId="+aa.getServiceProviderCode()+"-"+e.toString(),a+="&customId="+e.getCustomID(),"RESUMESUBMITTAL"!==o&&"SHEETVERSIONING"!==o||(a+="&submittalId="+s),"SHEETVERSIONING"===o&&(a+="&step=version"),a+="&agencyCode="+aa.getServiceProviderCode()}Dpr.log("getAcaDeepLinkUrl - missing submittalId")}else Dpr.log("getAcaDeepLinkUrl - acaUrl is required")}function getPlanRoomProjectLink(e,t){var r=settings.planRoomUrl+"?",o={};"SUMMARY"===t.pageId&&(o.page="summary"),"REVIEWPACKAGES"===t.pageId&&(o.page="submittals"),"PLANS"===t.pageId&&(o.page="sheets"),"DOCUMENTS"===t.pageId&&(o.page="docs"),"ISSUES"===t.pageId&&(o.page="issues"),"CONDITIONS"===t.pageId&&(o.page="conditions"),"APPROVED"===t.pageId&&(o.page="approved"),"SUBMITTALFILES"!==t.pageId&&"VERSIONING"!==t.pageId||(o.submittalId=t.submittalId,o.page="wizard","SUBMITTALFILES"===t.pageId&&(o.step="upload"),"VERSIONING"===t.pageId&&(o.step="version")),t.discipline&&0<t.discipline.length&&(o.discipline=encodeURIComponent(t.discipline)),o.project=e.getId(),o.number=e.getCustomID(),o.back="true",o.serviceProviderCode=aa.getServiceProviderCode();var s,a="";for(s in o)r+=a+s+"="+o[s],a="&";return r}function getFileTypes(){var e=[],t=aa.bizDomain.getBizDomain("DPR_FILE_TYPES");if(t.getSuccess())for(var r=t.getOutput(),o=0;o<r.size();o++){var s,a=r.get(o);a.getAuditStatus().equals("A")&&(s=a.getBizdomainValue(),a=a.getDescription(),s&&(a=fileTypeFromChoiceStrings(s,a),e.push(a)))}return e}function fileTypeFromChoiceStrings(e,t){var r={};if(r.id=e+"",r.name=e+"",r.role="document",0<(t=t?t+"":"").length)for(var o=t.split(";"),s=0;s<o.length;s++){var a=o[s].split("=");if(2!==a.length)return void Dpr.error("Invalid file type string: "+t);switch(a[0].trim().toLowerCase()){case"signed":r.signatureRequired=a[1].toLowerCase();break;case"role":r.role=a[1].toLowerCase();break;case"validateifsigned":r.forceValidation="yes"===a[1].toLowerCase();break;case"access":r.attributes=a[1].toLowerCase();break;case"tags":r.tags=a[1].toLowerCase();break;default:Dpr.error("Invalid token in file type string: "+a[0])}}return r}function getPrintSetTypes(){var e=[],t=aa.bizDomain.getBizDomain("DPR_PRINTSET_TYPES");if(t.getSuccess())for(var r=t.getOutput(),o=0;o<r.size();o++){var s,a=r.get(o);a.getAuditStatus().equals("A")&&(s=a.getBizdomainValue(),a=a.getDescription(),s&&(a=printSetTypeFromChoiceStrings(s,a),e.push(a)))}return e}function printSetTypeFromChoiceStrings(e,t){var r={};if(r.id=e+"",r.name=e+"",r.role="plan",0<(t=t?t+"":"").length)for(var o=t.split(";"),s=0;s<o.length;s++){var a=o[s].split("=");if(2!==a.length)return void Dpr.error("Invalid file printset type string: "+t);switch(a[0].trim().toLowerCase()){case"aca":r.aca=a[1].toLowerCase();break;case"role":r.role=a[1].toLowerCase();break;default:Dpr.error("Invalid token in printset type string: "+a[0])}}return r}function importApprovedDocument(e,t,r){t=t.getId()+"";Dpr.log("Import approved document sent for record: "+t);r=Dpr.sendPost(Dpr.getEndpoint()+"/projects/"+t+"/approved/imports",e,r);if(201===r.code)return r.body;throw new Error("Failed to import approved document: "+t+". Response code: "+r.code)}function getDocumentsForApprovedImport(e,t){t=t.getId()+"";Dpr.log("Get files eligible for approved import sent for record: "+t);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+t+"/approved/imports",e);if(200===e.code)return e.body;throw new Error("Failed to import approved document: "+t+". Response code: "+e.code)}function addChecklistSettings(e,t){t=Dpr.sendPost(Dpr.getEndpoint()+"/settings/submittals/checklists",e,t);if(201!==t.code)throw new Error("Failed to add checklists. Response code: "+t.code)}function getSubmittalChecklist(e,t,r){var o=t.getId()+"";Dpr.log("Get submittal checklist sent for project: "+t.getCustomID()+" and submittal: "+r);e=Dpr.sendGet(Dpr.getEndpoint()+"/projects/"+o+"/submittals/"+r+"/checklist",e);if(200===e.code)return e.body;if(404===e.code)return null;throw new Error("Failed to get submittal checklist for project: "+o+". Response code: "+e.code)}function getSubmittalChecklistNotification(e,t,r){var o="",s=Dpr.getSubmittalChecklist(e,t,r);if(s&&0<s.length){for(var a=0;a<s.length;a++)o+=s[a].passed?s[a].description+"(met), ":s[a].description+", ";o=o.substring(0,o.length-2)}return o}function updateSubmittalChecklist(e,t,r,o){var s=t.getId()+"";Dpr.log("Update submittal package checklist sent for: "+t.getCustomID());o=Dpr.sendPut(Dpr.getEndpoint()+"/projects/"+s+"/submittals/"+r+"/checklist",e,o);if(200!==o.code&&304!==o.code)throw new Error("Failed to update submittal checklist for project: "+s+" and submittal: "+r+". Response code: "+o.code)}Dpr.init=init,Dpr.setSettings=setSettings,Dpr.getApiKey=function(){return settings.apikey},Dpr.getEndpoint=function(){return settings.endpoint},Dpr.getAdminUser=function(){return settings.adminUser},Dpr.getSuperAgencyCode=function(){return settings.superAgencyCode},Dpr.getDbContext=function(){return settings.dbContext},Dpr.getEnvironment=function(){return settings.environment},Dpr.isDisciplineTask=isDisciplineTask,Dpr.getDisciplineSettings=getAllDisciplines,Dpr.acceptReviewPackages=acceptReviewPackages,Dpr.archiveFile=archiveFile,Dpr.archivePrintSet=archivePrintSet,Dpr.addChecklistSettings=addChecklistSettings,Dpr.addProject2ParentGroup=addProject2ParentGroup,Dpr.approveSheetsByDisciplineTask=approveSheetsByDisciplineTask,Dpr.cleanUpEmptyReviewPackages=cleanUpEmptyReviewPackages,Dpr.createProject=createProject,Dpr.moveProject=moveProject,Dpr.createTemplatePrintSets=createTemplatePrintSets,Dpr.createDocumentsPrintSet=createDocumentsPrintSet,Dpr.createSheetsPrintSet=createSheetsPrintSet,Dpr.createProjectGroup=createProjectGroup,Dpr.createProjectGroupItems=createProjectGroupItems,Dpr.createProjectIssue=createProjectIssue,Dpr.createProjectPlusSubmittal=createProjectPlusSubmittal,Dpr.createSubmittalPackage=createSubmittalPackage,Dpr.deleteFile=deleteFile,Dpr.deletePrintSet=deletePrintSet,Dpr.deleteProjectFromAllGroups=deleteProjectFromAllGroups,Dpr.deleteProjectStamp=deleteProjectStamp,Dpr.deleteProjectStamps=deleteProjectStamps,Dpr.deleteReviewPackage=deleteReviewPackage,Dpr.getDocumentsForApprovedImport=getDocumentsForApprovedImport,Dpr.projectActive=projectActive,Dpr.projectExists=projectExists,Dpr.getAllProjectDisciplines=getAllProjectDisciplines,Dpr.getAvailableProjectStamps=getAvailableProjectStamps,Dpr.getProjectSheetStamps=getProjectSheetStamps,Dpr.getConditions=getConditions,Dpr.getDisciplineByWorkflowTask=getDisciplineByWorkflowTask,Dpr.getAcaDeepLinkUrl=getAcaDeepLinkUrl,Dpr.getIssues=getIssues,Dpr.getFileInfo=getFileInfo,Dpr.getFiles=getFiles,Dpr.getFilesFromDocuments=getFilesFromDocuments,Dpr.getFilesPendingArchive=getFilesPendingArchive,Dpr.getDocumentsFromFiles=getDocumentsFromFiles,Dpr.getFileTypes=getFileTypes,Dpr.getPrintSetTypes=getPrintSetTypes,Dpr.getLatestProjectSubmittal=getLatestProjectSubmittal,Dpr.getOpenConditionsCount=getOpenConditionsCount,Dpr.getOpenIssueDisciplines=getOpenIssueDisciplines,Dpr.getOpenIssuesCount=getOpenIssuesCount,Dpr.getOpenNotesCount=getOpenNotesCount,Dpr.getPackageSheetCount=getPackageSheetCount,Dpr.getPlanRoomProjectLink=getPlanRoomProjectLink,Dpr.getPrintSets=getPrintSets,Dpr.getPrintSet=getPrintSet,Dpr.getPrintSetsPendingArchive=getPrintSetsPendingArchive,Dpr.getApprovedPlans=getApprovedPlans,Dpr.getApprovedDocuments=getApprovedDocuments,Dpr.getReportPrintsets=getReportPrintsets,Dpr.getProjectDocuments=getProjectDocuments,Dpr.getProjectGroup=getProjectGroup,Dpr.getProjectGroupItems=getProjectGroupItems,Dpr.getProjectGroups=getProjectGroups,Dpr.getProject=getProject,Dpr.getProjects=getProjects,Dpr.createProjectProperties=createProjectProperties,Dpr.updateProjectProperties=updateProjectProperties,Dpr.getProjectFile=getProjectFile,Dpr.getProjectFiles=getProjectFiles,Dpr.isAllProjectSubmittalFilesProcessed=isAllProjectSubmittalFilesProcessed,Dpr.getProjectProperties=getProjectProperties,Dpr.getProjectSheetViews=getProjectSheetViews,Dpr.getSheetSummary=getSheetSummary,Dpr.getProjectSubmittal=getProjectSubmittal,Dpr.getProjectSubmittals=getProjectSubmittals,Dpr.getReviewTasks=getReviewTasks,Dpr.getSubmittalChecklist=getSubmittalChecklist,Dpr.getSubmittalChecklistNotification=getSubmittalChecklistNotification,Dpr.getSubmittalFiles=getSubmittalFiles,Dpr.getVersion=getVersion,Dpr.sendError=sendError,Dpr.hasOpenConditions=hasOpenConditions,Dpr.hasOpenIssues=hasOpenIssues,Dpr.hasIssuesIn=hasIssuesIn,Dpr.importApprovedDocument=importApprovedDocument,Dpr.isOpenSubmittals=isOpenSubmittals,Dpr.isSubmittalEmpty=isSubmittalEmpty,Dpr.hasProjectSheets=hasProjectSheets,Dpr.hasProjectGroupSheets=hasProjectGroupSheets,Dpr.getProjectSheets=getProjectSheets,Dpr.publishConditions=publishConditions,Dpr.publishIssues=publishIssues,Dpr.reOrderProjectSheets=reOrderProjectSheets,Dpr.updateProject=updateProject,Dpr.updateProjectDocument=updateProjectDocument,Dpr.updateProjectIssue=updateProjectIssue,Dpr.updateProjectSheetsApprovals=updateProjectSheetsApprovals,Dpr.updateProjectSubmittal=updateProjectSubmittal,Dpr.updateSheet=updateSheet,Dpr.getWatermarkSettings=getWatermarkSettings,Dpr.updateWatermarkSettings=updateWatermarkSettings,Dpr.updateSubmittalChecklist=updateSubmittalChecklist,Dpr.updatePackageSheets=updatePackageSheets,Dpr.getPackageSheets=getPackageSheets,Dpr.getSheetSetOrders=getSheetSetOrders,Dpr.updateSheetSetOrder=updateSheetSetOrder,Dpr.getAvailableDocumentsForImport=getAvailableDocumentsForImport,Dpr.addSupportingDocumentsForImport=addSupportingDocumentsForImport,Dpr.getStagedDocumentsForImport=getStagedDocumentsForImport,Dpr.importValidatedSupportingDocuments=importValidatedSupportingDocuments}(),Dpr.Actions={},Dpr.Custom={},function(){function l(e,t){if(t)for(var r in t)!e.hasOwnProperty(r)||"object"!=typeof e[r]||Array.isArray(e[r])||"object"!=typeof t[r]||Array.isArray(t[r])?e[r]=t[r]:l(e[r],t[r])}function r(e,t){e=function e(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return(r=new Date).setTime(t.getTime()),r;if(t instanceof Array){for(var r=[],o=0,s=t.length;o<s;o++)r[o]=e(t[o]);return r}if(t instanceof Object){for(var a in r={},t)t.hasOwnProperty(a)&&(r[a]=e(t[a]));return r}throw new Error("Unable to copy obj! Its type isn't supported.")}(e);return l(e,t),e}Dpr.OFF=void 0,Dpr.Actions.NOTIFICATIONS_SECTION="notifications",Dpr.Actions.PRINTSETS_SECTION="printSets",Dpr.Actions.PROJECT_GROUPS_SECTION="projectGroups",Dpr.Actions.SETTINGS_SECTION="settings",Dpr.Actions.REPORTS_SECTION="reports",Dpr.Actions.APPLICATION_RECEIVED_NOTIFICATION="applicationReceived",Dpr.Actions.REVISION_REQUEST_RECEIVED_NOTIFICATION="revisionRequestReceived",Dpr.Actions.FILE_VALIDATION_ISSUES_NOTIFICATION="fileValidationIssues",Dpr.Actions.FILE_VALIDATION_ISSUES_REMINDER_NOTIFICATION="fileValidationIssuesReminder",Dpr.Actions.PLANS_RECEIVED_NOTIFICATION="plansReceived",Dpr.Actions.ADDITIONAL_INFO_REQUIRED_NOTIFICATION="additionalInfoRequired",Dpr.Actions.REVISIONS_RECEIVED_NOTIFICATION="revisionsReceived",Dpr.Actions.REVIEW_PACKAGE_SUBMITTED_STAFF_NOTIFICATION="reviewPackageSubmittedStaff",Dpr.Actions.DISCIPLINE_REVIEW_REJECTED_NOTIFICATION="disciplineReviewRejected",Dpr.Actions.PLAN_REVIEW_REJECTED_NOTIFICATION="planReviewRejected",Dpr.Actions.PLAN_REVIEW_APPROVED_NOTIFICATION="planReviewApproved",Dpr.Actions.REVISION_REQUEST_ACCEPTED_NOTIFICATION="revisionRequestAccepted",Dpr.Actions.REVISION_REQUEST_APPROVED_NOTIFICATION="revisionRequestApproved",Dpr.Actions.FILE_PROCESSING_COMPLETE_NOTIFICATION="fileProcessingComplete",Dpr.Actions.FILE_PROCESSING_COMPLETE_STAFF_NOTIFICATION="fileProcessingCompleteStaff",Dpr.Actions.SUBMIT_PLANS_REMINDER_NOTIFICATION="submitPlansReminder",Dpr.Actions.SUBMIT_REVISED_PLANS_REMINDER_NOTIFICATION="submitRevisedPlansReminder",Dpr.Actions.ERROR_NOTIFICATION="error",Dpr.Actions.REQUEST_NOTIFICATION="request",Dpr.Actions.ATTACHMENT_UPLOAD_NOTIFICATION="attachmentUpload",Dpr.Actions.SEND_TO_ALL_CONTACTS="allContacts",Dpr.Actions.SEND_TO_PRIMARY_CONTACT="primaryContact",Dpr.Actions.SEND_TO_CONTACTS="contacts",Dpr.Actions.SEND_TO_PRIMARY_CONTACTS="contactsPrimary",Dpr.Actions.SEND_TO_PROFESSIONALS="professionals",Dpr.Actions.SEND_TO_PRIMARY_PROFESSIONALS="professionalsPrimary",Dpr.Actions.SEND_TO_USER="user",Dpr.Actions.SEND_TO_NONE="none",Dpr.Actions.FAILED_POSSIBLE_RETRY_CODES=["FP002","FR002"];var e={pendingInitialStatus:"Awaiting Plans",pendingRevisionStatus:"Awaiting Revisions",voidAppStatuses:["Void","Withdrawn"],approvedConditionCheck:!0,partialApprovedConditionCheck:!0,autoAccept:!(Dpr.Actions.FAILED_FILE_ISSUE_CODES=["FP001","FR001"]),submittalOmits:!1,submittalDocumentTypesSync:!1,sendMidCycleSubmittedNotification:!1,type:"cycles",autoRouteResubmittal:!1,autoRouteCorrectionRequired:!1,deleteReportPrintsets:!1,issueApprovedDocs:!1,workflow:{application:{tasks:["Application Submittal","Application Acceptance","Application Intake"],actions:{receive:{statuses:["Plans Received"],wtua:"sendPlansReceivedNotification"},reopen:{statuses:["Additional Info Required"],wtua:["reOpenLatestReviewPackage","sendReOpenNotification"],validate:"onValidateApplicationReOpen"},review:{statuses:["Accepted - Plan Review Req"],wtua:"cleanAcceptReviewPackages",validate:"onValidateApplicationReview"},noreview:{statuses:["Accepted - Plan Review Not Req","Plan Review Not Required"],wtua:"cleanAcceptReviewPackages",validate:"onValidateApplicationReview"},terminate:{statuses:["Withdrawn","Void","Abandoned","Cancelled"],wtua:[{action:"updateProjectStatus",options:{status:"closed"}},"removeProjectFromGroups","deleteOpenReviewPackages"]},alert:{statuses:["File Validation Issues"],wtua:"sendFileValidationIssuesNotification"}},page:"REVIEWPACKAGES"},distribution:{tasks:["Plans Distribution"],actions:{receive:{statuses:["Revisions Received","Corrections Received"],wtua:["sendRevisionsReceivedNotification","sendReviewPackageSubmittedStaffNotification","autoRouteResubmittal"]},reopen:{statuses:["Additional Info Required"],wtua:["reOpenLatestReviewPackage","sendReOpenNotification"],validate:"onValidateApplicationReOpen"},route:{statuses:["Routed for Review","Accepted"],wtua:[{action:"updateProjectStatus",options:{status:"inreview"}},"cleanAcceptReviewPackages"],validate:"onValidateDistributionRoute"},noreview:{statuses:["Accepted - Plan Review Not Req","Plan Review Not Required"],wtua:"cleanAcceptReviewPackages"},terminate:{statuses:["Withdrawn","Void","Abandoned","Cancelled"],wtua:[{action:"updateProjectStatus",options:{status:"closed"}},"removeProjectFromGroups","deleteOpenReviewPackages"]},alert:{statuses:["File Validation Issues"],wtua:"sendFileValidationIssuesNotification"}},page:"REVIEWPACKAGES"},coordination:{tasks:["Plans Coordination"],actions:{revise:{statuses:["Revisions Required","Corrections Required"],wtua:["publishConditionsAll","createNewCyclePackageAndPublishIssues",{action:"updateProjectStatus",options:{status:"notapproved"}},"sendReviewCycleNotApprovedNotification","resetRevisionIntakeTask"],validate:"onValidateCoordinationRevise"},ready:{statuses:["Ready to Issue"],wtua:[{action:"updateProjectStatus",options:{status:"approved"}},"publishIssuesAll","publishConditionsAll","createApprovedTemplatePrintsets","createApprovedPlans","createApprovedSupportingDocuments","deleteReportPrintsets"],validate:"onValidateCoordinationReady"},terminate:{statuses:["Withdrawn","Void","Abandoned","Cancelled"],wtua:[{action:"updateProjectStatus",options:{status:"closed"}},"removeProjectFromGroups","deleteOpenReviewPackages"]}},page:"ISSUES"},active:{tasks:["Inspection"],actions:{receive:{statuses:["Revision Received"],wtua:["sendRevisionsReceivedNotification","sendReviewPackageSubmittedStaffNotification"]}},page:"APPROVED"},complete:{tasks:["Certificate of Occupancy"],actions:{co:{statuses:["Final CO Issued"],wtua:{action:"updateProjectStatus",options:{status:"closed"}}}},page:"APPROVED"},review:{actions:{revise:{statuses:["Revisions Required","Corrections Required"],wtua:["onWtuaReviewRevise","autoRouteCorrectionRequired"],validate:"onValidateReviewRevise"},approve:{statuses:["Approved"],wtua:["publishConditionsTask","approveSheetsByDiscipline","autoRouteCorrectionRequired"],validate:"onValidateReviewApprove"},partialapprove:{statuses:["Approved w/Comments","Approved with Comments","Approved as Noted"],wtua:["publishConditionsTask","approveSheetsByDiscipline","autoRouteCorrectionRequired"],validate:"onValidateReviewPartialApprove"},receive:{statuses:["Revisions Received","Corrections Received"],wtua:"onWtuaReviewReceive"},filter:{statuses:["Not Required","Not Applicable","Not Needed"],wtua:["publishConditionsTask","approveSheetsByDiscipline","autoRouteCorrectionRequired"],validate:"onValidateReviewApprove"}},page:"PLANS"}},ctrca:{actions:["cloneCheck","excludeRecordCheck","setDefaultSubmissionStatus","linkMasterPlans","createProjectPlusSubmittal","sendApplicationReceivedNotification"]},asua:{actions:"onApplicationStatusUpdateAfterDefault"},asiua:{actions:"onApplicationSpecificInfoUpdateAfterDefault"},adua:{actions:"onApplicationDetailUpdateAfterDefault"},submit:{actions:["onSubmittalFinished","onSubmittalFinishedSync","midCycleSubmittedNotification"]},psab:{actions:["updateProjectProperties"]},psaa:{actions:["sendApprovedTemplateNotification","issueApprovedDocs"]},paa:{actions:["sendApprovedPlansNotification"]},daa:{actions:["sendApprovedDocumentsNotification","issueApprovedDocs"]},rsra:{actions:["onReportServiceRunAfterDefault"]},attachment:{actions:["onAttachmentNotification"]},psarchive:{actions:[]},delete:{actions:["removeProjectFromGroups","deleteProject"]}},d={processes:{default:e,opencycles:r(e,{type:"opencycles",workflow:{review:{actions:{revise:{wtua:["publishConditionsTask","publishIssuesTask","sendDisciplineReviewRejectedNotification","autoRouteCorrectionRequired"]},approve:{wtua:["publishIssuesTask","publishConditionsTask","approveSheetsByDiscipline","autoRouteCorrectionRequired"]},partialapprove:{wtua:["publishIssuesTask","publishConditionsTask","approveSheetsByDiscipline","autoRouteCorrectionRequired"]}}}}}),swimlanes:r(e,{type:"swimlanes",workflow:{review:{actions:{revise:{wtua:["publishConditionsTask","createNewDisciplineCyclePackageAndPublishIssues","sendDisciplineReviewRejectedNotification"]},approve:{wtua:["publishIssuesTask","publishConditionsTask","approveSheetsByDiscipline"]},partialapprove:{wtua:["publishIssuesTask","publishConditionsTask","approveSheetsByDiscipline"]},receive:{wtua:"receiveReviewPackageSwimlanes"},reopen:{statuses:["Additional Info Required"],wtua:"reOpenLatestReviewPackageSwimlanes"},route:{statuses:["Accept Plans","Continue Review"],wtua:"acceptReviewPackagesSwimlanes",validate:"onValidateReviewRouteSwimlanes"}}},coordination:{actions:{revise:{wtua:"onWtuaCoordinationReviseSwimlanes"}}}},submit:{actions:["onSubmittalFinishedSwimlanes","onSubmittalFinishedSync","midCycleSubmittedNotification"]}}),revision:r(e,{type:"revision",workflow:{application:{actions:{review:{wtua:["cleanAcceptReviewPackages","assignRevisionNumber","processProjectRevisionGroup"],validate:"onValidateApplicationReviewRevision"}}},coordination:{actions:{revise:{wtua:"runParentStepCoordination"},ready:{wtua:[{action:"updateProjectStatus",options:{status:"approved"}},"publishIssuesAll","publishConditionsAll","createApprovedTemplatePrintsets","createApprovedPlansRevision",{action:"createApprovedSupportingDocuments",options:{parent:!0}}]}}},review:{actions:{revise:{wtua:"runParentStepReview"},receive:{wtua:"runParentStepReview"},approve:{wtua:"runParentStepReview"},partialapprove:{wtua:"runParentStepReview"},reopen:{statuses:["Additional Info Required"],wtua:"runParentStepReview"},route:{statuses:["Accept Plans","Continue Review"],wtua:"runParentStepReview"}}}},ctrca:{actions:["setDefaultSubmissionStatus","getRevisionParent","createParentProject","copyReferenceDataToChild","createProjectPlusSubmittal","processProjectRevisionGroup","editRevisionApplicationName","sendRevisionRequestReceivedNotification"]},submit:{actions:["onSubmittalFinishedRevision","onSubmittalFinishedSync","midCycleSubmittedNotification"]}})},settings:{default:{}},projectGroups:{default:{revision:{prefix:"Revision Group"},approved:{prefix:"Approved Plans"}}},printSets:{default:{approvedTemplate:{template:void 0},approvedPlans:{namePrefix:"APPROVED-",descriptionPrefix:"Approved plans for ",type:"Approved Plans",watermarks:void 0,fields:void 0,includeStamps:!0,includeConditions:!0,includeNotes:!1},approvedDocuments:{combined:!0,namePrefix:"APPROVED DOCUMENTS-",descriptionPrefix:"Approved documents for ",type:"Approved Supporting Documents",watermarks:void 0,fields:void 0,includeStamps:!0,includeConditions:!0,includeNotes:!1}}},reports:{default:{imports:void 0}},notifications:{default:{from:void 0,combined:"yes",acaUrl:void 0,aaUrl:void 0,emails:{applicationReceived:{template:"DPR_APPLICATION_RECEIVED",to:"allContacts"},submitPlansReminder:{template:"DPR_REMINDER_SUBMIT_INITIAL_PLANS",to:"allContacts"},submitRevisedPlansReminder:{template:"DPR_REMINDER_SUBMIT_REVISED_PLANS",to:"allContacts"},fileProcessingComplete:{template:"DPR_FILE_PROCESSING_COMPLETE",to:"allContacts"},fileProcessingCompleteStaff:{template:"DPR_FILE_PROCESSING_COMPLETE_STAFF",to:"user"},fileValidationIssues:{template:"DPR_FILE_VALIDATION_ASSISTANCE_NOTIFICATION",to:"user"},fileValidationIssuesReminder:{template:"DPR_FILE_VALIDATION_ASSISTANCE_NOTIFICATION",to:"allContacts"},plansReceived:{template:"DPR_PLANS_RECEIVED",to:"allContacts"},reviewPackageSubmittedStaff:{template:"DPR_REVIEW_PACKAGE_SUBMITTED_STAFF",to:"user"},additionalInfoRequired:{template:"DPR_ADDITIONAL_INFO_NEEDED",to:"allContacts"},disciplineReviewRejected:{template:"DPR_DISCIPLINE_REVIEW_REJECTED",to:"allContacts"},planReviewRejected:{template:"DPR_PLAN_REVIEW_COMPLETE_REJECTED",to:"allContacts"},revisionsReceived:{template:"DPR_REVISED_PLANS_RECEIVED",to:"allContacts"},planReviewApproved:{template:"DPR_PLAN_REVIEW_COMPLETE_APPROVED",to:"allContacts"},revisionRequestReceived:{template:"DPR_REVISION_REQUEST_RECEIVED",to:"allContacts"},revisionRequestAccepted:{template:"DPR_REVISION_REQUEST_ACCEPTED",to:"allContacts"},revisionRequestApproved:{template:"DPR_REVISION_REQUEST_APPROVED",to:"allContacts"},error:{template:"DPR_ERROR"},correctionsRequiredGoLive:{template:"DPR_CORRECTIONS_REQUIRED_GO_LIVE"}},adhocTasks:{},fields:{}}}};function D(e,t){return"string"==typeof e||e instanceof String?p(t,e):"function"==typeof e?e(t):e}function S(e,t,r){return"object"==typeof e?p(t,e.action,r):"function"==typeof e?e(t,r):e}function v(e,t){e=e.module&&e.module.toLowerCase();if(d[t])return e&&d[t][e]?r(d[t].default,d[t][e]):d[t].default}function u(e,t){var r=[];if(t.fields){var o=t.fields.map(function(e){return e.field}),s=Dpr.getCustomFields(e.capId,o);if(s)for(var a=0;a<s.length;a++){var n=s[a],i=function(e,t){for(var r=0;r<e.length;r++)if(e[r].field===t)return e[r]}(t.fields,n.name);!i||null===n.value&&void 0===i.default||r.push({description:n.name,name:i.name,value:n.value||i.default})}}return t.action&&(e=D(t.action,e),r=r.concat(e)),r.length?r:void 0}function c(e,t,r){var o=(r=r||v(e,Dpr.Actions.NOTIFICATIONS_SECTION)).emails[t];if(o&&!o.disabled){var s={};return s.id=t,s.email=o,s.combined=o.combined||r.combined,s.to=r.to||o.to,s.cc=o.cc,s.aaUrl=r.aaUrl,s.acaUrl=r.acaUrl,s.from=r.from,s.fields=D(r.fields,e),s.attachments=r.attachments,s}}function g(e,t,r){var o,s,a,n,i,p,c=e.capId,u=e.cap,d=e.module;t.fields||(t.fields={}),r&&("object"==typeof r&&l(t.fields,r),c&&"function"==typeof r&&(o=r(e,t),l(t.fields,o))),t.fields.env=Dpr.getEnvironment(),t.fields.agency=aa.getServiceProviderCode()+"",c&&(t.fields.altID=c.getCustomID()+"",s=u.getSpecialText(),t.fields.capName=s?s+"":"",t.fields.acaUrl=t.acaUrl,r=Dpr.getRecordPrimaryAddress(c),t.fields.addressLine=r&&r.address?r.address:"No primary address listed",t.fields.contactname=function(e){for(var t=Dpr.getContacts(e),r="",o=0;o<t.length;o++)if(t[o].fullName&&t[o].fullName.length&&t[o].isPrimary){r=t[o].fullName;break}return r}(c),t.fields.workDesc=Dpr.getWorkDescription(c),t.fields.acaRecordUrl=(p=t.acaUrl,p+="/Cap/CapDetail.aspx?",p+="Module="+d,p+="&TabName="+d,p+="&capID1="+c.ID1+"&capID2="+c.ID2+"&capID3="+c.ID3,p+="&agencyCode="+aa.getServiceProviderCode()),t.fields.aaRecordLink=(a=c,n=d,i=t.aaUrl,i+="/portlets/cap/capsummary/CapTabSummary.do?mode=tabSummary&serviceProviderCode=",i+=aa.getServiceProviderCode(),i+="&ID1="+a.ID1,i+="&ID2="+a.ID2,i+="&ID3="+a.ID3,i+="&requireNotice=YES&clearForm=clearForm&module="+n,i+="&isFromCapList=true&isGeneralCAP=Y"),o=t,s=(u=e).capId,r=u.module,o.fields.planRoomProjectLink=o.aaUrl+Dpr.getPlanRoomProjectLink(s,{pageId:"SUMMARY"}),u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"ISSUESLIST"),o.fields.dprIssuesLink=u||o.acaUrl,u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"CONDITIONSLIST"),o.fields.dprConditionsLink=u||o.acaUrl,u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"NOTESLIST"),o.fields.dprNotesLink=u||o.acaUrl,u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"APPROVEDPLANS"),o.fields.dprApprovedPlansLink=u||o.acaUrl,u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"UPLOADS"),o.fields.dprUploadsLink=u||o.acaUrl,u=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"ATTACHMENTS"),o.fields.dprAttachmentsLink=u||o.acaUrl,o.fields.submittalId&&(r=Dpr.getAcaDeepLinkUrl(s,r,o.acaUrl,"RESUMESUBMITTAL",o.fields.submittalId),o.fields.dprNewReviewPackageLink=r||o.acaUrl,s=Dpr.getPlanRoomProjectLink(s,{pageId:"SUBMITTALFILES",submittalId:o.fields.submittalId}),o.fields.planRoomProjectLink=o.aaUrl+s)),t.email.fields&&(e=S(t.email.fields,e,t),l(t.fields,e))}function f(e,t){var a,r=e.capId,o=e.user,s="";function n(e,t,r){var o="";a=a||Dpr.getContacts(e);for(var s=0;s<a.length;s++)a[s].email&&a[s].email.length&&(t&&!a[s].isPrimary||r&&r.trim().toLowerCase()!==a[s].type.trim().toLowerCase()||(o+=a[s].email+"; "));return o}function i(e,t){var r="",o=aa.licenseProfessional.getLicensedProfessionalsByCapID(e).getOutput();if(o)for(var s in o)t&&!o[s].getPrintFlag().equals("Y")||(s=o[s].getEmail())&&(r+=s+"; ");return r}t.to=[].concat(t.to);for(var p,c,u,d,l=0;l<t.to.length;l++){var g=(p=r,c=t.to[l],u=void 0,d="",c===Dpr.Actions.SEND_TO_ALL_CONTACTS||c===Dpr.Actions.SEND_TO_PRIMARY_CONTACT?(d=n(p,c===Dpr.Actions.SEND_TO_PRIMARY_CONTACT),d+=i(p,c===Dpr.Actions.SEND_TO_PRIMARY_CONTACT)):c===Dpr.Actions.SEND_TO_CONTACTS||c===Dpr.Actions.SEND_TO_PRIMARY_CONTACTS?d=n(p,c===Dpr.Actions.SEND_TO_PRIMARY_CONTACTS):c===Dpr.Actions.SEND_TO_PROFESSIONALS||c===Dpr.Actions.SEND_TO_PRIMARY_PROFESSIONALS?d=i(p,c===Dpr.Actions.SEND_TO_PRIMARY_PROFESSIONALS):c===Dpr.Actions.SEND_TO_USER?(u=Dpr.getUserEmail(o))?d=u:0===o.indexOf("PUBLICUSER")&&(d=n(p,!1),d+=i(p,!1)):c&&(u=S(c,e,t),d=(u=(u=Array.isArray(u)?u.join(";"):u)&&-1===u.indexOf("@")&&u.toLowerCase()!==Dpr.Actions.SEND_TO_NONE.toLowerCase()?n(p,!1,c):u)||Dpr.Actions.SEND_TO_NONE),d);g&&(s+=g)}return(s=function(e){for(var t=[],r=e.split(";"),o=0;o<r.length;o++){var s=r[o].trim().toLowerCase();s&&-1===t.indexOf(s)&&t.push(s)}return t}(s))||(s=Dpr.Actions.SEND_TO_NONE,Dpr.error("No contacts found for notification: "+t.id)),s}function m(e,t,r){var o=e.capId;g(e,t,r);var s=null;if(t.fields)for(var a in s=aa.util.newHashtable(),t.fields)t.fields.hasOwnProperty(a)&&s.put("$$"+a+"$$",t.fields[a]);var n=t.email.attachments&&"function"==typeof t.email.attachments?t.email.attachments(e,t):[],i=(r=S((r=t).cc,e,r))||"",p=o?f(e,t):t.to,c=function(e,t){if(!(e=S(t.from,e,t)))throw new Error("From is not set or unsupported: "+t.from);return e}(e,t),u=function(e,t){if(!(e=S(t.email.template,e,t)))throw new Error("Template is not set or unsupported: "+t.email.template);return e}(e,t);if(p&&p!==Dpr.Actions.SEND_TO_NONE)if("yes"===t.combined.toLowerCase())Dpr.sendEmail(o,c,p,i,u,s,n);else if(p&&0<p.length)for(var d=0;d<p.length;d++)p[d]&&-1<p[d].indexOf("@")&&Dpr.sendEmail(o,c,p[d],i,u,s,n)}function a(e,t){e=v(e,Dpr.Actions.NOTIFICATIONS_SECTION);return e.adhocTasks[t]||e.emails[t]&&!e.emails[t].disabled}function A(e,t,r,o){var s=v(e,Dpr.Actions.NOTIFICATIONS_SECTION);try{var a=c(e,t,s);a&&m(e,a,r)}catch(e){Dpr.log("Failed to send "+t+" email notification: "+e.message+(e.stack?"\nStack: "+e.stack:""))}if(o&&s.adhocTasks[t])try{!function(e,t,r,o){var s=e.capId;if(s){var a=Dpr.getTasks(s,[t.task],!0);0===a.length&&(Dpr.addAdHocTask(t.adhocProcess,t.task,r,Dpr.getAdminUser(),s),a=Dpr.getTasks(s,[t.task],!0));for(var n=0;n<a.length;n++)Dpr.updateTaskItem(s,Dpr.getAdminUser(),a[n],t.initialStatus,o,r)}}(e,s.adhocTasks[t],o.note,o.comment)}catch(e){Dpr.log("Failed to send "+t+" adhoc: "+e.message+(e.stack?"\nStack: "+e.stack:""))}}function E(e,t,r){return S(t,e,r)}function n(e,t){return S(t,e)}function P(e,t){return S(t,e)}function R(e,t){return S(t,e)}function C(e,t){return S(t,e)}function h(e,t){return S(t,e)}function T(e,t){return D(t,e)}function w(e,t){return D(t,e)}function I(e,t,r){var o,s=e.actions;for(o in s)if(s.hasOwnProperty(o)){var a=s[o];if(a.statuses&&Dpr.matches(t.taskStatus,a.statuses))return r?void(a.validate&&("string"==typeof a.validate||a.validate instanceof String?p(t,a.validate):a.validate(t))):void N(a.wtua,t)}return 1}function t(e,t){var r=e.capId,o=Dpr.getParentRecord(r),r=aa.cap.getCap(o).getOutput().getCapType().toString()+"",o=Dpr.getProjectType(r),r=o.process&&d.processes[o.process]?d.processes[o.process]:d.processes.default;Dpr.log("Parent process is: "+o.process),r.workflow[t]&&I(r.workflow[t],e)}function p(e,t,r){var o,s;if(s=-1===t.indexOf(".")?(s=Dpr.Custom[t])||Dpr.Actions[t]:(o=t.split("."),Dpr[o[1]][o[2]]))return s(e,r);throw new Error("Action: "+t+" is not registered.")}function N(e,t){if(e){if(e instanceof Array)for(var r=0;r<e.length;r++){var o=e[r];if("object"==typeof o&&o.action?"string"==typeof o.action||o.action instanceof String?p(t,o.action,o.options):o.action(t,o.options):"string"==typeof o||o instanceof String?p(t,o):o(t),t.abort)break}else"object"==typeof e&&e.action?"string"==typeof e.action||e.action instanceof String?p(t,e.action,e.options):e.action(t,e.options):"string"==typeof e||e instanceof String?p(t,e):e(t);return 1}}function O(e,t){if(e.rawType){if(!e.rawType.id)throw new Error("Project type id not set in context.");if(!e.rawType.raw)throw new Error("Project type properties not set in context.");var r=Dpr.parseSetting(e.rawType.raw+"");r.id=e.rawType.id,e.projectType=r,t&&(e.cap=aa.cap.getCap(e.capId).getOutput(),e.module=e.cap.getCapModel().getModuleName()+"",e.capType=e.cap.getCapType().toString()+""),e.process=r.process&&d.processes[r.process]?d.processes[r.process]:d.processes.default,Dpr.log("Business process: "+r.process),e.rawType=void 0}return e}function k(e,t){return"<a href='"+e+"' target='_blank' style='text-decoration: none;''><div style='background-color: #39444d;border: none;color: white;padding: 15px 32px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin-bottom: 10px'>"+t+"</div></a>"}function o(e){Dpr.isOpenSubmittals(e.user,e.capId,null,null,["ACCEPTED"])||(e.newStatus.message="Review package has already been accepted, and cannot be ReOpened.");e.comment.required=!0,e.comment.message="Please provide the comment to be sent to the customer."}function _(e){function t(){var e=aa.env.getValue("ApplicationTypeLevel1"),t=aa.env.getValue("ApplicationTypeLevel2"),r=aa.env.getValue("ApplicationTypeLevel3"),o=aa.env.getValue("ApplicationTypeLevel4"),s="";return s+=e?e+"/":"",s+=t?t+"/":"",s+=r?r+"/":"",s+=o?o+"/":""}if(e.process&&e.process.ctrca){var r=e.process.ctrca;r&&r.actions&&N(r.actions,e)}else if(null!==Dpr.getProjectType(t()))throw new Error("Unable to retrieve process config for: "+t())}function b(e){var t=e.process.delete;t&&t.actions&&N(t.actions,e)}function y(e){var t=e.capId,r=e.user;if(Dpr.projectActive(r,t)){var o,s=e.process.workflow;for(o in s)if(s.hasOwnProperty(o)){var a=s[o];if("review"===o&&Dpr.isDisciplineTask(e.taskName)){if(!I(a,e))return}else if(a.tasks&&Dpr.matches(e.taskName,a.tasks)&&!I(a,e))return}}}function j(e){var t=e.capId,r=e.user,o=e.process.inspections;if(o&&Dpr.projectActive(r,t))for(var s in o)if(o.hasOwnProperty(s)){s=o[s];if(s.types&&Dpr.matches(e.inspectionType,s.types)&&!function(e,t){var r,o=e.actions.irsa;for(r in o)if(o.hasOwnProperty(r)){var s=o[r];if(s.results&&Dpr.matches(t.inspectionResult,s.results))return void N(s.actions,t)}return 1}(s,e))return}}function s(e){var t,r=e.capId,o=Dpr.getAdminUser(),s=v(e,Dpr.Actions.SETTINGS_SECTION);if((t=s&&s.properties?u(e,s.properties):t)&&Dpr.projectExists(o,r)){for(var a=Dpr.getProjectProperties(o,r),n=[],i=[],p=0;p<t.length;p++){var c=t[p];(function(e,t){for(var r=0;r<e.length;r++)if(e[r].name===t)return e[r]}(a,c.name)?i:n).push(c)}0<n.length&&Dpr.createProjectProperties(o,r,n),0<i.length&&Dpr.updateProjectProperties(o,r,i)}}function U(e,t,r,o,s){var a,n,i=e.capId,p=e.user;t.getActiveFlag().equals("Y")&&(a=t.getTaskDescription()+"",n=t.getProcessCode()+"",e=t.getProcessID()+"",(n=Dpr.getMatchingStatusForTask(i,a,n,r))||"N"===s.toUpperCase()?t.getDisposition()+""!==n?n&&"N"!==s.toUpperCase()?(Dpr.updateTaskItem(i,Dpr.getAdminUser(),t,n,o,""),Dpr.triggerWtuaEvent(i,p,a,n,e)):Dpr.updateTaskItem(i,Dpr.getAdminUser(),t,r[0],"","","","U"):Dpr.error("Unable to update the workflow. Task: "+a+". Task is already in status: "+n+"."):Dpr.error("Unable to update the workflow. Task: "+a))}function F(e){if("amend"===(t=e).type&&t.process.submittalOmits)Dpr.log("Submittal action suppressed");else{var t,r=e.capId,a=e.process.workflow,o=e.user,s=e.ready;e.user=Dpr.getAdminUser();var n="Y"===s.toUpperCase()?d("receive",["review"]):d("notready",["review"]),i=function(e,t){for(var r=[],o=0;o<t.length;o++)r=r.concat(a[t[o]].tasks);return Dpr.getTasks(e,r,!0)}(r,n);if(i.length){i=i[0],n=function(e,t){for(var r=0;r<t.length;r++){var o=t[r];if(Dpr.matches(e,a[o].tasks))return a[o]}}(i.getTaskDescription()+"",n);U(e,i,"Y"===s.toUpperCase()?n.actions.receive.statuses:n&&n.actions&&n.actions.notready&&n.actions.notready.statuses?n.actions.notready.statuses:[],"Review package submitted by: "+o,s)}else{var p=Dpr.getReviewTasks(r),c="Y"===s.toUpperCase()?a.review.actions.receive.statuses:a.review.notready&&a.review.notready.statuses?a.review.actions.notready.statuses:[];if(c&&0<c.length)for(var u=0;u<p.length;u++)U(e,p[u],c,"Review package submitted by: "+o,s)}}function d(e,t){var r,o=[];for(r in a)if(!Dpr.matches(r,t))for(var s in a[r].actions)s===e&&o.push(r);return o}}function L(e,t){var r=e.capId,o=Dpr.getAdminUser(),e=t&&t.submittalId?t.submittalId:e.submittalId||Dpr.getLatestProjectSubmittal(o,r).id;if(e){var s=Dpr.getSubmittalFiles(o,r,e);if(s&&0<s.length){var a=function(e){if((e=aa.document.getCapDocumentList(e,Dpr.getAdminUser())).getSuccess())return e.getOutput()}(r);if(a&&0<a.length)for(var e=a.map(function(e){return e.getDocumentNo()}),n=Dpr.getFilesFromDocuments(Dpr.getAdminUser(),r,e.join(",")),i=0;i<a.length;i++){var p=a[i],c=function(e,t){if(t)for(var r=0;r<e.length;r++){var o=e[r].location;if(o.substring(4,o.length)===t)return e[r].id}}(n,p.getDocumentNo()+"");if(c)for(var u=0;u<s.length;u++)if(c===s[u].id&&p.getDocCategory()+""!==s[u].type){p.setDocCategory(s[u].type),aa.document.updateDocument(p);break}}}}}function B(e,t,r){var o=[];for(i=0;i<e.length;i++)(function(e,t){for(var r=0;r<t.length;r++)if(e.id===t[r].id)return 1})(e[i],t)||r&&!Dpr.matches(e[i].typeId,r)||o.push(e[i]);return o}function V(e,t,r){for(var o=e.capId,s=e.user,a=0;a<r.length;a++){Dpr.deletePrintSet(s,o,r[a].id,{discard:!1});var n,i=r[a].file,p=aa.document.getDocumentByPK(i);p.getSuccess()?((n=p.getOutput()).setDocCategory(t.archiveType),aa.document.updateDocument(n)):Dpr.error("Error retrieving document "+i+": "+p.getErrorMessage())}}function M(e,t,r){for(var o=e.capId,s=e.user,a=0;a<r.length;a++)Dpr.deletePrintSet(s,o,r[a].id)}function G(e,t){if(e){t=Dpr.findFirstMatch(e.type,t);if(t)return t;throw new Error("Could not find print set type for: "+e.id)}throw new Error("Could not find printSet for item.")}function x(e,t,r){var o=r.map(function(e){return e.id}),s=Dpr.getDocumentsFromFiles(e,t,o);if(s&&0<s.length)for(var a=0;a<r.length;a++)for(var n=0;n<s.length;n++)r[a].id===s[n].id&&(r[a].file=s[n].location.split("aa:/")[1]);return r}function W(e){var t=e.capId,r=e.user,o=e.documents;if(!o||0===o.length)throw new Error("Invalid input to reconcile, no new plans.");var s=v(e,Dpr.Actions.PRINTSETS_SECTION);if(!(s&&s.approvedPlans&&s.approvedPlans.reconcile))throw new Error("Invalid configuration for reconcile plans.");var a=s.approvedPlans.reconcile;(!a.types||a.types&&0<a.types.length&&Dpr.matches(o[0].type,a.types))&&(o=B(s=(s=Dpr.getApprovedPlans(r,t))&&0<s.length?x(r,t,s):s,o,a.types&&0<a.types.length?a.types:null),"archive"===a.strategy&&a.archiveType?V(e,a,o):"remove"===a.strategy&&M(e,0,o))}function q(e){var t=e.capId,r=e.user,o=e.documents;if(!o||0===o.length)throw new Error("Invalid input to reconcile, no new documents.");var s=v(e,Dpr.Actions.PRINTSETS_SECTION);if(!(s&&s.approvedDocuments&&s.approvedDocuments.combined&&s.approvedDocuments.reconcile))throw new Error("Invalid configuration for reconcile documents.");var a=s.approvedDocuments.reconcile;(!a.types||a.types&&0<a.types.length&&Dpr.matches(o[0].type,a.types))&&(o=B(s=(s=Dpr.getApprovedDocuments(r,t))&&0<s.length?x(r,t,s):s,o,a.types&&0<a.types.length?a.types:null),"archive"===a.strategy&&a.archiveType?V(e,a,o):"remove"===a.strategy&&M(e,0,o))}function Y(e,t,r,a,n){var i,p,c,o=e.capId,s=Dpr.getAdminUser(),u=e.submittalId||Dpr.getLatestSubmittedPackage(e);u?(e.process.defaultSheetTag&&(i=S(e.process.defaultSheetTag,e)),t=t.addSheetTags,r=r||Dpr.getPackageSheets(s,o,u),a=a||Dpr.getSubmittalFiles(s,o,u),n=n||Dpr.getFileTypes(),p=Dpr.getSheetSummary(s,o).filter(function(e){return e.approval}),c=[],r.forEach(function(o){var s;a.forEach(function(e){var t,r=Dpr.findFirstMatch(e.type,n);r.tags&&o.file===e.id&&(t=o.tags.split(","),(r=r.tags.toUpperCase().split(",")).every(function(e){return-1!==t.indexOf(e)})||(t=t.concat(r),unigueTags=t.filter(Dpr.getUniqueNonEmptyItems),o.tags=unigueTags.join(","),s=!0))}),p.forEach(function(e){var t;o.number===e.number&&(t=(t=o.tags.split(",")).concat(e.discipline.toUpperCase()),unigueTags=t.filter(Dpr.getUniqueNonEmptyItems),o.tags=unigueTags.join(","),s=!0)}),i&&!o.tags&&(o.tags=i.toUpperCase(),s=!0),s&&c.push(o)}),c.length&&t&&Dpr.updatePackageSheets(s,o,u,c)):Dpr.log("No Submittal Package Found")}Dpr.Actions.invokeActionFromExpression=function(e){try{var t=O(e,!0),r=t.capId,o=t.user,s=expression.getValue("WORKFLOW::FORM"),a=expression.getValue("WORKFLOW::taskItem*disposition");t.newStatus=a,t.taskStatus=a.value?a.value.trim()+"":void 0;var n=expression.getValue("WORKFLOW::dispTaskName");t.taskName=n.value?n.value.trim()+"":void 0;var i=expression.getValue("WORKFLOW::taskItem*dispositionComment");t.comment=i;var p=t.process.workflow;if(Dpr.log("Task name: "+t.taskName+". Task Status: "+t.taskStatus),Dpr.projectActive(o,r))for(var c in p)if(p.hasOwnProperty(c)){var u,d=p[c];if("review"===c&&Dpr.isDisciplineTask(t.taskName)){if(Dpr.log("Step: "+c),d.page&&(Dpr.log("Page "+d.page),u=Dpr.getDisciplineByWorkflowTask(t.taskName),s.message=k(Dpr.getPlanRoomProjectLink(t.capId,{pageId:d.page,discipline:u.id}),"PLAN ROOM PROJECT"),expression.setReturn(s)),d.actions&&!I(d,t,!0)){Dpr.log("Action fired.");break}}else if(d.tasks&&Dpr.matches(t.taskName,d.tasks)&&(Dpr.log("Step: "+c),d.page&&(Dpr.log("Page "+d.page),s.message=k(Dpr.getPlanRoomProjectLink(t.capId,{pageId:d.page}),"PLAN ROOM PROJECT"),expression.setReturn(s)),d.actions&&!I(d,t,!0))){Dpr.log("Action fired.");break}}t.cancel?(t.newStatus&&expression.setReturn(t.newStatus),s.blockSubmit=!0,expression.setReturn(s)):t.newStatus&&(expression.setReturn(t.newStatus),t.comment&&expression.setReturn(t.comment))}catch(e){Dpr.error("Action failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:"")),Dpr.setLastError(e)}},Dpr.Actions.invokeActionFromEvent=function(e){var t,r,o,s,a,n,i,p,c,u=O(e,!0);try{var d=aa.env.getValue("EventName")+"";switch(d){case"ConvertToRealCAPAfter":u.parentCapString=aa.env.getValue("ParentCapID")+"",_(u);break;case"ApplicationSubmitAfter":-1===(c=u).user.indexOf("PUBLICUSER")&&_(c);break;case"ApplicationDeleteBefore":b(u);break;case"ApplicationStatusUpdateAfter":u.appStatus=aa.env.getValue("ApplicationStatus")+"",u.appStatusComment=aa.env.getValue("StatusComment")+"",(p=(i=u).process.asua)&&p.actions&&N(p.actions,i);break;case"ApplicationSpecificInfoUpdateAfter":(n=(a=u).process.asiua)&&n.actions&&N(n.actions,a);break;case"ReportServiceRunAfter":u.reportId=aa.env.getValue("reportId")+"",(s=(o=u).process.rsra)&&s.actions&&N(s.actions,o);break;case"ApplicationDetailUpdateAfter":case"AddressLookUpAfter":case"AddressUpdateAfter":case"AddressRemoveAfter":case"AddressAddAfter":case"ParcelAddAfter":case"ParcelRemoveAfter":case"ParcelSplitAfter":case"ParcelUpdateAfter":(r=(t=u).process.adua)&&r.actions&&N(r.actions,t);break;case"WorkflowTaskUpdateAfter":case"WorkflowAdhocTaskUpdateAfter":u.taskName||(u.taskName=aa.env.getValue("WorkflowTask")+""),u.taskStatus||(u.taskStatus=aa.env.getValue("WorkflowStatus")+""),u.processId=aa.env.getValue("ProcessID")+"",y(u);break;case"InspectionResultModifyAfter":case"InspectionResultSubmitAfter":for(var l=aa.env.getValue("InspectionType").split(","),g=aa.env.getValue("InspectionResult").split(","),D=aa.env.getValue("InspectionId").split(","),f=0;f<D.length;f++)u.inspectionId=D[f],u.inspectionResult=g[f]+"",u.inspectionType=l[f]+"",j(u);break;case"V360InspectionResultSubmitAfter":u.inspectionId=aa.env.getValue("InspectionId"),u.inspectionResult=aa.env.getValue("InspectionResult")+"",u.inspectionType=aa.env.getValue("InspectionType")+"",j(u);break;case"DocumentDeleteBefore":if(u.user!==Dpr.getAdminUser()){u.docIds=aa.env.getValue("DocumentIDList");try{var m=Dpr.Actions.onDocumentsDeleteBefore(u);m&&(aa.env.setValue("ScriptReturnCode","1"),aa.env.setValue("ScriptReturnMessage","<font color=red><b>Action Cancelled</b></font><br><br> "+m))}catch(e){throw aa.env.setValue("ScriptReturnCode","1"),aa.env.setValue("ScriptReturnMessage","<font color=red><b>Action Cancelled</b></font><br><br> One or more documents cannot be deleted because of an unknown error."),e}}break;default:Dpr.Actions.onHandleCustomActionEvent?(u.eventName=d,Dpr.Actions.onHandleCustomActionEvent(u)):Dpr.log(d+" not supported by action framework.")}}catch(e){Dpr.error("Action failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:"")),u.errorCode="DPR_EMSE_ERROR",u.errorMessage=e.message,u.errorStack=e.stack,Dpr.Actions.onException(u),Dpr.setLastError(e)}},Dpr.Actions.getDefaultProcess=function(e){return e?d.processes[e]:d.process.default},Dpr.Actions.setConfig=function(e){l(d,e)},Dpr.Actions.getConfig=function(){return d},Dpr.Actions.getConfigSection=v,Dpr.Actions.printConfig=function(e){function t(e,t){return t&&"function"==typeof t?String(t.name):t}if(e){var r=e.capId,o=(e.user,aa.cap.getCap(r).getOutput().getCapType().toString()+""),r=Dpr.getProjectType(o),o=r.process&&d.processes[r.process]?d.processes[r.process]:d.processes.default,s={};s[r.process||"default"]=o;var a,n=[Dpr.Actions.SETTINGS_SECTION,Dpr.Actions.PROJECT_GROUPS_SECTION,"printSets","notifications"];for(a in d)"processes"!==a&&(Dpr.matches(a,n)?s[a]=v(e,a):s[a]=d[a]);return JSON.stringify(s,t,2)}return JSON.stringify(d,t,2)},Dpr.Actions.onSubmittalNotification=function(e){var t=e.cap.getCapType().toString()+"",t=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",t);e.ready,e.projectType=t,e.process=t.process&&d.processes[t.process]?d.processes[t.process]:d.processes.default,(t=e.process.submit)&&t.actions&&N(t.actions,e)},Dpr.Actions.onPrintSetStart=function(e){var t=e.cap.getCapType().toString()+"",t=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",t);e.projectType=t,e.process=t.process&&d.processes[t.process]?d.processes[t.process]:d.processes.default,(t=e.process.psab)&&t.actions&&N(t.actions,e)},Dpr.Actions.onPrintSetComplete=function(e){var t=e.capId,r=e.cap.getCapType().toString()+"",o=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",r);if(e.projectType=o,e.process=o.process&&d.processes[o.process]?d.processes[o.process]:d.processes.default,e.template){var s=e.process.psaa;s&&s.actions&&N(s.actions,e)}else{for(var a,r=e.documents[0],n=r.type,i=0;i<e.documents.length;i++)e.documents[i].type=n;if(r.target){e.revision=t.getId()+"";s=r.target,r=s.split("-"),r=aa.cap.getCapID(r[1],r[2],r[3]);if(!r.getSuccess())throw Error("Unable to retrieve capId for target: "+s);e.documents[0].target=t.getId()+"",e.capId=r.getOutput(),e.cap=aa.cap.getCap(e.capId).getOutput(),e.module=e.cap.getCapModel().getModuleName()+"",e.capType=e.cap.getCapType().toString()+"",o=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",e.capType),e.projectType=o,e.process=o.process&&d.processes[o.process]?d.processes[o.process]:d.processes.default}for(var p,c=Dpr.getPrintSetTypes(),u=0;u<c.length;u++)if(n===c[u].id&&"yes"===c[u].aca){a=c[u].role;break}"plan"===a?(p=e.process.paa)&&p.actions&&N(p.actions,e):"document"!==a||(p=e.process.daa)&&p.actions&&N(p.actions,e)}},Dpr.Actions.extend=r,Dpr.Actions.getProcessDetails=function(e){var t=e.capId,r=aa.cap.getCap(t).getOutput().getCapType().toString()+"",o=Dpr.getProjectType(r);return"revision"===(e=o.process&&d.processes[o.process]?d.processes[o.process]:d.processes.default).type&&(t=Dpr.getParentRecord(t),r=aa.cap.getCap(t).getOutput().getCapType().toString()+"",e=(o=Dpr.getProjectType(r)).process&&d.processes[o.process]?d.processes[o.process]:d.processes.default,Dpr.log("Parent process is: "+o.process)),{type:e.type}},Dpr.Actions.getProjectProperties=u,Dpr.Actions.onApplicationDeleteAfter=b,Dpr.Actions.onApplicationStatusUpdateAfterDefault=function(e){var t=e.capId;e.process.voidAppStatuses&&Dpr.matches(e.appStatus,e.process.voidAppStatuses)?Dpr.projectExists(Dpr.getAdminUser(),t)&&(Dpr.deleteProjectFromAllGroups(Dpr.getAdminUser(),t),Dpr.Actions.deleteOpenReviewPackages(e),Dpr.updateProject(Dpr.getAdminUser(),t,{status:"closed"}),Dpr.log("DPR: Project closed.")):e.process.archivedAppStatuses&&Dpr.matches(e.appStatus,e.process.archivedAppStatuses)?Dpr.projectExists(Dpr.getAdminUser(),t)&&(Dpr.updateProject(Dpr.getAdminUser(),t,{status:"closed"}),Dpr.log("DPR: Project closed.")):e.process.reOpenAppStatuses&&Dpr.matches(e.appStatus,e.process.reOpenAppStatuses)&&Dpr.projectExists(Dpr.getAdminUser(),t)&&(Dpr.updateProject(Dpr.getAdminUser(),t,{status:"intake"}),Dpr.log("DPR: Project re-opened."))},Dpr.Actions.onApplicationDetailUpdateAfterDefault=function(e){var t,r,o=e.capId,s=e.cap;Dpr.projectExists(Dpr.getAdminUser(),o)&&(t=Dpr.getRecordPrimaryAddress(o),r=Dpr.getRecordPrimaryParcel(o),e={},s=s.getSpecialText(),e.name=s?s+"":"",e.number=o.getCustomID()+"",e.description=Dpr.getWorkDescription(o),e.address=t.address||"",e.city=t.city||"",e.state=t.state||"",e.zip=t.zip||"",e.parcel=r||"",Dpr.updateProject(Dpr.getAdminUser(),o,e))},Dpr.Actions.onApplicationSpecificInfoUpdateAfterDefault=function(e){s(e)},Dpr.Actions.onReportServiceRunAfterDefault=function(e){var t,r=e.capId,o=e.reportId,s=v(e,Dpr.Actions.REPORTS_SECTION);s&&s.imports&&(!(t=function(e,t){for(var r,o,s=0;s<t.length;s++)if(e===t[s].name){r=t[s];break}return r&&(o=com.accela.aa.emse.dom.service.CachedService.getInstance().getReportsManagerService().getReportByName(aa.getServiceProviderCode(),e),r.type=o.getDocCategory()+""),r}(o,s.imports))||(o=function(e,t){var r=Dpr.getDocumentsForApprovedImport(Dpr.getAdminUser(),e);Dpr.log("Elegible doc id "+r.length+" : category: "+t);t=function(e,t){if(e&&0<e.length)for(var r=0;r<e.length;r++){var o=e[r];if(o.type===t)return o}}(r,t);Dpr.log("Doc id "+t),t&&Dpr.importApprovedDocument(Dpr.getAdminUser(),e,[{location:t.location,name:t.name,typeId:t.typeId}]);return t}(r,t.type))&&t.reconcile&&(s=t.reconcile,t=B(Dpr.getApprovedDocuments(Dpr.getAdminUser(),r),[o],[t.type]),"archive"===s.strategy&&s.archiveType?V(e,s,t):"remove"===s.strategy&&M(e,0,t)))},Dpr.Actions.excludeRecordCheck=function(e){var t=e.capId,r=v(e,Dpr.Actions.SETTINGS_SECTION);r&&r.excludeRecord&&r.excludeRecord.fieldLabel&&r.excludeRecord.fieldValue&&((t=Dpr.getCustomField(t,r.excludeRecord.fieldLabel))&&(r.excludeRecord.fieldValue instanceof Array&&Dpr.matches(t,r.excludeRecord.fieldValue)||t===r.excludeRecord.fieldValue)&&(e.abort=!0))},Dpr.Actions.cloneCheck=function(e){var t=e.capId,r=e.capType,o=v(e,Dpr.Actions.SETTINGS_SECTION);o&&o.moveDprProject&&o.moveDprProject.fieldLabel&&"Yes"===Dpr.getCustomField(t,o.moveDprProject.fieldLabel)&&((o=Dpr.getParentRecord(t))&&Dpr.projectExists(Dpr.getAdminUser(),o)?(r={id:t.getId()+"",number:t.getCustomID()+"",typeId:r},Dpr.moveProject(Dpr.getAdminUser(),o,r),e.abort=!0):Dpr.error("Unable to move DPR project to parent record. Parent record does not exist for "+t.getCustomID()+"."))},Dpr.Actions.isCustomFieldValue=function(e,t){var r,o=e.capId,s=!1;return t&&t.field&&t.value&&(r=t.field,e=t.value,t=!t.matches||"N"!==t.matches,r=Dpr.getCustomField(o,r),t?(e instanceof Array&&Dpr.matches(r,e)||r===e)&&(s=!0):(e instanceof Array&&!Dpr.matches(r,e)||r!==e)&&(s=!0)),s},Dpr.Actions.setDefaultSubmissionStatus=function(e){var t=e.capId,r=e.process.workflow,e=e.process.pendingInitialStatus;r.application&&r.application.tasks?(r=Dpr.getTasks(t,r.application.tasks))&&1===r.length&&e?Dpr.updateTaskItem(t,Dpr.getAdminUser(),r[0],e,"","","","U"):Dpr.log("Application task not found or multiple application tasks returned or pendingInitialStatus not set."):Dpr.log("No application step configured.")},Dpr.Actions.createProjectPlusSubmittal=function(e){var t=e.capId,r=e.cap,o=e.process.type,s=e.projectType,a=Dpr.getRecordPrimaryAddress(t),n=Dpr.getRecordPrimaryParcel(t),i={};i.number=t.getCustomID()+"",i.typeId=s.id,i.type=s.name,i.process=o,i.description=Dpr.getWorkDescription(t),i.address=a.address||"",i.city=a.city||"",i.state=a.state||"",i.zip=a.zip||"",i.parcel=n?n+"":"",i.organization=e.module?e.module+"":"",r=r.getSpecialText(),i.name=r?r+"":"",(r=v(e,Dpr.Actions.SETTINGS_SECTION))&&r.properties&&(i.properties=u(e,r.properties)),e.parent&&(i.properties||(i.properties=[]),i.properties.push({name:"PRIMARY_PROJECT",value:e.parent.getCustomID()+""})),e.submittalId=Dpr.createProjectPlusSubmittal(Dpr.getAdminUser(),t,i)},Dpr.Actions.reOpenLatestReviewPackage=function(e){var t,r,o=e.capId,s=e.user,a=Dpr.getTask(o,e.taskName,e.processId);a?(t=(r=a.getDispositionComment())?r+"":void 0,(a=Dpr.getLatestProjectSubmittal(s,o))&&"ACCEPTED"!==a.status.toUpperCase()&&(e.submittalId=a.id,(r={}).id=a.id,r.status="reopened",t&&(r.statusComment=t+""),Dpr.updateProjectSubmittal(s,o,r))):Dpr.log("Task "+e.taskName+" not found in current workflow.")},Dpr.Actions.cleanAcceptReviewPackages=function(e){var t=e.capId,e=e.user;Dpr.cleanUpEmptyReviewPackages(e,t),Dpr.acceptReviewPackages(e,t)},Dpr.Actions.setDefaultSheetSetOrder=function(e,t){var r=e.capId,o=e.user;if(t&&t.type)for(var s=Dpr.getSheetSetOrders(o,r),a=0;a<s.length;a++){var n=s[a];if(n.type===t.type&&"Y"!==n.default){Dpr.updateSheetSetOrder(o,r,{id:n.id,default:"Y"});break}}else Dpr.error("No type set for default sort order on project: "+r.getCustomID())},Dpr.Actions.deleteOpenReviewPackages=function(e){var t=e.capId,r=e.user,o=Dpr.getProjectSubmittals(r,t);if(0<o.length)for(var s=0;s<o.length;s++){var a=o[s];Dpr.matches(a.status.toUpperCase(),["SUBMITTED","ACCEPTED","ACCEPTING","SUBMITTING","WITHDRAWN"])||Dpr.deleteReviewPackage(r,t,a.id)}return!0},Dpr.Actions.resetRevisionIntakeTask=function(e){for(var t=e.capId,r=e.user,o=e.process.workflow,s=e.process.pendingRevisionStatus,a=["application","distribution"],n=[],i=0;i<a.length;i++)o[a[i]]&&o[a[i]].tasks&&(n=n.concat(o[a[i]].tasks));n&&0<n.length?(e=Dpr.getTasks(t,n,!0))&&1===e.length&&s?Dpr.updateTaskItem(t,r,e[0],s,"","","","U"):Dpr.log("Application task not found or multiple distribution tasks returned."):Dpr.log("No application or distribution tasks configured.")},Dpr.Actions.createIssuesReportTemplatePrintsets=function(e){var t,r,o=e.capId,s=e.user;0!==Dpr.getOpenIssuesCount(s,o)?(r=Dpr.Actions.getConfigSection(e,Dpr.Actions.PRINTSETS_SECTION))&&r.approvedTemplate&&r.issuesReportTemplate.template&&(t={},r=n(e,r.issuesReportTemplate.template),t.template=r,Dpr.createTemplatePrintSets(s,o,t)):Dpr.error("No open issues found for "+o.getCustomID())},Dpr.Actions.createApprovedTemplatePrintsets=function(e){var t,r=e.capId,o=e.user,s=v(e,Dpr.Actions.PRINTSETS_SECTION);s&&s.approvedTemplate&&s.approvedTemplate.template&&(Dpr.updateProject(o,r,{issued:"Y"}),t={},s=n(e,s.approvedTemplate.template),t.template=s,t.issued=!0,Dpr.createTemplatePrintSets(o,r,t))},Dpr.Actions.createApprovedPlans=function(e,t){var r=e.capId,o=e.user,s=e.module,a=v(e,Dpr.Actions.PRINTSETS_SECTION);if(!(a&&a.approvedTemplate&&a.approvedTemplate.template)&&(Dpr.updateProject(o,r,{issued:"Y"}),a&&a.approvedPlans)){var n,i,p={};if((a=a.approvedPlans).name?(n=P(e,a.name),p.name=n||"Print Set: "+r.getCustomID()):(n=R(e,a.namePrefix),p.name=n?n+r.getCustomID():"Print Set: "+r.getCustomID()),a.description?(i=C(e,a.description),p.description=i||""):(i=h(e,a.descriptionPrefix),p.description=i?i+r.getCustomID():""),!a.type)throw new Error("Unable to create print set, approved type is not configured for module: "+s);p.type=E(e,a.type),p.includeStamps=a.includeStamps,p.includeNotes=a.includeNotes,p.includeConditions=a.includeConditions,a.watermarks&&(p.watermarks=T(e,a.watermarks)),a.fields&&(p.fields=w(e,a.fields)),t&&t.sheets&&(p.sheets=D(t.sheets,e)),p.issued=!0,Dpr.hasProjectSheets(o,r)?Dpr.createSheetsPrintSet(o,r,p):Dpr.log("Failed to create printset for project: "+r.getId()+", no available sheets")}},Dpr.Actions.createApprovedSupportingDocuments=function(e,t){var r,o=e.capId,s=e.user,a=e.module,n=v(e,Dpr.Actions.PRINTSETS_SECTION);if(!(n&&n.approvedTemplate&&n.approvedTemplate.template)&&(t&&t.parent&&(r=Dpr.getParentRecord(o)),n&&n.approvedDocuments&&(t&&t.parent&&r||!t))){if(n.approvedDocuments.includedTypes&&!function(e){for(var t=Dpr.getFileTypes(),r=0;r<e.length;r++)if(void 0===Dpr.findFirstMatch(e[r],t))return!1;return!0}(n.approvedDocuments.includedTypes))throw new Error("Unable to create document print set, invalid includedTypes configuration for module: "+a);for(var i=t&&t.parent&&r?r:o,p=[],c=Dpr.getProjectDocuments(s,o),u=0;u<c.length;u++)n.approvedDocuments.includedTypes&&!Dpr.matches(c[u].type,n.approvedDocuments.includedTypes)||c[u].status&&"approved"===c[u].status.toLowerCase()&&p.push(c[u]);if(0<p.length){var d,l,g,D,f=n.approvedDocuments,m={};if(r&&(m.project=o.getId()+""),m.includeStamps=f.includeStamps,m.includeNotes=f.includeNotes,m.includeConditions=f.includeConditions,f.watermarks&&(m.watermarks=T(e,f.watermarks)),f.fields&&(m.fields=w(e,f.fields)),f.name?d=P(e,f.name):l=R(e,f.namePrefix),f.description?g=C(e,f.description):D=h(e,f.descriptionPrefix),f.combined){if(!f.type)throw new Error("Unable to create document print set, type is not configured for module: "+a);m.type=E(e,f.type),m.name=d||(l?l+o.getCustomID():"Print Set: "+o.getCustomID()),m.description=g||(D?D+o.getCustomID():""),m.documents=p.map(function(e){return e.id}),m.includeConditionsReport="ifnoplans",Dpr.createDocumentsPrintSet(s,i,m)}else for(var I=!0,u=0;u<p.length;u++){if(!f.type)throw new Error("Unable to create document print set, type is not configured for module: "+a);m.type=E(e,f.type,p[u]),m.name=d||(l?l+p[u].name:p[u].name),100<m.name.length&&(m.name=m.name.substring(0,100)),m.description=g||(D?D+p[u].type+" - "+o.getCustomID():p[u].type),m.includeConditionsReport="no",I=I&&!(m.includeConditionsReport="ifnoplans"),m.documents=[p[u].id],Dpr.createDocumentsPrintSet(s,i,m)}}}},Dpr.Actions.removeProjectFromGroups=function(e){var t=e.capId,e=e.user;Dpr.deleteProjectFromAllGroups(e,t)},Dpr.Actions.deleteProject=function(e){e=e.capId,Dpr.updateProject(Dpr.getAdminUser(),e,{description:"DELETE",name:"DELETE",status:"withdrawn"})},Dpr.Actions.publishConditionsTask=function(e){var t=e.capId,r=e.user;Dpr.publishConditions(r,t,e.taskName)},Dpr.Actions.publishConditionsAll=function(e){var t=e.capId,e=e.user;Dpr.publishConditions(e,t)},Dpr.Actions.publishIssuesTask=function(e){var t=e.capId,r=e.user;Dpr.publishIssues(r,t,e.taskName)},Dpr.Actions.publishIssuesAll=function(e){var t=e.capId,e=e.user;Dpr.publishIssues(e,t)},Dpr.Actions.approveSheetsByDiscipline=function(e){var t=e.capId,r=e.user;Dpr.approveSheetsByDisciplineTask(r,t,e.taskName)},Dpr.Actions.createNewCyclePackageAndPublishIssues=function(e,t){var r=e.capId,o=e.user,s={};t&&t.checklist&&(s.checklist=D(t.checklist,e)),e.submittalId=Dpr.createSubmittalPackage(o,r,s,!0)},Dpr.Actions.createNewDisciplineCyclePackageAndPublishIssues=function(e,t){var r=e.capId,o=e.user,s=Dpr.getDisciplineByWorkflowTask(e.taskName);s?(s={recipient:s.id},t&&t.checklist&&(s.checklist=D(t.checklist,e)),e.submittalId=Dpr.createSubmittalPackage(o,r,s,!0),Dpr.log("Plan Review Rejected. Submittal created.")):Dpr.log("Discipline task: "+e.taskName+" not found.")},Dpr.Actions.updateProjectStatus=function(e,t){var r=e.capId,o=e.user,e={};if(!t||!t.status)throw new Error("Unable to update project status, status not configred");e.status=t.status,"APPROVED"===t.status.toUpperCase()&&(e.issued="Y"),Dpr.updateProject(o,r,e)},Dpr.Actions.issueProject=function(e){Dpr.updateProject(e.user,e.capId,{issued:"Y"})},Dpr.Actions.updateProjectProperties=s,Dpr.Actions.setRecordStatus=function(e,t){var r=e.capId,e=e.user;t&&t.status&&Dpr.updateRecordStatus(r,e,t.status,"")},Dpr.Actions.reconcileOldTemplate=function(e){for(var t,r,o,s=[],a=Dpr.getPrintSetTypes(),n=e.documents,i=0;i<n.length;i++){var p=n[i],c=(o=void 0,(r=p)&&r.target&&(r=r.target.split("-"),(r=aa.cap.getCapID(r[1],r[2],r[3])).getSuccess()&&(o=r.getOutput())),o);if(!(c=c||e.capId))throw new Error("Could not find capId for item: "+p.id);var u=G(p,a);if(!u)throw new Error("Could not find printSetConfig for item:"+p.id);if(0<s.length){for(var d=!1,l=0;l<s.length;l++)if(s[l].capId.equals(c)&&s[l].role===u.role){s[l].documents.push({id:p.id,type:u.id}),d=!0;break}d||((t={}).capId=c,t.user=e.user,t.module=e.module,t.documents=[{id:p.id,type:u.id}],t.role=u.role,s.push(t))}else(t={}).capId=c,t.user=e.user,t.module=e.module,t.documents=[{id:p.id,type:u.id}],t.role=u.role,s.push(t)}for(var g=0;g<s.length;g++)("plan"===s[g].role?W:q)(s[g])},Dpr.Actions.reconcileOldPlans=W,Dpr.Actions.reconcileOldDocuments=q,Dpr.Actions.onAttachmentNotification=function(e){if(a(e,Dpr.Actions.ATTACHMENT_UPLOAD_NOTIFICATION)){var t=e.document,r=aa.document.getDocumentByPK(t.id);if(!r.getSuccess())throw new Error("Error retrieving attachment. Id: "+t.id);var o=r.getOutput();if(!o)throw new Error("Error retrieving attachment. Id: "+t.id);var s=o.getDocName()+"",r=o.getDocCategory()+"",o=o.getDocDescription()?o.getDocDescription()+"":"";A(e,Dpr.Actions.ATTACHMENT_UPLOAD_NOTIFICATION,{docName:s,docCategory:r,docDescription:o},{note:r,comment:"File uploaded: "+s}),Dpr.log("DPR_ATTACHMENTS: "+t.id+":"+s)}},Dpr.Actions.autoRouteResubmittal=function(e){if(e.process.autoRouteResubmittal){var i=e.capId,t=Dpr.getAdminUser(),r=Dpr.getLatestSubmittedPackage(e);if(r){var p,c=S(e.process.autoRouteResubmittal.reviewStatus,e),u=S(e.process.autoRouteResubmittal.reviewStatusNotRequested,e),d=S(e.process.autoRouteResubmittal.daysToComplete,e);if(!e.process.workflow.review.actions.revise.statuses)throw new Error("Missing Correction Statuses in process.workflow.review.actions.revise.statuses");if(p=[].concat(e.process.workflow.review.actions.revise.statuses),!e.process.workflow.distribution.actions.route.statuses)throw new Error("Missing review Statuses in process.workflow.distribution.actions.route.statuses");var o,s=[].concat(e.process.workflow.distribution.actions.route.statuses),a=Dpr.getTask(i,e.taskName).getProcessCode()+"";if(!(o=Dpr.getMatchingStatusForTask(i,e.taskName,a,s)))throw new Error("Missing send for review status in workflow.");var l,a=e.process.autoRouteResubmittal.workflowComment?S(e.process.autoRouteResubmittal.workflowComment,e):"Autorouted for Review",s=e.process.autoRouteResubmittal.addSheetTags,g=e.process.autoRouteResubmittal.to?S(e.process.autoRouteResubmittal.to,e).toLowerCase():"tagscorrections",D=[],f=[],m=[];if("tagscorrections"===g){var m=Dpr.getPackageSheets(t,i,r),r=Dpr.getSubmittalFiles(t,i,r),n=Dpr.getFileTypes();Y(e,{addSheetTags:s},m,r,n),r.forEach(function(e){e=Dpr.findFirstMatch(e.type,n);e.tags&&(e=e.tags.toLowerCase().split(","),D=D.concat(e))}),D=D.filter(Dpr.getUniqueNonEmptyItems),l=Dpr.getDisciplineSettings()}else if("all"===g||"allparticipated"===g){for(var I=Dpr.getDisciplineSettings(),v=0;v<I.length;v++)I[v].filter&&(f=f.concat(I[v].filter.split(",")));f=f.filter(Dpr.getUniqueNonEmptyItems)}Dpr.updateTask(i,Dpr.getAdminUser(),e.taskName,o,a,"",""),Dpr.triggerWtuaEvent(i,Dpr.getAdminUser(),e.taskName,o,""),Dpr.getReviewTasks(i).forEach(function(e){var t,r=u,o=e.getDisposition()+"";if(Dpr.matches(o,p))t=!0,r=c;else if(!Dpr.matches(o,f)&&("all"===g||"allparticipated"===g&&o))t=!0;else if("tagscorrections"===g){var s=function(e,t){for(var r=0;r<t.length;r++)for(var o=t[r],s=Dpr.getDisciplineTasks(o),a=0;a<s.length;a++)if(e.toUpperCase().trim()===s[a].toUpperCase().trim())return o}(e.getTaskDescription()+"",l);if(s){Dpr.matches(s.text.toLowerCase(),D)&&(t=!0);for(var a=0;a<m.length;a++){var n=m[a];n.tags&&(n=n.tags.toUpperCase().split(","),Dpr.matches(s.id.toUpperCase(),n)&&(t=!0))}}}t?(Dpr.setTaskRequired(e),d&&Dpr.editTaskDueDate(e,Dpr.dateAdd(null,d,!0)),r&&(Dpr.updateTaskItem(i,Dpr.getAdminUser(),e,r,"","","","U"),Dpr.triggerWtuaEvent(i,Dpr.getAdminUser(),e.getTaskDescription()+"",r,e.getProcessID()+""))):Dpr.deactivateTask(i,e.getTaskDescription()+"")})}else Dpr.log("No Submittal Package Found")}},Dpr.Actions.updateSheetTags=Y,Dpr.Actions.autoRouteCorrectionRequired=function(e){var t,r,o,s;e.process.autoRouteCorrectionRequired&&(t=e.capId,o=[].concat(e.process.workflow.coordination.tasks),(s=Dpr.getTasks(t,o,!0)).length?(o=(r=s[0]).getTaskDescription()+"",s=r.getProcessCode()+"",Dpr.hasOpenIssues(e.user,e.capId)&&((s=Dpr.getMatchingStatusForTask(t,o,s,e.process.workflow.coordination.actions.revise.statuses))?(e=e.process.autoRouteCorrectionRequired.workflowComment?S(e.process.autoRouteCorrectionRequired.workflowComment,e):"",Dpr.updateTaskItem(t,Dpr.getAdminUser(),r,s,e,""),Dpr.triggerWtuaEvent(t,Dpr.getAdminUser(),o,s,r.getProcessID()+"")):Dpr.error("Unable to autoRouteCorrections. Missing task status"))):Dpr.error("Unable to autoRouteCorrections. Missing task"))},Dpr.Actions.syncSubmittalDocumentTypes=L,Dpr.Actions.midCycleSubmittedNotification=function(e){var t,r,o,s;"amend"===e.type&&e.process.sendMidCycleSubmittedNotification&&(o=e.ready,(t=c(e,Dpr.Actions.REVIEW_PACKAGE_SUBMITTED_STAFF_NOTIFICATION))&&"Y"===o.toUpperCase()&&(s=e.submittalId,r=e.capId,o=e.user,s?(s=Dpr.getProjectSubmittal(Dpr.getAdminUser(),r,s))?(s=s.createdBy)&&(e.user=s,m(e,t),e.user=o):Dpr.error("Unable to send mid-cycle submitted notification. Submittal not found for: "+r.getCustomID()):Dpr.error("Unable to send mid-cycle submitted notification. Submittal id not found for: "+r.getCustomID())))},Dpr.Actions.deleteReportPrintsets=function(e){var t,r;e.process.deleteReportPrintsets&&(t=e.capId,r=e.user,M(e,0,Dpr.getReportPrintsets(r,t)))},Dpr.Actions.issueApprovedDocs=function(e){if(e.process.issueApprovedDocs){var t=e.capId,r=e.user;if(r===Dpr.getAdminUser()){var o=Dpr.getProjectDocuments(e.user,e.capId);if(0<o.length)for(var s in o)o[s].status&&"approved"===o[s].status.toLowerCase()&&(s={id:o[s].id,status:"issued"},Dpr.updateProjectDocument(r,t,s))}}},Dpr.Actions.isNotificationEnabled=a,Dpr.Actions.sendNotification=A,Dpr.Actions.sendApplicationReceivedNotification=function(e){var t,r=e.capId,o=e.process,s=e.module;"revision"===o.type||(t=c(e,Dpr.Actions.APPLICATION_RECEIVED_NOTIFICATION))&&((o={}).dprNewReviewPackageLink=e.submittalId?Dpr.getAcaDeepLinkUrl(r,s,t.acaUrl,"RESUMESUBMITTAL",e.submittalId):Dpr.getAcaDeepLinkUrl(r,s,t.acaUrl,"UPLOADS"),m(e,t,o))},Dpr.Actions.sendPlansReceivedNotification=function(e){var t=c(e,Dpr.Actions.PLANS_RECEIVED_NOTIFICATION);t&&m(e,t)},Dpr.Actions.sendReOpenNotification=function(e){var t,r=e.capId,o=e.module,s=c(e,Dpr.Actions.ADDITIONAL_INFO_REQUIRED_NOTIFICATION);s&&((t={}).dprReOpenedPackageLink=e.submittalId?Dpr.getAcaDeepLinkUrl(r,o,s.acaUrl,"RESUMESUBMITTAL",e.submittalId):Dpr.getAcaDeepLinkUrl(r,o,s.acaUrl,"UPLOADS"),(r=Dpr.getTask(r,e.taskName,e.processId))?(r=r.getDispositionComment())&&(t.wfComment=r+""):Dpr.log("Task "+e.taskName+" not found in current workflow."),m(e,s,t))},Dpr.Actions.sendFileValidationIssuesNotification=function(e){var t=c(e,Dpr.Actions.FILE_VALIDATION_ISSUES_NOTIFICATION);t&&m(e,t)},Dpr.Actions.sendFileValidationIssuesReminderNotification=function(e){var t=c(e,Dpr.Actions.FILE_VALIDATION_ISSUES_REMINDER_NOTIFICATION);t&&m(e,t)},Dpr.Actions.sendRevisionsReceivedNotification=function(e){var t=c(e,Dpr.Actions.REVISIONS_RECEIVED_NOTIFICATION);t&&m(e,t,{requestType:"Revision"})},Dpr.Actions.sendReviewPackageSubmittedStaffNotification=function(e,t){var r=e.capId,o=e.user,s=c(e,Dpr.Actions.REVIEW_PACKAGE_SUBMITTED_STAFF_NOTIFICATION);!s||(r=(t=t&&0<t.taskName.length?Dpr.getTask(r,t.taskName):Dpr.getTask(r,e.taskName,e.processId)).getAssignedStaff())&&r.getFirstName()&&r.getLastName()&&(!(t=aa.person.getUser(t.getAssignedStaff().getFirstName(),t.getAssignedStaff().getMiddleName(),t.getAssignedStaff().getLastName())).getSuccess()||(t=t.getOutput()).getEmail()&&(e.user=t.getUserID()+"",m(e,s),e.user=o))},Dpr.Actions.sendReviewCycleNotApprovedNotification=function(e){var t,r,o=e.capId,s=e.user,a=c(e,Dpr.Actions.PLAN_REVIEW_REJECTED_NOTIFICATION);a&&(t={},e.submittalId?t.submittalId=e.submittalId:(r=Dpr.getLatestProjectSubmittal(s,o))&&(t.submittalId=r.id),t.openIssuesCount=Dpr.getOpenIssuesCount(s,o),t.openConditionsCount=Dpr.getOpenConditionsCount(s,o),t.notesCount=Dpr.getOpenNotesCount(s,o),m(e,a,t))},Dpr.Actions.sendDisciplineReviewRejectedNotification=function(e){var t,r=e.capId,o=e.user,s=c(e,Dpr.Actions.DISCIPLINE_REVIEW_REJECTED_NOTIFICATION);s&&((t={}).discipline=e.taskName,t.openIssuesCount=Dpr.getOpenIssuesCount(o,r,e.taskName),t.openConditionsCount=Dpr.getOpenConditionsCount(o,r,e.taskName),t.notesCount=Dpr.getOpenNotesCount(o,r,e.taskName),m(e,s,t))},Dpr.Actions.sendSubmitPlansReminderNotification=function(e){var t,r=e.capId,o=e.user,s=c(e,Dpr.Actions.SUBMIT_PLANS_REMINDER_NOTIFICATION);s&&(t={},e.submittalId?t.submittalId=e.submittalId:(r=Dpr.getLatestProjectSubmittal(o,r))&&(t.submittalId=r.id),m(e,s,t))},Dpr.Actions.sendSubmitRevisedPlansReminderNotification=function(e){var t,r,o=e.capId,s=e.user,a=c(e,Dpr.Actions.SUBMIT_REVISED_PLANS_REMINDER_NOTIFICATION);a&&(t={},e.submittalId?t.submittalId=e.submittalId:(r=Dpr.getLatestProjectSubmittal(s,o))&&(t.submittalId=r.id),t.openIssuesCount=Dpr.getOpenIssuesCount(s,o),t.openConditionsCount=Dpr.getOpenConditionsCount(s,o),t.notesCount=Dpr.getOpenNotesCount(s,o),m(e,a,t))},Dpr.Actions.sendRevisionRequestReceivedNotification=function(e){var t,r=e.capId,o=e.module,s=(s=e.parent)||Dpr.getParentRecord(r),a=c(e,Dpr.Actions.REVISION_REQUEST_RECEIVED_NOTIFICATION);a&&((t={}).dprNewReviewPackageLink=Dpr.getAcaDeepLinkUrl(r,o,a.acaUrl,"UPLOADS"),t.parentAltID=s.getCustomID()+"",m(e,a,t))},Dpr.Actions.sendApprovedTemplateNotification=function(e){var t=e.user,r=e.process.type,o=e.module,s=e.capId,a=e.parent;if(t===Dpr.getAdminUser()){for(var n=Dpr.getPrintSetTypes(),i=e.documents,p=0;p<i.length;p++){var c=i[p],u=G(c,n);if(!u)throw new Error("Could not find printSetConfig for item:"+c.id);if("report"===u.role)return}"revision"!==r?A(e,Dpr.Actions.PLAN_REVIEW_APPROVED_NOTIFICATION):A(e,Dpr.Actions.REVISION_REQUEST_APPROVED_NOTIFICATION,function(e,t){var r={};return(a=a||Dpr.getParentRecord(s))&&(r.parentAltID=a.getCustomID()+"",r.parentApprovedPlansLink=Dpr.getAcaDeepLinkUrl(a,o,t.acaUrl,"APPROVEDPLANS")),r.revisionAltID=e.capId.getCustomID()+"",r.dprRevisionConditionsLink=Dpr.getAcaDeepLinkUrl(e.capId,o,t.acaUrl,"CONDITIONSLIST"),r.dprApprovedPlansURL=Dpr.getAcaDeepLinkUrl(s,o,t.acaUrl,"APPROVEDPLANS"),r.dprConditionListURL=Dpr.getAcaDeepLinkUrl(s,o,t.acaUrl,"CONDITIONSLIST"),r.requestType="Revision",r})}},Dpr.Actions.sendApprovedPlansNotification=function(e){var o,t=e.user,r=e.revision,s=e.module;t===Dpr.getAdminUser()&&(r?(r=r.split("-"),(r=aa.cap.getCapID(r[1],r[2],r[3])).getSuccess()&&(o=r.getOutput(),A(e,Dpr.Actions.REVISION_REQUEST_APPROVED_NOTIFICATION,function(e,t){var r={};return r.revisionAltID=o.getCustomID()+"",r.dprRevisionConditionsLink=Dpr.getAcaDeepLinkUrl(o,s,t.acaUrl,"CONDITIONSLIST"),r.requestType="Revision",r}))):A(e,Dpr.Actions.PLAN_REVIEW_APPROVED_NOTIFICATION))},Dpr.Actions.sendApprovedDocumentsNotification=function(e){var o,t=e.capId,r=e.user,s=e.revision,a=e.module;r===Dpr.getAdminUser()&&(s?(s=s.split("-"),(s=aa.cap.getCapID(s[1],s[2],s[3])).getSuccess()&&(o=s.getOutput(),Dpr.hasProjectSheets(r,o)||A(e,Dpr.Actions.REVISION_REQUEST_APPROVED_NOTIFICATION,function(e,t){var r={};return r.revisionAltID=o.getCustomID()+"",r.dprRevisionConditionsLink=Dpr.getAcaDeepLinkUrl(o,a,t.acaUrl,"CONDITIONSLIST"),r.requestType="Revision",r}))):Dpr.hasProjectSheets(r,t)||A(e,Dpr.Actions.PLAN_REVIEW_APPROVED_NOTIFICATION))},Dpr.Actions.receiveReviewPackageSwimlanes=function(e){var t=e.capId;!e.process.autoAccept||(e=Dpr.getDisciplineByWorkflowTask(e.taskName))&&Dpr.acceptReviewPackages(Dpr.getAdminUser(),t,e.id)},Dpr.Actions.reOpenLatestReviewPackageSwimlanes=function(e){},Dpr.Actions.acceptReviewPackagesSwimlanes=function(e){var t=e.capId,r=e.user;(e=Dpr.getDisciplineByWorkflowTask(e.taskName))&&Dpr.acceptReviewPackages(r,t,e.id)},Dpr.Actions.linkMasterPlans=function(e){var t=e.capId,r=Dpr.Actions.getConfigSection(e,Dpr.Actions.SETTINGS_SECTION);r&&r.masterPlans&&r.masterPlans.masterPlanNumber&&r.masterPlans.masterPlanNumber.field&&((r=Dpr.getCustomField(t,r.masterPlans.masterPlanNumber.field))&&((r=aa.cap.getCapID(r)).getSuccess()?(r=r.getOutput(),e.parent=r,Dpr.addParent(t,r)):Dpr.error("Unable to link master plan. Master plan number is invalid.")))},Dpr.Actions.addProjectToRevisionGroup=function(e){var t=e.capId,r=v(e,Dpr.Actions.PROJECT_GROUPS_SECTION),o=e.user,e=(e=e.parent)||Dpr.getParentRecord(t);r&&r.revision&&e&&Dpr.addProject2ParentGroup(o,t,{parent:e,prefix:r.revision.prefix,type:"revision"})},Dpr.Actions.assignRevisionNumber=function(e){var t,r=e.capId,o=e.user,s=e.projectType,a=v(e,Dpr.Actions.SETTINGS_SECTION),n=Dpr.getParentRecord(r);if(a&&a.revision&&a.revision.revisionCountCustomField){var i=Dpr.getCustomField(n,a.revision.revisionCountCustomField);if(i)for(var p=parseInt(i);p++,t=n.getCustomID()+"."+Dpr.zeroPad(p,3),aa.cap.getCapID(t).getSuccess(););}else t=Dpr.getNextRevisionNumber(r,s.id,n);t&&aa.cap.updateCapAltID(r,t).getSuccess()&&(Dpr.updateProject(o,r,{number:t}),a&&a.revision&&a.revision.revisionCountCustomField&&p&&Dpr.setCustomField(n,a.revision.revisionCountCustomField,p+"")),(r=c(e,Dpr.Actions.REVISION_REQUEST_ACCEPTED_NOTIFICATION))&&((a={}).parentAltID=n.getCustomID()+"",a.newRevisionNumber=t,a.requestType="Revision",m(e,r,a))},Dpr.Actions.createApprovedPlansRevision=function(e,t){var r=e.capId,o=e.user,s=["revision","pof"],a=v(e,Dpr.Actions.PRINTSETS_SECTION),n=Dpr.getParentRecord(r);if(!(a&&a.approvedTemplate&&a.approvedTemplate.template)&&(Dpr.updateProject(o,r,{issued:"Y"}),a&&a.approvedPlans&&n)){var i=a.approvedPlans,p=Dpr.getProjectGroups(o,n);if(0<p.length)for(var c,u=0;u<p.length;u++)if(c=Dpr.matches(p[u].type,s)?p[u].id:c){var d,l,g={};if(g.group=c,n&&(g.project=r.getId()+""),i.name?(d=P(e,i.name),g.name=d||"Print Set: "+r.getCustomID()):(d=R(e,i.namePrefix),g.name=d?d+r.getCustomID():"Print Set: "+r.getCustomID()),i.description?(l=C(e,i.description),g.description=l||""):(l=h(e,i.descriptionPrefix),g.description=l?l+r.getCustomID():""),!i.type)throw new Error("Unable to create print set, type is not configured for module: "+module);g.type=E(e,i.type),g.includeStamps=i.includeStamps,g.includeNotes=i.includeNotes,g.includeConditions=i.includeConditions,i.watermarks&&(g.watermarks=T(e,i.watermarks)),i.fields&&(g.fields=w(e,i.fields)),t&&t.sheets&&(g.sheets=D(t.sheets,e)),g.issued=!0,Dpr.hasProjectSheets(o,r)?Dpr.createSheetsPrintSet(o,n,g):Dpr.log("Failed to create printset for project: "+r.getId()+", no available sheets.");break}}},Dpr.Actions.runParentStepCoordination=function(e){t(e,"coordination")},Dpr.Actions.runParentStepReview=function(e){t(e,"review")},Dpr.Actions.getRevisionParent=function(e){var t,r=e.capId,o=(e.user,e.parentCapString),s=v(e,Dpr.Actions.SETTINGS_SECTION);if(o&&0<o.length&&(t=o.split("-"),a=aa.cap.getCapID(t[0],t[1],t[2]).getOutput(),e.parent=a),a||(a=Dpr.getParentRecord(r),e.parent=a),!a&&s&&s.revision&&s.revision.parentCustomField&&((t=Dpr.getCustomField(r,s.revision.parentCustomField))&&((s=aa.cap.getCapID(t)).getSuccess()?(a=s.getOutput(),e.parent=a,Dpr.addParent(r,a)):Dpr.error("Unable to retrieve parent record for revision: "+t))),!a)throw new Error("Unable to process retrieve parent record for revision.");var a=aa.cap.getCap(a).getOutput().getCapType().toString()+"",a=(a=Dpr.getProjectType(a)).process&&d.processes[a.process]?d.processes[a.process]:d.processes.default;e.process.type=a.type},Dpr.Actions.createParentProject=function(e){var t,r,o,s,a,n,i=(i=e.parent)||Dpr.getParentRecord(e.capId);Dpr.isProject(i)&&!Dpr.projectExists(Dpr.getAdminUser(),i)&&(t=aa.cap.getCap(i).getOutput().getCapType().toString()+"",r=Dpr.getRecordPrimaryAddress(i),o=Dpr.getRecordPrimaryParcel(i),a=(s=Dpr.getProjectType(t)).process&&d.processes[s.process]?d.processes[s.process]:d.processes.default,(n={}).number=i.getCustomID()+"",n.type=s.name,n.typeId=t,n.process=a.type,n.description=Dpr.getWorkDescription(i),n.address=r.address||"",n.city=r.city||"",n.state=r.state||"",n.zip=r.zip||"",n.parcel=o.parcel||"",n.organization=e.module||"",(e=cap.getSpecialText())&&(n.name=e+""),n.properties=void 0,Dpr.createProject(Dpr.getAdminUser(),i,n),Dpr.updateProject(Dpr.getAdminUser(),i,{status:"approved"}))},Dpr.Actions.copyReferenceDataToChild=function(e){var t=e.capId;(e=(e=e.parent)||Dpr.getParentRecord(t))&&(Dpr.copyAddresses(e,t),Dpr.copyParcels(e,t),Dpr.copyOwner(e,t),Dpr.copyContacts(e,t),Dpr.copyLicensedProf(e,t))},Dpr.Actions.processProjectRevisionGroup=function(e){var t=e.capId,r=(e.user,e.parent),o=v(e,Dpr.Actions.SETTINGS_SECTION);(r=r||Dpr.getParentRecord(t))&&(e.parent=r,o&&o.revision&&o.revision.revisionCountCustomField&&(Dpr.getCustomField(r,o.revision.revisionCountCustomField)||Dpr.setCustomField(r,o.revision.revisionCountCustomField,"0")))},Dpr.Actions.editRevisionApplicationName=function(e){var t=e.capId,r=e.user;(e=(e=e.parent)||Dpr.getParentRecord(t))&&(e="Revision Request ("+e.getCustomID()+")",Dpr.editAppName(e,t),Dpr.updateProject(r,t,{name:e}))},Dpr.Actions.onWtuaReviewRevise=function(e){e.capId,e.user},Dpr.Actions.onWtuaReviewReceive=function(e){e.capId,e.user},Dpr.Actions.onValidateNone=function(e){},Dpr.Actions.onValidateApplicationReview=function(e){Dpr.isOpenSubmittals(e.user,e.capId)&&(e.newStatus.message="Project contains one or more review packages that are not fully submitted.",e.cancel=!0)},Dpr.Actions.onValidateApplicationReviewRevision=function(e){var t=e.capId,r=e.user,o=Dpr.getParentRecord(t);if(o)if(Dpr.projectExists(r,o)){var s=!1,a=Dpr.getProjectSubmittals(r,o);if(0<a.length)for(var n=0;n<a.length;n++)if("ACCEPTED"===a[n].status.toUpperCase()){s=!0;break}s?Dpr.isOpenSubmittals(r,t)&&(e.newStatus.message="Project contains one or more review packages that are not fully submitted.",e.cancel=!0):(e.newStatus.message="You must upload the most recent Approved Plans and accept the review package on the parent plan room project ("+o.getCustomID()+") before moving forward.",e.cancel=!0)}else e.newStatus.message="A Digital Plan Room project was not found for the parent permit ("+o.getCustomID()+"). \r\n",e.newStatus.message+="You must create a plan room project for the parent and upload the most recent AJC before moving forward.",e.cancel=!0},Dpr.Actions.onValidateApplicationReOpen=o,Dpr.Actions.onValidateReOpen=o,Dpr.Actions.onValidateDistributionRoute=function(e){Dpr.isOpenSubmittals(e.user,e.capId)&&(e.newStatus.message="Project contains one or more review packages that are not fully submitted.",e.cancel=!0)},Dpr.Actions.onValidateReviewApprove=function(e){Dpr.hasOpenIssues(e.user,e.capId,e.taskName)?(e.cancel=!0,e.newStatus.message="Issues open for "+e.taskName+". Cannot update to "+e.taskStatus+"."):e.process.approvedConditionCheck&&Dpr.hasOpenConditions(e.user,e.capId,e.taskName)&&(e.cancel=!0,e.newStatus.message="Conditions open for "+e.taskName+". Cannot update to "+e.taskStatus+".")},Dpr.Actions.onValidateReviewPartialApprove=function(e){Dpr.hasOpenIssues(e.user,e.capId,e.taskName)?(e.cancel=!0,e.newStatus.message="Issues open for "+e.taskName+". Cannot update to "+e.taskStatus+"."):e.process.partialApprovedConditionCheck&&!Dpr.hasOpenConditions(e.user,e.capId,e.taskName)&&(e.cancel=!0,e.newStatus.message="Conditions do not exist for "+e.taskName+". Cannot update to "+e.taskStatus+".")},Dpr.Actions.onValidateReviewRevise=function(e){Dpr.hasOpenIssues(e.user,e.capId,e.taskName)||(e.cancel=!0,e.newStatus.message="No issues exist for "+e.taskName+", cannot be updated to "+e.taskStatus+"."),Dpr.hasIssuesIn(e.user,e.capId,["inreview"],e.taskName)&&(e.cancel=!0,e.newStatus.message="'In Review' issues still open for "+e.taskName+", cannot be updated to "+e.taskStatus+".")},Dpr.Actions.onValidateCoordinationRevise=function(e){Dpr.hasOpenIssues(e.user,e.capId)||(e.cancel=!0,e.newStatus.message="No open issues, cannot be updated to "+e.taskStatus+"."),Dpr.hasIssuesIn(e.user,e.capId,["inreview"])&&(e.cancel=!0,e.newStatus.message="'In Review' issues open, cannot be updated to "+e.taskStatus+".")},Dpr.Actions.onValidateCoordinationReady=function(e){var t;Dpr.hasOpenIssues(e.user,e.capId)?(t=Dpr.getOpenIssueDisciplines(e.user,e.capId).join(", "),e.cancel=!0,e.newStatus.message="Issues still open for disciplines: "+t+"."):Dpr.isOpenSubmittals(e.user,e.capId,null,null,["ACCEPTED"])&&(e.newStatus.message="Project contains one or more review packages that are not yet accepted.",e.cancel=!0)},Dpr.Actions.onValidateCoordinationApprove=function(e){var t;Dpr.hasOpenIssues(e.user,e.capId)?(t=Dpr.getOpenIssueDisciplines(e.user,e.capId).join(", "),e.cancel=!0,e.newStatus.message="Issues still open for disciplines: "+t+"."):e.process.approvedConditionCheck&&Dpr.hasOpenConditions(e.user,e.capId)&&(e.cancel=!0,e.newStatus.message="Conditions open for project. Cannot update to "+e.taskStatus+".")},Dpr.Actions.onValidateCoordinationPartialApprove=function(e){var t;Dpr.hasOpenIssues(e.user,e.capId)?(t=Dpr.getOpenIssueDisciplines(e.user,e.capId).join(", "),e.cancel=!0,e.newStatus.message="Issues still open for disciplines: "+t+"."):e.process.partialApprovedConditionCheck&&!Dpr.hasOpenConditions(e.user,e.capId)&&(e.cancel=!0,e.newStatus.message="Conditions do not exist. Cannot update to "+e.taskStatus+".")},Dpr.Actions.onValidateReviewRouteSwimlanes=function(e){var t=e.capId,r=e.user,o=Dpr.getDisciplineByWorkflowTask(e.taskName);o&&Dpr.isOpenSubmittals(r,t,null,o.id)&&(e.newStatus.message="Project contains review packages that are not yet submitted for "+o.id+".",e.cancel=!0)},Dpr.Actions.onDocumentsDeleteBefore=function(e){var i,t=e.docIds,s=e.user;if(!t||0===t.size())return"Documents ids not passed in context.";if(function(e){for(var t=e.iterator();t.hasNext();){var r=t.next(),r=aa.document.getDocumentByPK(r);if(r.getSuccess()){r=r.getOutput();if(r&&r.getEntityType()+""=="CAP")return i=i||r.getCapID(),Dpr.isProject(i)&&Dpr.projectExists(Dpr.getAdminUser(),i)}}}(t)){var r,o,t=function(e,t){for(var r={files:[],printSets:[]},o=Dpr.getPrintSetTypes(),s=e.iterator();s.hasNext();){var a=s.next(),n=aa.document.getDocumentByPK(a);if(!n.getSuccess())return;n=n.getOutput();n&&(i=i||n.getCapID(),n=n.docCategory+"",Dpr.findFirstMatch(n,t)&&r.files.push(a+""),Dpr.findFirstMatch(n,o)&&r.printSets.push(a+""))}return r}(t,Dpr.getFileTypes());if(!t)return"Error retrieving document information.";t.printSets.length&&(r=function(e){for(var e=e.join(","),t=Dpr.getFilesFromDocuments(s,i,e),r=[],o=0;o<t.length;o++)r.push(t[o].id);return r}(t.printSets)),t.files.length&&(o=function(e){for(var e=e.join(","),t=Dpr.getFilesFromDocuments(s,i,e),r=[],o=0;o<t.length;o++)"attachment"!==t[o].role&&"accepted"===t[o].status||(Dpr.log("File id to delete: "+t[o].id),r.push(t[o].id));return r}(t.files)),r&&function(e){for(var t=0;t<e.length;t++)Dpr.deletePrintSet(s,i,e[t],{discard:!1})}(r),o&&function(e){for(var t=0;t<e.length;t++)Dpr.deleteFile(s,e[t])}(o)}},Dpr.Actions.onSubmittalFinished=F,Dpr.Actions.onSubmittalFinishedSwimlanes=function(e){var t,r,o,s,a,n;"amend"===(s=e).type&&s.process.submittalOmits?Dpr.log("Submittal action suppressed"):(t=e.capId,a=e.recipient,n=e.process.workflow,r=e.user,e.user=Dpr.getAdminUser(),s="Y"===(o=e.ready).toUpperCase()?n.review.actions.receive.statuses:n.review.actions&&n.review.actions.notready&&n.review.actions.notready.statuses?n.review.actions.notready.statuses:[],a?(n=Dpr.lookupSetting("DPR_DISCIPLINES",a))&&s&&0<s.length&&(n.task?(a=Dpr.getTask(t,n.task))&&U(e,a,s,"Review package submitted by: "+r,o):(n=Dpr.getTasks(t,n.tasks.split(",")))&&n[0]&&U(e,n[0],s,"Review package submitted by: "+r,o)):F(e))},Dpr.Actions.onSubmittalFinishedRevision=function(e){var t;"amend"===(t=e).type&&t.process.submittalOmits?Dpr.log("Submittal action suppressed"):(t=e.capId,t=Dpr.getParentRecord(t),t=aa.cap.getCap(t).getOutput().getCapType().toString()+"",(t=((t=Dpr.getProjectType(t)).process&&d.processes[t.process]?d.processes[t.process]:d.processes.default).submit)&&t.actions&&N(t.actions,e))},Dpr.Actions.onSubmittalFinishedSync=function(e){e.process.submittalDocumentTypesSync&&L(e)},Dpr.Actions.onAttachmentUploaded=function(e){var t=e.cap.getCapType().toString()+"",t=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",t);e.projectType=t,e.process=t.process&&d.processes[t.process]?d.processes[t.process]:d.processes.default,(t=e.process.attachment)&&t.actions&&N(t.actions,e)},Dpr.Actions.onPrintSetArchive=function(e){var t=e.cap.getCapType().toString()+"",t=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",t);e.projectType=t,e.process=t.process&&d.processes[t.process]?d.processes[t.process]:d.processes.default,(t=e.process.psarchive)&&t.actions&&N(t.actions,e)},Dpr.Actions.onFileProcessingComplete=function(e){var t,r=e.capId,o=e.user,s=e.module,a=e.submittalId,n={};n.submittalId=a,-1===o.indexOf("PUBLICUSER")?t=c(e,Dpr.Actions.FILE_PROCESSING_COMPLETE_STAFF_NOTIFICATION):(t=c(e,Dpr.Actions.FILE_PROCESSING_COMPLETE_NOTIFICATION))&&(n.dprLink=Dpr.getAcaDeepLinkUrl(r,s,t.acaUrl,"SHEETVERSIONING",a)),t&&m(e,t,n)},Dpr.Actions.onAlert=function(e){var t=e.capId,r=e.cap,o=e.user,r=r.getCapType().toString()+"",r=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",r);e.projectType=r,e.process=r.process&&d.processes[r.process]?d.processes[r.process]:d.processes.default;var a=e.process.workflow,r=function(e,t){var r,o=[];for(r in a)if(!Dpr.matches(r,t))for(var s in a[r].actions)s===e&&o.push(r);return o}("alert",["review"]);if((e=function(e,t){for(var r=[],o=0;o<t.length;o++)r=r.concat(a[t[o]].tasks);return Dpr.getTasks(e,r,!0)}(t,r)).length){for(var s=e[0],e=s.getTaskDescription()+"",n=function(e,t){for(var r=0;r<t.length;r++){var o=t[r];if(Dpr.matches(e,a[o].tasks))return a[o]}}(e,r).actions.alert.statuses,i=!0,p=0;p<n.length;p++)if(s.getDisposition()+""===n[p]){i=!1;break}i&&(Dpr.updateTask(t,Dpr.getAdminUser(),e,n[0],"File validation alert for: "+o,"","U"),Dpr.triggerWtuaEvent(t,o,e,n[0],s.getProcessID()+""))}},Dpr.Actions.onException=function(e){var t=e.capId,r=e.errorCode,o=e.errorMessage,s=e.errorStack;if("DPR_EMSE_ERROR"===r)for(var a,n="",i=aa.env.getParamValues().keys();i.hasMoreElements();)n+=(a=i.nextElement())+" = "+aa.env.getValue(a)+"; ";var p={};if(p.dprErrorCode=r,p.dprErrorMessage=o,"DPR_EMSE_ERROR"===r&&(p.eventDetails="Parameters: "+n,p.dprErrorStack=s),"DPR_ERROR_FILE_FAILED"===r&&e.submittalId){var c=e.submittalId,u=[],d=[],l=[],g=Dpr.getSubmittalFiles(Dpr.getAdminUser(),t,c);if(g&&0<g.length){for(var D=0;D<g.length;D++){var f=g[D];"failed"===f.status&&u.push(f)}if(u&&0<u.length){for(var m=0;m<u.length;m++){var I=u[m];Dpr.matches(I.statusDetail,Dpr.Actions.FAILED_POSSIBLE_RETRY_CODES)?d.push(I):Dpr.matches(I.statusDetail,Dpr.Actions.FAILED_FILE_ISSUE_CODES)&&l.push(I)}var v=[];if((d&&0<d.length||l&&0<l.length)&&(c=Dpr.getProjectSubmittal(Dpr.getAdminUser(),t,c),v.push("The following files failed to process in the review package "+c.name+":")),d&&0<d.length){v.push("**************************"),v.push("The following files should be retried:");for(var S=0;S<d.length;S++){var E=d[S];v.push(E.name)}}if(l&&0<l.length){v.push("**************************"),v.push("The following files could not be processed:");for(D=0;D<l.length;D++){var P=l[D];v.push(P.name)}}v&&0<v.length&&(p.failedFileDetails=v.join("\n"))}}}if(A(e,Dpr.Actions.ERROR_NOTIFICATION,p,{note:r,comment:r+": "+o}),"DPR_EMSE_ERROR"===r)try{var R={};R.error=r,R.env=Dpr.getEnvironment(),R.dump=r+": "+o+(t?" on project "+t.getCustomID()+" ("+t.getId()+")":""),n&&(R.dump+=": EMSE Environment Details ("+n+")"),s&&(R.dump+=": EMSE Stack ("+s+")"),Dpr.sendError(R)}catch(e){Dpr.log("Failed to send error to DPR hub: "+e.message+(e.stack?"\nStack: "+e.stack:""))}},Dpr.Actions.onRequest=function(e){var t=e.requestMessage,r=e.requestCode;A(e,Dpr.Actions.REQUEST_NOTIFICATION,null,{note:"",comment:t+"("+r+")"})},Dpr.Actions.taskUpdateValidate=function(e){var t=e.workflowTask;if(!t)throw new Error("Unable to update workflow Missing workflow task "+r.getCustomID());var r=e.capId,o=(s=t.id.split("-"))[0],s=s[1];if(!(s=aa.workflow.getTask(r,o,s)).getSuccess())throw new Error("Unable to update workflow task not found "+r.getCustomID());if(!(s=s.getOutput()))throw new Error("Unable to update workflow task not found "+r.getCustomID());if(r=t.status,e.newStatus=r,e.taskStatus=r.value,e.taskName=s.getTaskDescription()+"",e.comment=t.comment,t=s.getActiveFlag()+"",s=s.getCompleteFlag()+"","Y"!=t||"N"!=s)e.cancel=!0,e.newStatus.message="Task is not currently active. Cannot be Updated.";else{var a,n,i=e.process.workflow;for(a in i)i.hasOwnProperty(a)&&(n=i[a],("review"===a&&Dpr.isDisciplineTask(e.taskName)||n.tasks&&Dpr.matches(e.taskName,n.tasks))&&I(n,e,!0))}},Dpr.Actions.taskUpdate=function(e){var t=e.workflowTask;if(!t)throw new Error("Unable to update workflow Missing workflow task "+r.getCustomID());var r=e.capId,o=t.id.split("-"),s=o[0],a=o[1];if(!(o=aa.workflow.getTask(r,s,a)).getSuccess())throw new Error("Unable to update workflow task not found "+r.getCustomID());if(!(s=o.getOutput()))throw new Error("Unable to update workflow task not found "+r.getCustomID());t.assignedUser&&t.assignedUser.value?Dpr.assignTaskItem(s,t.assignedUser.value):t.assignedToDepartment&&t.assignedToDepartment.value&&Dpr.assignDepartmentTaskItem(s,t.assignedToDepartment.value),t.dueDate&&Dpr.editTaskDueDate(s,t.dueDate),a=t.status.value,o=s.getTaskDescription()+"",a&&(Dpr.updateTaskItem(r,e.user,s,a,t.comment,""),Dpr.triggerWtuaEvent(r,e.user,o,a,s.getProcessID()+""))}}(),Dpr.Auth={},function(){var l,g;function u(){return"SELECT 'contact' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_CONTACT_TYPE AS COMMENT FROM B3CONTACT D JOIN XPUBLICUSER_PEOPLE X ON D.G1_CONTACT_NBR = X.ENT_ID AND X.AGENCY = D.SERV_PROV_CODE WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE='REF_CONTACT' AND X.USER_SEQ_NBR = ?"}function d(){return"SELECT 'lp' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_LICENSE_TYPE AS COMMENT FROM B3CONTRA D JOIN XPUBLIC_USER_PROV_LIC X ON D.SERV_PROV_CODE = X.SERV_PROV_CODE AND D.LIC_SEQ_NBR = X.LIC_SEQ_NBR WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.USER_SEQ_NBR = ?"}function D(){return"SELECT 'creator' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_CREATED_BY AS COMMENT FROM BPERMIT_DETAIL D WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND D.B1_CREATED_BY = ?"}function f(){return"SELECT 'owner' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, '' AS COMMENT FROM B3OWNERS D JOIN XPUBLICUSER_PEOPLE X ON D.L1_OWNER_NBR = X.ENT_ID WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE='REF_OWNER' AND X.USER_SEQ_NBR = ?"}function m(){return'SELECT \'contact\' AS "ROLE", D.B1_PER_ID1 || D.B1_PER_ID2 || D.B1_PER_ID3 AS "RECORD_ID", D.B1_CONTACT_TYPE AS "COMMENT" FROM B3CONTACT D JOIN XPUBLICUSER_PEOPLE X ON D.G1_CONTACT_NBR = X.ENT_ID AND X.AGENCY = D.SERV_PROV_CODE WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE=\'REF_CONTACT\' AND X.USER_SEQ_NBR = ?'}function I(){return'SELECT \'lp\' AS "ROLE", D.B1_PER_ID1 || D.B1_PER_ID2 || D.B1_PER_ID3 AS "RECORD_ID", D.B1_LICENSE_TYPE AS "COMMENT" FROM B3CONTRA D JOIN XPUBLIC_USER_PROV_LIC X ON D.SERV_PROV_CODE = X.SERV_PROV_CODE AND D.LIC_SEQ_NBR = X.LIC_SEQ_NBR WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.USER_SEQ_NBR = ?'}function v(){return'SELECT \'creator\' AS "ROLE", D.B1_PER_ID1 || D.B1_PER_ID2 || D.B1_PER_ID3 AS "RECORD_ID", D.B1_CREATED_BY AS "COMMENT" FROM BPERMIT_DETAIL D WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND D.B1_CREATED_BY = ?'}function S(){return"SELECT 'owner' AS \"ROLE\", D.B1_PER_ID1 || D.B1_PER_ID2 || D.B1_PER_ID3 AS \"RECORD_ID\", '' AS \"COMMENT\" FROM B3OWNERS D JOIN XPUBLICUSER_PEOPLE X ON D.L1_OWNER_NBR = X.ENT_ID WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE='REF_OWNER' AND X.USER_SEQ_NBR = ?"}Dpr.Auth.getAcaAuthRoles=function(e,t){for(var r,o=[],s=function(e){e=aa.publicUser.getPublicUserByPUser(e);{if(e.getSuccess()){e=e.getOutput();return null!==e&&e.getUserSeqNum()}return!1}}(e),a=(r=function(e,t){t=aa.bizDomain.getBizDomainByValue(e,t);{var r;t.getSuccess()&&(r=t.getOutput(),r=r.getDescription()+"")}return r}("DPR_CONFIGS","ACA_AUTHORIZATION"))&&0<r.length?r.split(","):void 0,n={mssql:function(e){var t=[];if(e)for(var r=0;r<e.length;r++)switch(e[r].trim().toLowerCase()){case"contact":t.push(u());break;case"lp":t.push(d());break;case"creator":t.push(D());break;case"owner":t.push(f());break;case"delegate":for(var o=0;o<e.length;o++)switch(e[o].trim().toLowerCase()){case"contact":t.push(function(){var e="SELECT 'contact-delegate' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_CONTACT_TYPE AS COMMENT FROM B3CONTACT D JOIN XPUBLICUSER_PEOPLE X ON D.G1_CONTACT_NBR = X.ENT_ID AND X.AGENCY = D.SERV_PROV_CODE";return e+=" JOIN XPROXYUSER P ON X.USER_SEQ_NBR = P.USER_SEQ_NBR AND X.AGENCY = P.SERV_PROV_CODE",e+=" WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE='REF_CONTACT' AND P.PROXYUSER_SEQ_NBR = ? AND P.STATUS = 'A'"}());break;case"lp":t.push(function(){var e="SELECT 'lp-delegate' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_LICENSE_TYPE AS COMMENT FROM B3CONTRA D JOIN XPUBLIC_USER_PROV_LIC X ON D.SERV_PROV_CODE = X.SERV_PROV_CODE AND D.LIC_SEQ_NBR = X.LIC_SEQ_NBR";return e+=" JOIN XPROXYUSER P ON X.USER_SEQ_NBR = P.USER_SEQ_NBR AND X.SERV_PROV_CODE = P.SERV_PROV_CODE",e+=" WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND P.PROXYUSER_SEQ_NBR = ? AND P.STATUS = 'A'"}());break;case"creator":t.push(function(){var e="SELECT 'creator-delegate' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, D.B1_CREATED_BY AS COMMENT FROM BPERMIT_DETAIL D";return e+=" JOIN XPROXYUSER P ON D.SERV_PROV_CODE = P.SERV_PROV_CODE AND D.B1_CREATED_BY = CONCAT('PUBLICUSER',TRIM(STR(P.USER_SEQ_NBR)))",e+=" WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND P.PROXYUSER_SEQ_NBR = ? AND P.STATUS = 'A'"}());break;case"owner":t.push(function(){var e="SELECT 'owner-delegate' AS ROLE, D.B1_PER_ID1 + D.B1_PER_ID2 + D.B1_PER_ID3 AS RECORD_ID, '' AS COMMENT FROM B3OWNERS D JOIN XPUBLICUSER_PEOPLE X ON D.L1_OWNER_NBR = X.ENT_ID";return e+=" JOIN XPROXYUSER P ON X.USER_SEQ_NBR = P.USER_SEQ_NBR AND X.AGENCY = P.SERV_PROV_CODE",e+=" WHERE D.SERV_PROV_CODE = ? AND D.B1_PER_ID1 = ? AND D.B1_PER_ID2 = ? AND D.B1_PER_ID3 = ? AND X.ENT_TYPE='REF_OWNER' AND P.PROXYUSER_SEQ_NBR = ? AND P.STATUS = 'A'"}())}}else t=[u(),d(),D(),f()];return 0<t.length?t.join(" UNION "):void 0}(r=a),oracle:function(e){var t=[];if(e)for(var r=0;r<e.length;r++)switch(e[r].trim().toLowerCase()){case"contact":t.push(m());break;case"lp":t.push(I());break;case"creator":t.push(v());break;case"owner":t.push(S())}else t=[m(),I(),v(),S()];return 0<t.length?t.join(" UNION "):void 0}(r)},i=0;i<t.length;i++){var p,c=function(e,t,r){var o=null,s=null,a=null,n=[];try{var i;o=aa.db&&aa.db.getConnection?aa.db.getConnection():(l||(i=new javax.naming.InitialContext,l=i.lookup("java:/"+Dpr.getDbContext())),l.getConnection());var p=-1<(g=g||o.getMetaData().getDatabaseProductName()).indexOf("Microsoft")?e.mssql:e.oracle;if(s=aa.db&&aa.db.prepareStatement?aa.db.prepareStatement(o,p):o.prepareStatement(p),r)for(var c=0;c<r.length;c++)if(function(e){return"string"==typeof e||d(e,"java.lang.String")}(r[c]))s.setString(c+1,r[c]);else if(function(e){return d(e,"java.lang.Long")}(r[c]))s.setLong(c+1,r[c]);else if(function(e){return d(e,"java.lang.Integer")}(r[c]))s.setInt(c+1,r[c]);else if(function(e){return"number"==typeof e||d(e,"java.lang.Double")}(r[c]))s.setDouble(c+1,r[c]);else{if(!function(e){return"boolean"==typeof e||d(e,"java.lang.Boolean")}(r[c]))throw new Error("Type not supported as query parameter.");s.setBoolean(c+1,r[c])}for(a=s.executeQuery();a.next();){var u=t(a);n.push(u)}}finally{try{a&&(a.close(),a=null)}catch(e){Dpr.log("Failed to close the database result set object."+e)}try{s&&(s.close(),s=null)}catch(e){Dpr.log("Failed to close the database prepare statement object."+e)}try{o&&(o.close(),o=null)}catch(e){Dpr.log("Failed to close the database connection."+e)}}function d(e,t){return e.getClass&&e.getClass().getName().equals(t)}return n}(n,function(e){return e.getString("ROLE")+""},function(e,t,r,o){var s=e.split("-");{if(o){for(var a=[],n=0;n<o.length;n++)switch(o[n].trim().toLowerCase()){case"contact":case"lp":a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]),a.push(r);break;case"creator":a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]),a.push(t);break;case"owner":a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]),a.push(r);break;case"delegate":for(var i=0;i<o.length;i++)switch(o[i].trim().toLowerCase()){case"contact":case"lp":case"creator":case"owner":a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]),a.push(r)}}return a}return[s[0],s[1],s[2],s[3],r,s[0],s[1],s[2],s[3],r,s[0],s[1],s[2],s[3],t,s[0],s[1],s[2],s[3],r]}}(t[i],e,s,a));0<c.length&&((p={}).id=t[i]+"",p.claims=c,o.push(p))}return o}}();