var Dpr=Dpr||{};!function(){function loadLibrary(){eval(loadScript("INCLUDES_DPR_LIBRARY")),Dpr.init(!0)}function loadScript(e){return e=e.toUpperCase(),aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.EMSEBusiness").getOutput().getScriptByPK(aa.getServiceProviderCode(),e,"ADMIN").getScriptText()+""}function getProjectType(e){var r=aa.cap.getCap(e).getOutput().getCapType().toString()+"",e=aa.bizDomain.getBizDomainByValue("DPR_RECORD_TYPES_ENABLED",r);if(e.getSuccess()){e=e.getOutput();return"A"==e.getAuditStatus()+""?{id:r,raw:e.getDescription()}:null}return null}function isProject(e){return null!==getProjectType(e)}function fireAction(e){function r(e){var r=aa.env.getValue("CurrentUserID")+"";if(!r)return Dpr.error("No user for transaction."),null;var t,a,n,s,i,o,n=(s=aa.env.getValue("PermitId1"),i=aa.env.getValue("PermitId2"),o=aa.env.getValue("PermitId3"),s&&i&&o&&(i+="",o+="",(s+="").length&&i.length&&o.length&&((n=aa.cap.getCapID(s,i,o)).getSuccess()?u=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage()))),u||(t=aa.env.getValue("CapId"))&&(t+="").length&&(a=t.split("-"),(n=aa.cap.getCapID(a[0],a[1],a[2])).getSuccess()?u=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),u||(t=aa.env.getValue("CapID"))&&(t+="").length&&(a=t.split("-"),(n=aa.cap.getCapID(a[0],a[1],a[2])).getSuccess()?u=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),u||((n=aa.env.getValue("CapIdModel"))&&""!=n?u=n:Dpr.error("capId not found")),u);if(n){var u=getProjectType(n);if(u){u={user:r,capId:n,rawType:u};return e&&(e.taskName&&(u.taskName=e.taskName),e.taskStatus&&(u.taskStatus=e.taskStatus)),u}return null}return{user:r}}try{var t=aa.env.getValue("EventName")+"";if("V360InspectionResultSubmitAfter"==t)for(var a=aa.env.getValue("PermitId1Array"),n=aa.env.getValue("PermitId2Array"),s=aa.env.getValue("PermitId3Array"),i=aa.env.getValue("InspectionTypeArray"),o=aa.env.getValue("InspectionResultArray"),u=aa.env.getValue("InspectionIdArray"),c=0;c<a.length;c++){var p,l=aa.cap.getCapID(a[c],n[c],s[c]);l.getSuccess()&&(p=l.getOutput(),aa.env.setValue("PermitId1",p.getID1()),aa.env.setValue("PermitId2",p.getID2()),aa.env.setValue("PermitId3",p.getID3()),aa.env.setValue("InspectionId",u[c]),aa.env.setValue("InspectionType",i[c]),aa.env.setValue("InspectionResult",o[c]),(g=r(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g)))}else if("ApplicationDeleteBefore"==t)for(var d=aa.env.getValue("CapIDList").toArray(),c=0;c<d.length;c++){var g,I=(d[c]+"").split("-");aa.env.setValue("PermitId1",I[0]),aa.env.setValue("PermitId2",I[1]),aa.env.setValue("PermitId3",I[2]),(g=r(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g))}else(g=r(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g))}catch(e){Dpr.error("Fire action failed: "+e.message+(e.stack?"\nStack: "+e.stack:""))}}Dpr.error=function(e){aa.debug("DPR",e)},Dpr.loadScript=loadScript,Dpr.isProject=isProject,Dpr.load=loadLibrary,Dpr.fireAction=fireAction}(),Dpr.Api={},function(){Dpr.Api.authorize=function(){function setErrorEnvironment(e){aa.env.setValue("InterfaceReturnCode","1"),aa.env.setValue("InterfaceReturnMessage",e)}var userId=aa.env.getValue("userId")+"",recordIds=aa.env.getValue("recordIds")+"",recordIdsArray,authorization,userId;try{userId&&0!==userId.length?recordIds&&0!==recordIds.length?(userId=userId.toUpperCase(),0===userId.indexOf("PUBLICUSER")?(Dpr.Auth||(eval(Dpr.loadScript("INCLUDES_DPR_LIBRARY")),Dpr.init(!1)),recordIdsArray=recordIds.split(","),authorization=Dpr.Auth.getAcaAuthRoles(userId,recordIdsArray),aa.env.setValue("InterfaceReturnCode","0"),aa.env.setValue("InterfaceReturnMessage","Success"),aa.env.setValue("Data",JSON.stringify(authorization))):setErrorEnvironment("Bad request, staff user is not yet implemented")):setErrorEnvironment("Bad request, missing recordIds"):setErrorEnvironment("Bad request, missing userId")}catch(err){Dpr.error("DPR API failed with exception: "+err.message+(err.stack?"\nStack: "+err.stack:"")),setErrorEnvironment(err.message)}},Dpr.Api.authorize()}();