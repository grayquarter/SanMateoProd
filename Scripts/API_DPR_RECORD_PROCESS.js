var Dpr=Dpr||{};!function(){function loadLibrary(){eval(loadScript("INCLUDES_DPR_LIBRARY")),Dpr.init(!0)}function loadScript(e){return e=e.toUpperCase(),aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.EMSEBusiness").getOutput().getScriptByPK(aa.getServiceProviderCode(),e,"ADMIN").getScriptText()+""}function getProjectType(e){var t=aa.cap.getCap(e).getOutput().getCapType().toString()+"",e=aa.bizDomain.getBizDomainByValue("DPR_RECORD_TYPES_ENABLED",t);if(e.getSuccess()){e=e.getOutput();return"A"==e.getAuditStatus()+""?{id:t,raw:e.getDescription()}:null}return null}function isProject(e){return null!==getProjectType(e)}function fireAction(e){function t(e){var t=aa.env.getValue("CurrentUserID")+"";if(!t)return Dpr.error("No user for transaction."),null;var a,r,n,s,p,o,n=(s=aa.env.getValue("PermitId1"),p=aa.env.getValue("PermitId2"),o=aa.env.getValue("PermitId3"),s&&p&&o&&(p+="",o+="",(s+="").length&&p.length&&o.length&&((n=aa.cap.getCapID(s,p,o)).getSuccess()?i=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage()))),i||(a=aa.env.getValue("CapId"))&&(a+="").length&&(r=a.split("-"),(n=aa.cap.getCapID(r[0],r[1],r[2])).getSuccess()?i=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),i||(a=aa.env.getValue("CapID"))&&(a+="").length&&(r=a.split("-"),(n=aa.cap.getCapID(r[0],r[1],r[2])).getSuccess()?i=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),i||((n=aa.env.getValue("CapIdModel"))&&""!=n?i=n:Dpr.error("capId not found")),i);if(n){var i=getProjectType(n);if(i){i={user:t,capId:n,rawType:i};return e&&(e.taskName&&(i.taskName=e.taskName),e.taskStatus&&(i.taskStatus=e.taskStatus)),i}return null}return{user:t}}try{var a=aa.env.getValue("EventName")+"";if("V360InspectionResultSubmitAfter"==a)for(var r=aa.env.getValue("PermitId1Array"),n=aa.env.getValue("PermitId2Array"),s=aa.env.getValue("PermitId3Array"),p=aa.env.getValue("InspectionTypeArray"),o=aa.env.getValue("InspectionResultArray"),i=aa.env.getValue("InspectionIdArray"),c=0;c<r.length;c++){var u,g=aa.cap.getCapID(r[c],n[c],s[c]);g.getSuccess()&&(u=g.getOutput(),aa.env.setValue("PermitId1",u.getID1()),aa.env.setValue("PermitId2",u.getID2()),aa.env.setValue("PermitId3",u.getID3()),aa.env.setValue("InspectionId",i[c]),aa.env.setValue("InspectionType",p[c]),aa.env.setValue("InspectionResult",o[c]),(d=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(d)))}else if("ApplicationDeleteBefore"==a)for(var l=aa.env.getValue("CapIDList").toArray(),c=0;c<l.length;c++){var d,D=(l[c]+"").split("-");aa.env.setValue("PermitId1",D[0]),aa.env.setValue("PermitId2",D[1]),aa.env.setValue("PermitId3",D[2]),(d=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(d))}else(d=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(d))}catch(e){Dpr.error("Fire action failed: "+e.message+(e.stack?"\nStack: "+e.stack:""))}}Dpr.error=function(e){aa.debug("DPR",e)},Dpr.loadScript=loadScript,Dpr.isProject=isProject,Dpr.load=loadLibrary,Dpr.fireAction=fireAction}(),Dpr.Api={},Dpr.Api.getProcess=function(){function t(e){aa.env.setValue("InterfaceReturnCode","1"),aa.env.setValue("InterfaceReturnMessage",e)}var e=aa.env.getValue("userId")+"",a=aa.env.getValue("recordId")+"";try{if(e&&0!==e.length)if(a&&0!==a.length){var r=a.split("-"),n=aa.cap.getCapID(r[1],r[2],r[3]);if(!n.getSuccess())return void t("Bad request, Error retrieving capId");Dpr.Actions||Dpr.load();var s=Dpr.Actions.getConfig(),p={};p.capId=n.getOutput(),p.cap=aa.cap.getCap(p.capId).getOutput(),p.module=p.cap.getCapModel().getModuleName()+"",p.user=e,p.capType=p.cap.getCapType().toString()+"",p.projectType=Dpr.lookupSetting("DPR_RECORD_TYPES_ENABLED",p.capType),p.process=p.projectType.process&&s.processes[p.projectType.process]?s.processes[p.projectType.process]:s.processes.default;var o=Dpr.Actions.getProcessDetails(p),i=Dpr.Actions.getConfigSection(p,Dpr.Actions.SETTINGS_SECTION),c={};(c=i&&i.properties?Dpr.Actions.getProjectProperties(p,i.properties):c)&&0!==Object.keys(c).length&&(o.properties=c),aa.env.setValue("InterfaceReturnCode","0"),aa.env.setValue("InterfaceReturnMessage","Success"),aa.env.setValue("Data",JSON.stringify(o))}else t("Bad request, missing recordId");else t("Bad request, missing userId")}catch(e){Dpr.error("DPR API failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:"")),t(e.message)}},Dpr.Api.getProcess();