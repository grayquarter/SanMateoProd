var Dpr=Dpr||{};!function(){function loadLibrary(){eval(loadScript("INCLUDES_DPR_LIBRARY")),Dpr.init(!0)}function loadScript(e){return e=e.toUpperCase(),aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.EMSEBusiness").getOutput().getScriptByPK(aa.getServiceProviderCode(),e,"ADMIN").getScriptText()+""}function getProjectType(e){var t=aa.cap.getCap(e).getOutput().getCapType().toString()+"",e=aa.bizDomain.getBizDomainByValue("DPR_RECORD_TYPES_ENABLED",t);if(e.getSuccess()){e=e.getOutput();return"A"==e.getAuditStatus()+""?{id:t,raw:e.getDescription()}:null}return null}function isProject(e){return null!==getProjectType(e)}function fireAction(e){function t(e){var t=aa.env.getValue("CurrentUserID")+"";if(!t)return Dpr.error("No user for transaction."),null;var r,a,n,o,s,i,n=(o=aa.env.getValue("PermitId1"),s=aa.env.getValue("PermitId2"),i=aa.env.getValue("PermitId3"),o&&s&&i&&(s+="",i+="",(o+="").length&&s.length&&i.length&&((n=aa.cap.getCapID(o,s,i)).getSuccess()?p=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage()))),p||(r=aa.env.getValue("CapId"))&&(r+="").length&&(a=r.split("-"),(n=aa.cap.getCapID(a[0],a[1],a[2])).getSuccess()?p=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),p||(r=aa.env.getValue("CapID"))&&(r+="").length&&(a=r.split("-"),(n=aa.cap.getCapID(a[0],a[1],a[2])).getSuccess()?p=n.getOutput():Dpr.error("capId not found: "+n.getErrorMessage())),p||((n=aa.env.getValue("CapIdModel"))&&""!=n?p=n:Dpr.error("capId not found")),p);if(n){var p=getProjectType(n);if(p){p={user:t,capId:n,rawType:p};return e&&(e.taskName&&(p.taskName=e.taskName),e.taskStatus&&(p.taskStatus=e.taskStatus)),p}return null}return{user:t}}try{var r=aa.env.getValue("EventName")+"";if("V360InspectionResultSubmitAfter"==r)for(var a=aa.env.getValue("PermitId1Array"),n=aa.env.getValue("PermitId2Array"),o=aa.env.getValue("PermitId3Array"),s=aa.env.getValue("InspectionTypeArray"),i=aa.env.getValue("InspectionResultArray"),p=aa.env.getValue("InspectionIdArray"),c=0;c<a.length;c++){var u,d=aa.cap.getCapID(a[c],n[c],o[c]);d.getSuccess()&&(u=d.getOutput(),aa.env.setValue("PermitId1",u.getID1()),aa.env.setValue("PermitId2",u.getID2()),aa.env.setValue("PermitId3",u.getID3()),aa.env.setValue("InspectionId",p[c]),aa.env.setValue("InspectionType",s[c]),aa.env.setValue("InspectionResult",i[c]),(g=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g)))}else if("ApplicationDeleteBefore"==r)for(var l=aa.env.getValue("CapIDList").toArray(),c=0;c<l.length;c++){var g,f=(l[c]+"").split("-");aa.env.setValue("PermitId1",f[0]),aa.env.setValue("PermitId2",f[1]),aa.env.setValue("PermitId3",f[2]),(g=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g))}else(g=t(e))&&(Dpr.Actions||loadLibrary(),Dpr.Actions.invokeActionFromEvent(g))}catch(e){Dpr.error("Fire action failed: "+e.message+(e.stack?"\nStack: "+e.stack:""))}}Dpr.error=function(e){aa.debug("DPR",e)},Dpr.loadScript=loadScript,Dpr.isProject=isProject,Dpr.load=loadLibrary,Dpr.fireAction=fireAction}(),Dpr.Batch={},function(){Dpr.Batch.SEND_NOTIFICATIONS="sendNotifications",Dpr.Batch.ARCHIVE_PENDING_FILES="archiveFiles",Dpr.Batch.ARCHIVE_PENDING_PRINTSETS="archivePrintSets",Dpr.Batch.NOT_APPROVED_NO_OPEN_ISSUES="notApprovedNoOpenIssues";var config={jobs:{sendNotifications:{start:startJob,loader:loadNotificationRecords,actions:sendReminderNotification,progress:progressJob,end:endJob},archiveFiles:{type:"archive",start:startJob,loader:loadFilesPendingArchive,actions:archiveFile,progress:progressJobArchive,end:endJobArchive},archivePrintSets:{type:"archive",start:startJob,loader:loadPrintSetsPendingArchive,actions:archivePrintSet,progress:progressJobArchive,end:endJobArchive},notApprovedNoOpenIssues:{start:startJob,loader:loadNotApprovedNoOpenIssuesRecords,actions:[],progress:progressJob,end:endJobAnsweredIssues}}},jobTypes={default:{runner:defaultJobRunner},archive:{runner:archiveJobRunner}};function defaultJobRunner(e,t){if(e.loader)if(e.actions){var r={};e.start&&e.start(t,r);var a=e.loader(t);try{for(var n in a){var o=a[n].capId,s=a[n].cap||aa.cap.getCap(a[n].capId).getOutput(),i=a[n].capType||s.getCapType().toString()+"",p=a[n].module||s.getCapModel().getModuleName()+"",c={capId:o,cap:s,capType:i,module:p,user:Dpr.getAdminUser(),data:a[n].data||{}};runJobActions(e.actions,c,t),c.abort||e.progress(t,c,r)}}finally{e.end&&e.end(t,r)}}else Dpr.error("No actions provided for "+t.job+".");else Dpr.error("No loader provided for "+t.job+".")}function archiveJobRunner(e,t){if(e.loader)if(e.actions){var r={};e.start&&e.start(t,r);var a=e.loader(t);try{for(var n=0;n<a.length;n++){var o={file:a[n]};runJobActions(e.actions,o,t),o.abort||e.progress(t,o,r)}}finally{e.end&&e.end(t,r)}}else Dpr.error("No actions provided for "+t.job+".");else Dpr.error("No loader provided for "+t.job+".")}function merge(e,t){if(t)for(var r in t)!e.hasOwnProperty(r)||"object"!=typeof e[r]||Array.isArray(e[r])?e[r]=t[r]:merge(e[r],t[r])}function loadExtensions(){var extensions=Dpr.loadScript("INCLUDES_DPR_BATCH");extensions.length&&eval(extensions)}function runJobActions(e,t,r){if(e)if(e instanceof Array)for(var a=0;a<e.length;a++){var n=e[a];if("object"==typeof n&&n.action?n.action(t,n.options,r):n(t,null,r),t.abort)break}else"object"==typeof e&&e.action?e.action(t,e.options,r):e(t,null,r)}function runJob(t){try{var e;if(Dpr.Actions||Dpr.load(),(e=Dpr.Actions.getConfig().batch)||loadExtensions(),!(e=Dpr.Actions.getConfig().batch))return void Dpr.error("Batch section not defined.");if(!e.runs)return void Dpr.error("No batch runs defined.");merge(config,e);var r=config.runs[t];if(!r)return void Dpr.error("Job "+t+" is not defined.");var a=r.job&&config.jobs[r.job]?config.jobs[r.job]:void 0;if(!a)return void Dpr.error("Job run definition references job "+r.job+" which is not defined.");r.name=t,(a.type?jobTypes[a.type]:jobTypes.default).runner(a,r,t)}catch(e){Dpr.error("Job failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:""));t={errorCode:"DPR_EMSE_ERROR",errorMessage:e.message,errorStack:e.stack};Dpr.Actions.onException(t),Dpr.setLastError(e)}}function startJob(e,t){t.result=[]}function progressJob(e,t,r){r.result.push({project:t.capId.getCustomID()+"",date:t.data.date}),Dpr.log(t.capId.getCustomID()+"-"+t.data.date)}function progressJobArchive(e,t,r){r.result.push({id:t.file.id+"",project:t.file.project+"",name:t.file.name+"",type:t.file.type+"",createdDate:t.file.createdDate+""})}function endJob(e,t){var r="";if(e.parameters.resultRecipient){for(var a in o("Run name: "+e.name),o("**************"),o("Parameters:"),e.parameters)o(a+": "+e.parameters[a]);if(0<t.result.length){o("**************"),o("Notifications sent:");for(var n=0;n<t.result.length;n++)o(t.result[n].project+"-"+t.result[n].date)}o("**************"),o("Total notifications sent: "+t.result.length),o("**************"),o(aa.getServiceProviderCode()+": "+Dpr.getEnvironment()),aa.sendMail(Dpr.Actions.getConfig().notifications.default.from,e.parameters.resultRecipient,"",e.name+" run results",r)}else Dpr.error("Job run results not sent, resultRecipient is not set or unsupported");function o(e){r+=e+"</br>"}}function endJobArchive(e,t){var r="";if(e.parameters.resultRecipient){for(var a in o("Run name: "+e.name),o("**************"),o("Parameters:"),e.parameters)o(a+": "+e.parameters[a]);if(0<t.result.length){o("**************"),o("Files archived:");for(var n=0;n<t.result.length;n++)o(t.result[n].project),o(t.result[n].id),o(t.result[n].name),o(t.result[n].type),o(t.result[n].createdDate),o("**************")}o("**************"),o("Total files archived: "+t.result.length),o("**************"),o(aa.getServiceProviderCode()+": "+Dpr.getEnvironment()),aa.sendMail(Dpr.Actions.getConfig().notifications.default.from,e.parameters.resultRecipient,"",e.name+" run results",r)}else Dpr.error("Job run results not sent, resultRecipient is not set or unsupported");function o(e){r+=e+"</br>"}}function endJobAnsweredIssues(e,t){var r="";if(e.parameters.resultRecipient){for(var a in o("Run name: "+e.name),o("**************"),o("Parameters:"),e.parameters)o(a+": "+e.parameters[a]);if(0<t.result.length){o("**************"),o("Comments received:");for(var n=0;n<t.result.length;n++)o(t.result[n].project+"-"+t.result[n].date)}o("**************"),o("Total projects with answered issues: "+t.result.length),o("**************"),o(aa.getServiceProviderCode()+": "+Dpr.getEnvironment()),aa.sendMail(Dpr.Actions.getConfig().notifications.default.from,e.parameters.resultRecipient,"",e.name+" run results",r)}else Dpr.error("Job run results not sent, resultRecipient is not set or unsupported");function o(e){r+=e+"</br>"}}function loadNotificationRecords(e){var t=[],r=[];!function(e){if(!e.module)throw new Error("Run parameter module needs to be configured.");if(!e.taskNames)throw new Error("Run parameter taskNames needs to be configured.");if(!e.taskStatus)throw new Error("Run parameter taskStatus needs to be configured.");if(!e.intervals)throw new Error("Run parameter intervals needs to be configured.")}(e.parameters);for(var a=e.parameters.module,n=e.parameters.taskNames,o=e.parameters.taskStatus,s=function(e){for(var t,r,a=[],n=0;n<e.length;n++)a.push((t=new Date,r=-1*e[n],t.setDate(t.getDate()+r),t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear()));return a}(e.parameters.intervals),i=e.parameters.excludedAppStatuses||[],e=e.parameters.onlineOnly||!1,p=0;p<n.length;p++)r=r.concat(function(e){var t=[],r=aa.workflow.getTaskItemScriptModel().getOutput();r.setActiveFlag("Y"),r.setCompleteFlag("N"),r.setTaskDescription(e.taskName),r.setDisposition(e.taskStatus);var a=aa.workflow.getCapTypeScriptModel().getOutput();if(a.setGroup(e.module),a.setType(""),a.setSubType(""),a.setCategory(""),(a=aa.workflow.getCapIdsByCriteria(r,null,null,a,null)).getSuccess())for(var n=a.getOutput(),o=0;o<n.length;o++){var s=n[o],i=aa.cap.getCapID(s.getCapID().getID1(),s.getCapID().getID2(),s.getCapID().getID3()).getOutput();if(Dpr.isProject(i)&&Dpr.projectActive(Dpr.getAdminUser(),i)&&Dpr.isOpenSubmittals(Dpr.getAdminUser(),i)){s=Dpr.getTask(i,e.taskName);if(s&&s.getStatusDate())for(var p,c,u=new Date(s.getStatusDate().getMonth()+1+"/"+s.getStatusDate().getDate()+"/"+(s.getStatusDate().getYear()+1900)).getTime(),d=0;d<e.dates.length;d++)u===new Date(e.dates[d]).getTime()&&(c=(p=aa.cap.getCap(i).getOutput()).getCapType().toString()+"",t.push({capId:i,cap:p,capType:c,module:e.module,data:{date:e.dates[d]}}))}}else Dpr.error("Failed to get records by task details: "+a.getErrorMessage());return t}({module:a,taskName:n[p],taskStatus:o,dates:s}));return 0<r.length?t=t.concat(function(e,t){for(var r=[],a=0;a<e.length;a++){var n=e[a],o=n.cap;t.excludedAppStatuses&&Dpr.matches(o.getCapStatus()+"",t.excludedAppStatuses)||t.onlineOnly&&!o.isCreatedByACA()||r.push(n)}return r}(r,{excludedAppStatuses:i,onlineOnly:e})):Dpr.log("No candidtates returned for notification."),t}function sendReminderNotification(e,t,r){switch(r.parameters.email){case Dpr.Actions.SUBMIT_PLANS_REMINDER_NOTIFICATION:Dpr.Actions.sendSubmitPlansReminderNotification(e);break;case Dpr.Actions.SUBMIT_REVISED_PLANS_REMINDER_NOTIFICATION:Dpr.Actions.sendSubmitRevisedPlansReminderNotification(e);break;case Dpr.Actions.FILE_VALIDATION_ISSUES_REMINDER_NOTIFICATION:Dpr.Actions.sendFileValidationIssuesReminderNotification(e);break;default:Dpr.Actions.sendNotification(e,r.parameters.email)}}function evaluateArchiveCandidates(e,t){var r=[];for(var a,n,o,s,i,p,c=new Date(aa.util.parseDate((new Date).toISOString())),u=t.timeWithin||36e5,d=t.daysBehind||5,l=0;l<e.length;l++){var g,f=e[l];"error"!==f.status&&(g=new Date(aa.util.parseDate(f.createdDate)),i=g,p=u,new Date(c.getTime()-p)<=i||(a=c,n=g,o=d,s=void 0,(s=new Date).setDate(a.getDate()-o),s<=n&&n<=a&&r.push(f)))}return r}function loadFilesPendingArchive(e){var t=[],r=[];return t=0<(r=r.concat(Dpr.getFilesPendingArchive(Dpr.getAdminUser()))).length?t.concat(evaluateArchiveCandidates(r,{timeWithin:e.parameters.timeWithin||void 0,daysBehind:e.parameters.dayBehind||void 0})):t}function loadPrintSetsPendingArchive(e){var t=[],r=[];return t=0<(r=r.concat(Dpr.getPrintSetsPendingArchive(Dpr.getAdminUser()))).length?t.concat(evaluateArchiveCandidates(r,{timeWithin:e.parameters.timeWithin||void 0,daysBehind:e.parameters.dayBehind||void 0})):t}function archiveFile(e,t,r){Dpr.archiveFile(Dpr.getAdminUser(),e.file),java.lang.Thread.sleep(r.parameters.pause||1e4)}function archivePrintSet(e,t,r){Dpr.archivePrintSet(Dpr.getAdminUser(),e.file),java.lang.Thread.sleep(r.parameters.pause||1e4)}function loadNotApprovedNoOpenIssuesRecords(e){var t=[],r=[];function a(e,t){for(var r=[],a=0;a<e.length;a++){var n=e[a],o=n.capId,s=n.cap;if(!(t&&t.excludedAppStatuses&&Dpr.matches(s.getCapStatus()+"",t.excludedAppStatuses)))if(!t||!t.modules||Dpr.matches(n.module,t.modules))if(!(0<Dpr.getIssues(Dpr.getAdminUser(),o,["open"]).length)){var i=Dpr.getIssues(Dpr.getAdminUser(),o,["answered"]);if(0!==i.length){for(var p=[],c=0;c<i.length;c++){var u=i[c].lastUpdatedDate;u&&p.push(new Date(aa.util.parseDate(u).getTime()))}o=p?function(e){try{var t=new Date(Math.max.apply(null,e.map(function(e){return new Date(e)})));return t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear()}catch(e){aa.print("Get latestDate error message: "+e.message)}}(p):"";n.data={date:o?"Comments Received on "+o:"Comments Received no date available"},r.push(n)}}}return r}!function(e){if(!e.excludedAppStatuses)throw new Error("Run parameter excludedAppStatuses needs to be configured.")}(e.parameters);var n=e.parameters.excludedAppStatuses||[];return 0<(r=function(){var e=[],t=Dpr.getProjects(Dpr.getAdminUser(),["notapproved"]);if(0<t.length)for(var r=0;r<t.length;r++){var a,n=t[r].id.split("-"),o=aa.cap.getCapID(n[1],n[2],n[3]);o.getSuccess()?(a=o.getOutput(),o=(n=aa.cap.getCap(a).getOutput()).getCapModel().getModuleName()+"".toLowerCase(),e.push({capId:a,cap:n,module:o})):Dpr.log(t[r].number+": not found")}return e}()).length?t=t.concat(a(r,{excludedAppStatuses:n,modules:e.parameters.modules})):Dpr.log("No candidtates returned for notification."),t}Dpr.Batch.startJob=startJob,Dpr.Batch.loadNotificationRecords=loadNotificationRecords,Dpr.Batch.sendReminderNotification=sendReminderNotification,Dpr.Batch.loadFilesPendingArchive=loadFilesPendingArchive,Dpr.Batch.loadPrintSetsPendingArchive=loadPrintSetsPendingArchive,Dpr.Batch.loadNotApprovedNoOpenIssuesRecords=loadNotApprovedNoOpenIssuesRecords,Dpr.Batch.archiveFile=archiveFile,Dpr.Batch.archivePrintSet=archivePrintSet,Dpr.Batch.progressJob=progressJob,Dpr.Batch.progressJobArchive=progressJobArchive,Dpr.Batch.endJob=endJob,Dpr.Batch.endJobArchive=endJobArchive,Dpr.Batch.endJobAnsweredIssues=endJobAnsweredIssues,Dpr.Batch.runJob=runJob}(),Dpr.Batch.run=function(){var e=aa.env.getValue("runName")+"";e&&0!==e.length?Dpr.Batch.runJob(e):Dpr.error("No job run provided.")},aa.env.getValue("ScriptName")+""=="Test"||Dpr.Batch.run();