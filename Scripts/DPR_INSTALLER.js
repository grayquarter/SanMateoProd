var Dpr={Installer:{}};!function(){var t;Dpr.Installer.install=function(){function m(e){aa.env.setValue("InterfaceReturnCode","1"),aa.env.setValue("InterfaceReturnMessage",e)}function e(e,t){for(var r,a,i=new com.accela.aa.aamain.systemConfig.BizDomainBusiness,n=Date.now(),o=new java.util.Date(n),s=0;s<t.length;s++){var c=t[s],l=i.getRBizDomainByPk(aa.getServiceProviderCode(),c.name);l?c.description&&l.getDescription()+""!==c.description&&(l.setDescription(c.description),i.editRBizDomain(l)):((l=new com.accela.aa.aamain.systemConfig.RBizDomainModel).setBizDomain(c.name),l.setDescription(c.description),l.setServiceProviderCode(aa.getServiceProviderCode()),l.setAuditStatus("A"),l.setAuditDate(o),l.setAuditID("ADMIN"),i.createRBizDomain(l));for(var u=0;u<c.items.length;u++){var d=c.items[u];d.isActive=d.isActive||"A";var p=aa.bizDomain.getBizDomainByValue(c.name,d.key);if(p.getSuccess()){var g=p.getOutput();if(a=g,(r=d).value!==a.getDescription()+""||r.isActive!==a.getAuditStatus()+""){g=g.getBizDomain();if(g.setDescription(d.value),g.setAuditStatus(d.isActive),!(p=aa.bizDomain.editBizDomain(g)).getSuccess())return Dpr.error("Failed to edit std choice: "+c.name+". Error"+p.getErrorMessage()+". Will abort."),void m("Failed to edit std choice: "+c.name+". Error"+p.getErrorMessage()+". Will abort.")}}else{if(-1===p.getErrorMessage().indexOf("BizDomain don't exist"))return Dpr.error("Failed to create std choice: "+c.name+" "+d.key+". Will abort. Error"+p.getErrorMessage()),void m("Failed to create std choice: "+c.name+" "+d.key+". Will abort. Error"+p.getErrorMessage());if(p=c.name,d=d,!(d=aa.bizDomain.createBizDomain(p,d.key,d.isActive||"A",d.value)).getSuccess()&&(Dpr.error("Failed to create std choice: "+p+"-"+items[j].key+". Error"+d.getErrorMessage()+". Will abort."),!void m("Failed to create std choice: "+p+"-"+items[j].key+". Error"+d.getErrorMessage()+". Will abort.")))return}}}}function n(e){return javax.xml.bind.DatatypeConverter.parseBase64Binary(e)}function l(e){return javax.xml.bind.DatatypeConverter.printBase64Binary(e)}function o(e,t,r){function a(e){var t=l(e),e=t.indexOf("=");return t=(t=(t=-1<e?t.substring(0,e):t).replace("+","-")).replace("/","_")}var i=new java.lang.String('{"typ":"JWT", "alg":"HS256"}').getBytes("UTF-8"),n=t,t=Date.now(),r=new java.util.Date(t+60*r*1e3).getTime()/1e3;n.exp=r+"";r=new java.lang.String(JSON.stringify(n)).getBytes("UTF-8"),n=a(i),i=a(r),r=new java.lang.StringBuffer;r.append(n),r.append("."),r.append(i);var o,s,c,i=r.toString(),r=i.getBytes("UTF-8");return i+"."+a((o=e,s=r,c=javax.crypto.Mac.getInstance("HmacSHA256"),o=new javax.crypto.spec.SecretKeySpec(o,"HmacSHA256"),c.init(o),c.doFinal(s)))}function s(e,t,r){try{com.accela.util.AVProperties&&com.accela.util.AVProperties.getProperty("https.protocols")+""!="TLSv1.2"&&com.accela.util.AVProperties.setProperty("https.protocols","TLSv1.2");var a,i=r||"GET";(a=new java.net.URL(e+("GET"===i?"?tk="+t:"")).openConnection()).setRequestMethod(i),a.setRequestProperty("Accept-Charset","UTF-8"),a.setRequestProperty("Content-Type","application/json"),"GET"===i||a.setRequestProperty("Authorization","Bearer "+t),a.setUseCaches(!1),a.setDoOutput(!0),"GET"!==i&&a.getOutputStream().close();var n=a.getResponseCode(),o=a.getResponseMessage()+"";Dpr.log(i+" "+e+", Status code: "+n);var s,c={code:n,message:o};if(200<=n&&n<300)try{if(s=a.getInputStream()){var l=new java.lang.StringBuffer;try{for(var u,d=aa.io&&aa.io.BufferedReader&&aa.io.InputStreamReader?aa.io.BufferedReader(aa.io.InputStreamReader(s,"UTF-8")):new java.io.BufferedReader(new java.io.InputStreamReader(s));null!==(u=d.readLine());)l.append(u);var p=0<l.length()?l.toString():null;c.body=p+""}finally{if(d)try{d.close()}catch(e){Dpr.log("Error closing http connection buffer.")}}}}finally{if(s)try{s.close()}catch(e){Dpr.log("Error closing http connection stream.")}}return c}finally{a&&a.disconnect()}}function r(e,t){var r={iss:"accela",sub:e.adminUser,role:"admin",fn:"Installer",ln:"Installer"};return o(n(e.key),r,t||20)}function t(e){var t=e.endpoint+"/ab/planroom/settings",e=r(e),e=s(t,e,"POST");if(200!==e.code)throw new Error("Failed to import new config. Error: "+e.code+", Message: "+e.message)}function c(e,t,r,a,i){r=(i||"https://cdn.epermithub.com")+"/packages/"+r+"/accela/"+e+".js",t=s(r,t);if(200!==t.code)throw new Error("Failed to download (code "+t.code+") script: "+r);!function(e,t,r){var a=new com.accela.aa.emse.emse.EMSEBusiness,i=aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.ScriptDAOMSSQL").getOutput(),n=new Date,o=aa.proxyInvoker.newInstance("com.accela.aa.emse.emse.ScriptModel").getOutput(),s=!1;try{s=!a.getScriptByPK(aa.getServiceProviderCode(),e,r)}catch(e){Dpr.log("Error finding script: "+e),s=!0}o.setDescription(null),o.setServiceProviderCode(aa.getServiceProviderCode()),o.setScriptName(e),o.setScriptText(t),o.setSripteCode(e),o.setAuditID(r),o.setAuditDate(n),o.setAuditStatus("A"),s?(Dpr.log("Creating script: "+e),i.createScript(o)):(Dpr.log("Updating script: "+e),i.editScript(o))}(e,t.body,a)}function a(e,t,r){if(!e.key)throw new Error("API key is required in DPR_CONFIGS");if(!e.clientId)throw new Error("Client Id is required in DPR_CONFIGS");if(!e.adminUser)throw new Error("DPR_USER is required in DPR_CONFIGS");var a,i,i=(i={iss:"ephb",sub:(a=e).clientId},i=o(n(a.key),i,20),l(new java.lang.String(a.clientId+":"+i).getBytes("UTF-8")));c("INCLUDES_DPR_LIBRARY",i,t,e.adminUser,r),c("INCLUDES_DPR_BOOT",i,t,e.adminUser,r),c("API_DPR_ACA_AUTHORIZATION",i,t,e.adminUser,r),c("API_DPR_EXPRESSIONS",i,t,e.adminUser,r),c("API_DPR_RECORD_PROCESS",i,t,e.adminUser,r),c("API_DPR_SEND_NOTIFICATION",i,t,e.adminUser,r),c("BATCH_DPR_RUNNER",i,t,e.adminUser,r),c("DPR_UNIVERSAL_EVENT",i,t,e.adminUser,r),c("HIDE_PAGE_IF_DPR_RECORD",i,t,e.adminUser,r),c("HIDE_PAGE_IF_NOT_DPR_RECORD",i,t,e.adminUser,r),(new com.accela.aa.emse.emse.EMSEBusiness).cleanScriptCache()}try{var i=aa.env.getValue("config")+"";if(!i||0===i.length)return Dpr.error("Bad request, missing config"),void m("Bad request, missing config");var u,d,p=JSON.parse(i);p&&(u=function(){var e={},t=aa.bizDomain.getBizDomain("DPR_CONFIGS");if(t.getSuccess())for(var r=t.getOutput(),a=0;a<r.size();a++){var i=r.get(a);if(i.getAuditStatus().equals("A")){var n=i.getBizdomainValue()+"",o=(o=i.getDescription()+"").trim();switch(n.toUpperCase()){case"APIKEY":e.key=o;break;case"ENDPOINT":e.endpoint="/"===o[o.length]?o.substring(0,o.length-1):o;break;case"CLIENTID":e.clientId=o;break;case"DPR_USER_ID":e.adminUser=o;break;case"ENVIRONMENT":e.environment=o;break;case"INSTALLER_TIMEOUT":e.installTimeout=parseInt(o)}}}return e}(),p.version&&(Dpr.log("Starting install of version: "+p.version),a(u,p.version,p.host),Dpr.log("Sucessfully installed version: "+p.version)),p.choices&&(Dpr.log("Starting import of configuration."),e(0,p.choices),Dpr.log("Sucessfully imported configuration.")),p.commit&&(Dpr.log("Starting import of configuration."),t(u),Dpr.log("Sucessfully imported configuration.")),p.auth&&(Dpr.log("Generating token."),aa.env.setValue("InterfaceReturnCode","0"),aa.env.setValue("InterfaceReturnMessage","Success"),d=r(u,u.installTimeout||60),aa.env.setValue("Data",JSON.stringify({host:u.endpoint,token:d}))))}catch(e){Dpr.error("API failed with exception: "+e.message+(e.stack?"\nStack: "+e.stack:"")),m(e.message)}},Dpr.clearLastError=function(){t=void 0},Dpr.setLastError=function(e){t=e},Dpr.getLastError=function(){return t},Dpr.log=function(e){aa.print(e)},Dpr.error=function(e){aa.print(e)}}();